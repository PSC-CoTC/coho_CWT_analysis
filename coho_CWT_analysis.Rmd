---
title: "Coho CWT FRAM & MSM Analysis"
author: "Dan.Auerbach@dfw.wa.gov, Angelika.Hagen-Breaux@dfw.wa.gov, carrie_cook-tabor@fws.gov"
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  bookdown::html_document2:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
---

```{r setup, results = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9)

library("tidyverse")
library("gt")
library("odbc"); library("DBI")
#library("ggridges")

dir_proj <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis"

fp <- list(
  rmis_recs = file.path(dir_proj, "rmis_coho_recoveries_86_2020.rds"),
  rmis_rel = file.path(dir_proj, "rmis_coho_releases_for_rec_86_2020.rds"),
  rmis_rec_rel = file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds")
  )

rmis_rr <- readRDS(fp$rmis_rec_rel) |> 
  filter(!is.na(release_location_state)) |>  #drop 3 recent
  mutate(age = run_year - brood_year)

regions <- list(
  col_riv = c("CECR", "CRGN", "LOCR", "UPCR"),
  ps = c("SPS", "MPS", "NPS", "HOOD", "JUAN", "SKAG", "NOWA"),
  wa_cst = c("NWC", "GRAY", "WAGN", "WILP")
)

rgns <- map_df(regions, ~paste0(.x, collapse =",")) |> 
  pivot_longer(names_to = "rgn", values_to = "release_location_rmis_region", everything()) |> 
  separate_rows(release_location_rmis_region)



lu <- list(
  #CCT queried releases, QAQC'd and assigned to PR and PR_MU
  cwt_stk = read_csv(file.path(dir_proj, "MSMDB/MSM_Stock_CWT2.csv")) |> 
    mutate(run_year = Run_ID+1985) |> 
    select(run_year, tag_code = CWT_Code, area = Area_Agg,
           pr = PR_Number, pr_mu = PR_MU_Number, n_rel = Number_Released, everything()) |> 
    filter(!is.na(pr), !is.na(pr_mu), pr_mu > 0) |> 
    #exclude a double-mapped row
    filter(!(run_year == 1996 & tag_code == "071544" & FRAMStkID == 166))
  ,
  #DA incomplete rel state/region/basin to pr/pr_mu/StockID
  rmis_rgn_stkid = readxl::read_excel(file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx"))
)

# #key dbs
# "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MSM_86-91_Oct2006.mdb"
# "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MSM_98-2020- SF2019.mdb"


```

# Summary

This script analyzes coho coded wire tag (CWT) recoveries (and associated releases) reported in RMIS.

# Data

## RMIS LUs

```{r rmis_lu_downloads, eval=FALSE}
# walk(
#   c("https://www.rmpc.org/data/fishery.csv", "https://www.rmpc.org/data/gear.csv"), #others for various fields... 
# ~.x |> download.file(destfile = paste0("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_", basename(.x)))
# )

#DA added into "rmis_loc_fram_fishery.xlsx"

## All release locations, could be used to supplement CCT cwt_stk...
# download.file(
#   "https://www.rmpc.org/data/RL041_ALL_FULLSET.csv",
#   "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_rel_loc_all.csv"
#   )

read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_rel_loc_all.csv")

```

## RMIS wrangling

These chunks preserve one-time operations to generate starting datasets from RMIS.

```{r read_in_rmis_recoveries, eval=FALSE}
dir_rmis_recs <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/RMISRecoveries/"

focal_cols_recs <- c("recovery_id", "tag_code", "run_year", "recovery_location_code", "recovery_location_name", "fishery", "gear", "estimated_number")

# rmis_recs <- purrr::map_dfr(
#   list.files(dir_rmis_recs, full.names = T)
#   ,
#   ~readr::read_csv(.x, col_select = all_of(focal_cols_recs))
#   )
# 
# saveRDS(rmis_recs, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_recoveries_86_2020.rds")

```

```{r get_releases_by_tag_code, eval=FALSE}
rmis_recs |> 
  mutate(year_set = if_else(run_year <= 1992, "86-92", "93-20")) |> 
  #distinct(year_set, tag_code) |> split(~year_set) |> 
  distinct(tag_code) |> rownames_to_column(var = "id") |> 
  mutate(
    id = as.numeric(id), 
    block = cut(id, breaks = c(seq(0,20000,by=2000))),
    block = letters[as.integer(block)]
    ) |> #count(block)
  split(~block) |> 
  writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx")

f <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx"

#readxl::read_excel(f, sheet = "a") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "b") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "c") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "d") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "e") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "f") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "g") |> pluck("tag_code") |> writeLines("clipboard")

focal_cols_rel <- c("tag_code_or_release_id", "brood_year", "release_location_code", "hatchery_location_code", "stock_location_code", "release_location_name", "hatchery_location_name", "stock_location_name", "release_location_state", "release_location_rmis_region", "release_location_rmis_basin", "cwt_1st_mark", "cwt_1st_mark_count", "cwt_2nd_mark", "cwt_2nd_mark_count")

rmis_rel <- map_df(
  c(
  "https://www.rmis.org/reports/CSV13497.txt",
  "https://www.rmis.org/reports/CSV13656.txt",
  "https://www.rmis.org/reports/CSV13738.txt",
  "https://www.rmis.org/reports/CSV13814.txt",
  "https://www.rmis.org/reports/CSV13854.txt",
  "https://www.rmis.org/reports/CSV14030.txt",
  "https://www.rmis.org/reports/CSV14116.txt"
  ),
  ~read_csv(.x, col_select = all_of(focal_cols_rel)) |> 
    mutate(
      cwt_1st_mark = as.character(cwt_1st_mark),
      cwt_2nd_mark = as.character(cwt_2nd_mark)
      )
  )

#saveRDS(rmis_rel, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_releases_for_rec_86_2020.rds")

```

```{r build_rec_rel, eval=FALSE}

left_join(
  readRDS(fp$rmis_recs) |> 
    mutate(
      rlsp = str_sub(recovery_location_code, 1, 1),
      rlwtr = str_sub(recovery_location_code, 2, 2),
      rlsctr = str_sub(recovery_location_code, 3, 3),
      rlrgn = str_sub(recovery_location_code, 4, 5),
      rlarea = str_sub(recovery_location_code, 6, 9),
      rllocn = str_sub(recovery_location_code, 10, 16),
      rlsubl = str_sub(recovery_location_code, 17, 19),
      f_type = case_when(
        between(fishery, 10, 19) ~ "troll",
        between(fishery, 20, 39) ~ "net",
        between(fishery, 40, 49) ~ "sport",
        between(fishery, 50, 59) ~ "escp"
      )
    )
  ,
  readRDS(fp$rmis_rel) |> select(-contains("n_code")),
  by = c("tag_code" = "tag_code_or_release_id")
  ) ##|> saveRDS(file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"))

```

# Stock mapping

Exporting a format for the needed lookup from RMIS release location fields (state, region, basin) and the MSM/FRAM production region and management units (PR and PR_MU), and thence to FRAM StockID(s). Some of this is already available in, for example, the escapement compilation template sheet?

The LU begun in from this first chunk was initiated but then paused due to existing CCT work in `lu$cwt_stk`

```{r lu_rmis_rel_to_pr_prmu_xlsx, eval=FALSE}

# rmis_rr |> 
#   distinct(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
#   arrange(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
#   mutate(pr = NA, pr_mu = NA, StockID = NA) |> 
##Manually modified, do not overwrite:  #writexl::write_xlsx(file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx"))


# #unused below...but considered in beginning of file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx")
# readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Escapement files/Coho/fram_coho_escapement_2022.xlsx", sheet = "year_template") |> 
#   select(
#     MSM_PR = ProductionRegionNumber, 
#     MSM_PR_MU = ManagementUnitNumber,
#     RRTerm_PR, RRTerm_PR_MU, 
#     StockID, 
#     StockLongName, 
#     StockName
#     )

```

Examining `rmis_rr` against `lu$cwt_stk` mapping

```{r rmis_rr_cwt_stk, eval=FALSE}

#basically mapped for 1998 forward, presumably due to expectation that older are already mapped elsewhere in MSM?
lu$cwt_stk |> count(run_year) |> print(n=100)

distinct(rmis_rr, tag_code) #12936 releases
distinct(lu$cwt_stk, tag_code) #5491 mapped

length(setdiff(rmis_rr$tag_code, lu$cwt_stk$tag_code)) #7642 codes not mapped to PR...
length(setdiff(lu$cwt_stk$tag_code, rmis_rr$tag_code)) #oddballs, most of the mapped are in recs
#for example...
filter(lu$cwt_stk, tag_code == "180691*1")
#confirming that many 6-character, leading 0 codes are in recs...
rmis_rr |> filter(nchar(tag_code) <= 6, str_sub(tag_code, 1,1) == "0")
#but 5294 shared/mapped codes (recall dup run_year)
length(intersect(rmis_rr$tag_code, lu$cwt_stk$tag_code)) 

nrow(distinct(lu$cwt_stk, run_year, tag_code)) == nrow(lu$cwt_stk)
count(lu$cwt_stk, run_year, tag_code) |> filter(n>1)
# filter(lu$cwt_stk, run_year == 1996, tag_code == "071544")
# filter(lu$cwt_stk, Stock_Name == "TANNER CR (BNVILLE)") #released in multiple pr_mus
# filter(lu$cwt_stk, Release_Name == "YOUNGS R & BAY") #looks like it should be pr_mu==2


#rmis_rr |> left_join(lu$cwt_stk, by = c("run_year", "tag_code")) |> count(is.na(pr))

rmis_rr_cwt_stk <- inner_join(rmis_rr, lu$cwt_stk, by = c("run_year", "tag_code"))

rmis_rr_cwt_stk |> 
  #group_by(run_year, area) |> summarise()
  #count(run_year, area) |> ggplot(aes(run_year, n)) + geom_col() + facet_wrap(~area)
  count(run_year, pr) |> #pivot_wider(names_from = run_year, values_from = n) |> arrange(pr)
  ggplot(aes(run_year, n)) + geom_col() + facet_wrap(~pr)


```

Question 5/31/22 - which programs have had the most stable/consistent releases?

```{r big_beef_example}
rmis_rr |> count(hatchery_location_name, stock_location_name)

#rmis_rel <- readRDS(fp$rmis_rel)

rmis_rr |> 
  filter(f_type != "escp") |> 
  group_by(stock_location_name, brood_year) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  ggplot(aes(factor(brood_year), stock_location_name, fill = cwt_1st_mark_count, color = cwt_1st_mark_count)) + geom_tile()

#rmis_rr |> filter(f_type != "escp") |> pluck("brood_year") |> range() #1980:2018

#programs with most years of fishery-recovered releases
rmis_rr |> filter(f_type != "escp") |> 
  distinct(stock_location_name, brood_year) |>
  count(stock_location_name) |> 
  filter(n > 34) |> 
  arrange(desc(n))

#explore with "BIG BEEF CR"
## non-escapement recoveries & mark-counts by brood year
## post-2004 see a clear drop in typical cwt_1st_mark_count without a big drop in n_recs
## could be various factors, but perhaps interesting and definitely inflects other ideas
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  group_by(stock_location_name, brood_year) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  pivot_longer(cols = c(n_recs, cwt_1st_mark_count), names_to = "var", values_to = "val") |> 
  ggplot(aes(factor(brood_year), val)) + geom_col() + facet_wrap(~var, ncol = 1, scales = "free")

## non-escapement recoveries by run_year and fishery
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  group_by(stock_location_name, run_year, f_type) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  pivot_longer(cols = c(n_recs, cwt_1st_mark_count), names_to = "var", values_to = "val") |> 
  ggplot(aes(factor(run_year), val, fill = f_type)) + geom_col() + facet_wrap(~var, ncol = 1, scales = "free")

## same as above, starting to focus on fishery changes 
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  group_by(stock_location_name, run_year, f_type) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  pivot_longer(cols = c(n_recs, cwt_1st_mark_count), names_to = "var", values_to = "val") |> 
  filter(var == "n_recs") |> 
  ggplot(aes(factor(run_year), val, fill = f_type)) + geom_col() + facet_wrap(~f_type, ncol = 1)

## CCT FRAM stock mapping appears unhelpful?
## is it simply not used? or is the mapping off?
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  left_join(lu$cwt_stk, by = c("run_year", "tag_code")) |> 
## 761 recs for 1998-2000 mapped to StockID 46 "Area 12/12B Wild Marked"
  #count(FRAMStkID)
  filter(!is.na(FRAMStkID)) |> count(run_year) |> print(n=50) 

## looking ahead to fishery mapping work below...
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  count(stock_location_name, run_year, rlsp, rlwtr, rlsctr, f_type) |> 
  filter(rlsp == "3", rlsctr == "1") |> 
  unite(col = "rlft", c(rlsp, rlwtr, rlsctr, f_type)) |> 
  mutate(run_year = factor(run_year)) |> 
  #ggplot(aes(run_year, rlft, fill=n)) + geom_tile() 
  
  ggplot(aes(run_year, n, fill=rlft)) + geom_col(position = "dodge") 



```


# Fishery mapping

## misc initial

```{r pull_msm_edit_distinct, eval=FALSE}
#86-91, 92-97, 98-2020

db <- "C:/Users/auerbdaa/Downloads/MSM_98-2020- SF2019_cmpct.mdb"
#db <- fp$db_msm
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=", db, ";")
  )

msm_tbl_names <- c("Edit_Distinct")

msm_tbl <- map(set_names(msm_tbl_names), ~collect(tbl(db_con, .x)))

DBI::dbDisconnect(db_con)

msm_tbl$Edit_Distinct

```

```{r FishAggMap, eval=FALSE}
#AHB very coarse mapping  
read_csv(file.path(dir_proj, "MSMDB/FishAggMap.csv"))
```

```{r now_deprecated_fram_fishery_rmis_loc, eval=FALSE}
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0(
    "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=",
    "O:/code/coho/fram_mdbs/PSC_CoTC_PostSeason_CohoFRAMDB_thru2020_021622.mdb",
    ";")
  )

fram_fishery <- tbl(db_con, "Fishery") |> 
  filter(Species == "COHO") |> 
  select(FisheryID:FisheryTitle) |> 
  collect()

DBI::dbDisconnect(db_con)

##Manually edited, no overwrite! writexl::write_xlsx(fram_fishery, "NOOVERWRITEfram_fishery_rmis_loc.xlsx")
#this file/approach superseded by below "rmis_loc_fram_fishery.xlsx"
```

```{r rec_location_code_init_EDA, eval=FALSE}
rmis_rr |> 
  filter(
    str_sub(recovery_location_code,1,3) == "6MO"
  ) |> 
  count(recovery_location_code) |> arrange(desc(n))

#38 distinct, vast majority in first 22
rmis_rr |> count(str_sub(recovery_location_code,1,3)) |> arrange(desc(n)) |> print(n=100)

#4989 distinct but only first ~2K matter
rmis_rr |> count(recovery_location_code) |> arrange(desc(n)) |> 
  rowid_to_column() |> ggplot(aes(rowid, n)) + geom_col()

#excluding escapement about ~4K, 
#with ~2K having more than 5 recs 
#and ~2.7K more than 5 incl escp
rmis_rr |> 
  filter(fishery < 50) |>
  count(recovery_location_code) |> arrange(desc(n)) |> 
  filter(n > 5) |> 
  rowid_to_column() |> ggplot(aes(rowid, n)) + geom_col()
```

```{r write_starting_rmis_loc_fram_fishery, eval=FALSE}
# rmis_rr |> 
#   count(
#     loc3 = str_sub(recovery_location_code,1,3),
#     recovery_location_code,
#     recovery_location_name,
#     fishery, gear
#     ) |> 
#   arrange(desc(n)) 
# ## DA began mapping to FRAM FisheryID
# ##  writexl::write_xlsx("NOOVERWRITErmis_loc_fram_fishery")

# ##another older version: write_csv("rmis_rec_loc_fishery_gear_init.csv", na = "")
# read_csv("rmis_rec_loc_fishery_gear_init.csv")
# filter(rmis_rr, recovery_location_code == "1M1") |> select(1:8)

## DA began to build from PSC_V41_Specification.pdf, pg 49-60 
## realized this must exist already, searched, DL'd and added into workbook
# readxl::read_excel("rmis_loc_fram_fishery.xlsx", sheet = "rmis_lu_gear")
```

## rmis_rr_lu

Attempt to build lookup from RMIS recovery location codes to FRAM FisheryIDs

This first chunk distinguishes the unique *recovery_location_codes* and builds new fields by character position, following the RMIS schema (PSC_V41_Specification_Nov2021.pdf).

In addition, the RMIS "gear" lookup is joined, providing *gear_name* strings. 

```{r build_starting_lu_rmis_loc_fram_fishery, eval=FALSE}
rmis_rr_lu <- rmis_rr |> 
  count(
    recovery_location_code, recovery_location_name,
    rlsp, rlwtr, rlsctr, rlrgn, #chars 1,2,3,4:5
    rlarea, rllocn, rlsubl, #chars 6:9,10:16,17:19 
    fishery, gear, f_type) |> 
  arrange(rlsp, desc(n)) |> 
  mutate(
    rlsp_desc = set_names(c("AK", "BC", "WA", "ID", "OR", "CA", "HS", "FR"),1:8)[rlsp],
    rlwtr_desc = set_names(c("Marine", "Freshw"), c("M", "F"))[rlwtr],
    rlsctr_desc = case_when(
      rlsp == "1" & rlsctr == "1" ~ "Southeast AK",
      rlsp == "1" & rlsctr == "2" ~ "Southcentral AK",
      rlsp == "1" & rlsctr == "3" ~ "Arctic-Yukon",
      rlsp == "1" & rlsctr == "4" ~ "Westward AK",
      rlsp == "2" & rlsctr == "N" ~ "N of Cape Caution",
      rlsp == "2" & rlsctr == "S" ~ "S of Cape Caution",
      rlsp == "3" & rlsctr == "1" ~ "Puget Sound",
      rlsp == "3" & rlsctr == "2" ~ "Coastal",
      rlsp == "3" & rlsctr == "3" ~ "Ocean",
      rlsp == "3" & rlsctr == "4" ~ "Columbia",
      rlsp == "5" & rlsctr == "2" ~ "Coastal",
      rlsp == "5" & rlsctr == "3" ~ "Columbia",
      rlsp == "6" & rlsctr == "K" ~ "Klamath-Trinity",
      rlsp == "6" & rlsctr == "C" ~ "Central Valley",
      rlsp == "6" & rlsctr == "A" ~ "North Coastal",
      rlsp == "6" & rlsctr == "B" ~ "Central Coastal",
      rlsp == "6" & rlsctr == "D" ~ "Sout Coastal",
      rlsp == "6" & rlsctr == "O" ~ "Ocean",
      rlsp == "6" & rlsctr == "M" ~ "Mountain"
    )
    ,
    rlrgn_desc = case_when(
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "01" ~ "NW Van Isl troll",
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "02" ~ "SW Van Isl troll",      
      
      rlsp == "3" & rlrgn == "01" ~ "Nooksack/Sam term comm",
      rlsp == "3" & rlrgn == "02" ~ "Skagit term comm",
      rlsp == "3" & rlrgn == "03" ~ "Stilly/Sno term comm",
      rlsp == "3" & rlrgn == "04" ~ "Hood Canal term comm",
      rlsp == "3" & rlrgn == "05" ~ "S Puget Sound term comm",
      rlsp == "3" & rlrgn == "06" ~ "Domestic mixed comm",
      rlsp == "3" & rlrgn == "07" ~ "Internat mixed comm",
      rlsp == "3" & rlrgn == "08" ~ "Strait JDF term comm",
      rlsp == "3" & rlrgn == "11" ~ "Internat mixed spt 5/6/7",
      rlsp == "3" & rlrgn == "12" ~ "Skagit/Stilly/Sno term spt 8",
      rlsp == "3" & rlrgn == "13" ~ "Domestic mixed spt 9",
      rlsp == "3" & rlrgn == "14" ~ "S Puget Sound spt 10/11//13",
      rlsp == "3" & rlrgn == "15" ~ "Hood Canal spt 12",
      rlsp == "3" & rlrgn == "17" ~ "N Coast streams",
      rlsp == "3" & rlrgn == "18" ~ "Grays Hbr & tribs",
      rlsp == "3" & rlrgn == "19" ~ "Willapa Hbr & tribs",
      rlsp == "3" & rlrgn == "20" ~ "Columbia",
      rlsp == "3" & rlrgn == "21" ~ "MA1",
      rlsp == "3" & rlrgn == "22" ~ "MA2",
      rlsp == "3" & rlrgn == "23" ~ "MA3",
      rlsp == "3" & rlrgn == "24" ~ "MA4",
      rlsp == "3" & rlrgn == "25" ~ "MA5 troll only",
      rlsp == "3" & rlrgn == "26" ~ "MA6 troll only",

      rlsp == "5" & rlrgn == "21" ~ "Coast private",
      rlsp == "5" & rlrgn == "22" ~ "Coast public",
      rlsp == "5" & rlrgn == "31" ~ "WA below Bonn",
      rlsp == "5" & rlrgn == "32" ~ "OR below Bonn",
      rlsp == "5" & rlrgn == "33" ~ "Willamette",
      rlsp == "5" & rlrgn == "34" ~ "Bonn to McNary",
      rlsp == "5" & rlrgn == "35" ~ "Snake",
      
      rlsp == "6" & rlrgn == "FB" ~ "Fort Bragg", #appears unused in these codes
      rlrgn == "" ~ ""
    ),
    # rlarea_desc = "",
    # rllocn_desc = "",
    # rlsubl_desc = ""
  ) |> 
  left_join(
    #the gear_name is non-distinct across agencies for some fishery-gear combos
    #but duplication and differences in appear non-significant
    #so preserving first version as distinct()
    read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_gear.csv") |> 
      #mutate(f_g = paste0(fishery,"_", gear)) |> count(f_g) |> arrange(desc(n)) |> filter(n > 1) |> print(n=100)
      distinct(fishery, gear, .keep_all = T)
    ,
    by = c("fishery", "gear")
  )
```

The (incomplete) chunks below begin FisheryID assignment by state/region.

```{r rmis_rr_lu_CA, eval=FALSE}
#possible CA codes to assign...
#https://wildlife.ca.gov/Fishing/Ocean/Regulations/Salmon
#from N to S: KMZ-->Ft.Bragg-->San Fran-->Montery&South
select(rmis_rr, 1:16) |> filter(rlsp=="6") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn) |> print(n=100)

rmis_rr_lu |> 
  mutate(
    FisheryID = case_when(
      #str_detect(rllocn, c("")) & f_type == "sport" ~ 3, #Ft Brg Spt
      #str_detect(rllocn, c("")) & f_type == "troll" ~ 4, #Ft Brg Trl
      str_detect(rllocn, c("BGCB|OBBG|OBCB|OBFK")) & f_type == "sport" ~ 5, #Ca KMZ Spt, northernmost
      str_detect(rllocn, c("BGCB|OBBG|OBCB|OBFK")) & f_type == "troll" ~ 6, #Ca KMZ Trl, northernmost
      str_detect(rllocn, c("FRPP|FRPS|NHPS|PPPS|PSMB")) & f_type == "sport" ~ 7, #So Cal Spt
      str_detect(rllocn, c("FRPP|FRPS|NHPS|PPPS|PSMB")) & f_type == "troll" ~ 8 #So Cal Trl

    ),
    comment = "")
```

```{r rmis_rr_lu_OR, eval=FALSE}
#possible OR to assign
#large majority are escapement
#unclear how FRAM ColR fisheries combine/split OR/WA 
select(rmis_rr, 1:16) |> filter(rlsp=="5") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)

```

```{r rmis_rr_lu_WA, eval=FALSE}
#possible WA to assign
select(rmis_rr, 1:16) |> filter(rlsp=="3") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)
#excluding escp/hatcheries
select(rmis_rr, 1:16) |> filter(rlsp=="3", f_type != "escp") |> 
  count(recovery_location_code, recovery_location_name, rlsp, rlwtr, rlsctr, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)

rmis_rr_lu |> filter(rlsp=="3" & rlwtr=="M" & rlsctr=="2") |> count(rlrgn)
rmis_rr_lu |> filter(rlsp=="3" & rlwtr=="F" & rlsctr=="2" & rlrgn == "19") 

rmis_rr_lu |> 
  mutate(
    FisheryID = case_when(
# 30	LCRWaT Spt	Col. Rvr. Wash Trib Spt
# 31	UpColR Spt	Col. Rvr. Sport Above Bonneville
# 32	UpColR Net	Col. Rvr. Net Above Bonneville
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="21" & fishery %in% 40:49 ~ 33, #A1-Ast Spt	WA Area 1 & Astoria Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="21" & fishery %in% 10:19 ~ 34, #A1-Ast Trl	WA Area 1 & Astoria Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="22" & fishery==10 & gear==41 ~ 35, #Area2Trl NT	WA Area 2 Non-Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="22" & fishery==15 & gear==40 ~ 36, #Area2TrlTR	WA Area 2 Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="22" & fishery %in% 40:49 ~ 37, #Area 2 Spt	WA Area 2 Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="23" & fishery==10 & gear==41 ~ 38, #WA Area 3 Non-Treaty troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="23" & fishery==15 & gear==40 ~ 39, #WA Area 3 Treaty troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="23" & fishery %in% 40:49 ~ 40, #WA Area 3 Sport

      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="24" & str_sub(rlarea,1,2)=="04" & fishery %in% 40:49 ~ 41,	#Area 4 Spt	WA Area 4 Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="24" & rlarea=="04" & fishery==10 & gear==41 ~ 42,	#A4/4BTrlNT	WA Area 4/4B Non-Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="24" & rlarea=="04" & fishery==15 & gear==40 ~ 43	#A4/4BTrlTR	WA Area 4/4B Treaty Troll

# 44	A 5-6C Trl	WA Area 5-6-6C Troll

      rlsp=="3" & rlwtr=="M" & rlsctr=="2" & rlrgn=="19" & fishery %in% 40:49 ~ 45, #Willpa Spt	Willapa Bay Sport (2.1)
      rlsp=="3" & rlwtr=="F" & rlsctr=="2" & rlrgn=="19" & fishery %in% 40:49 ~ 46	#Wlp Tb Spt	Willapa Tributary Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="2" & rlrgn=="19" & fishery %in% 20:29 ~ 47, #WlpaBT Net	Willapa Bay & FW Trib Net; all 22-14, Non-treaty Drift Gillnet

# 48	GryHbr Spt	Grays Harbor Sport (2.2)
# 49	SGryHb Spt	South Grays Harbor Sport
# 50	GryHbr Net	Grays Harbor Estuary Net
# 51	Hump R Spt	Humptulips R Sport
# 52	LwCheh Net	Lower Chehalis R Net
# 53	Hump R C&S	Humptulips R C&S
# 54	Chehal Spt	Chehalis R Sport
# 55	Hump R Net	Humptulips R Net
# 56	UpCheh Net	Upper Chehalis R Net
# 57	Chehal C&S	Chehalis R C&S
# 58	Wynoch Spt	Wynochee R Sport
# 59	Hoquam Spt	Hoquiam R Sport
# 60	Wishkh Spt	Wishkah R Sport
# 61	Satsop Spt	Satsop R Sport
# 62	Quin R Spt	Quinault R Sport
# 63	Quin R Net	Quinault R Net
# 64	Quin R C&S	Quinault R C&S
# 65	Queets Spt	Queets R Sport
# 66	Clrwtr Spt	Clearwater R Sport
# 67	Salm R Spt	Salmon R Sport (Queets)
# 68	Queets Net	Queets R Net
# 69	Queets C&S	Queets R C&S
# 70	Quilly Spt	Quillayute R Sport
# 71	Quilly Net	Quillayute R Net
# 72	Quilly C&S	Quillayute R C&S
# 73	Hoh R  Spt	Hoh R Sport
# 74	Hoh R  Net	Hoh R Net
# 75	Hoh R  C&S	Hoh R C&S
# 76	Mak FW Spt	Makah Tributary Sport
# 77	Mak FW Net	Makah Freshwater Net
# 78	Makah  C&S	Makah C&S
# 79	A 4-4A Net	WA Area 4-4A Net
# 80	A4B6CNetNT	WA Area 4B-5-6C Non-Treaty Net
# 81	A4B6CNetTR	WA Area 4B-5-6C Treaty Net
# 82	Ar6D NetNT	6D Non-Treaty Net (Dungeness Bay & R)
# 83	Ar6D NetTR	6D Treaty Net (Dungeness Bay & R)
# 84	Elwha  Net	Elwha R Net
# 85	WJDF T Net	West JDF Straits Trib Net
# 86	EJDF T Net	East JDF Straits Trib Net
# 87	A6-7ANetNT	WA Area 7-7A Non-Treaty Net
# 88	A6-7ANetTR	WA Area 7-7A Treaty Net
# 89	EJDF FWSpt	East JDF Straits Trib Sport
# 90	WJDF FWSpt	West JDF Straits Trib Sport
# 91	Area 5 Spt	WA Area 5 Sport (Sekiu)
# 92	Area 6 Spt	WA Area 6 Sport (Port Angeles)
# 93	Area 7 Spt	WA Area 7 Sport (San Juan Islands)
# 94	Dung R Spt	Dungeness R Sport
# 95	ElwhaR Spt	Elwha R Sport
# 96	A7BCDNetNT	WA Area 7B-7C-7D Non-Treaty Net
# 97	A7BCDNetTR	WA Area 7B-7C-7D Treaty Net
# 98	Nook R Net	Nooksack R Net
# 99	Nook R Spt	Nooksack R Sport
# 100	Samh R Spt	Samish R Sport
# 101	Ar 8 NetNT	WA Area 8 Non-Treaty Net (Skagit)
# 102	Ar 8 NetTR	WA Area 8 Treaty Net (Skagit)
# 103	Skag R Net	Skagit R Net
# 104	SkgR TsNet	Skagit River Test Net
# 105	SwinCh Net	Swinomish Channel Net
# 106	Ar 8-1 Spt	WA Area 8.1 Sport (Skagit Bay)
# 107	Area 9 Spt	WA Area 9 Sport (Admirality Inlet)
# 108	Skag R Spt	Skagit R Sport
# 109	Ar8A NetNT	WA Area 8A Non-Treaty Net
# 110	Ar8A NetTR	WA Area 8A Treaty Net
# 111	Ar8D NetNT	WA Area 8D Non-Treaty Net (Tulalip Bay)
# 112	Ar8D NetTR	WA Area 8D Treaty Net (Tulalip Bay)
# 113	Stil R Net	Stillaguamish R Net
# 114	Snoh R Net	Snohomish R Net
# 115	Ar 8-2 Spt	WA Area 8.2 Sport (Everett)
# 116	Stil R Spt	Stillaguamish R Sport
# 117	Snoh R Spt	Snohomish R Sport
# 118	Ar 10  Spt	WA Area 10 Sport (Seattle)
# 119	Ar10 NetNT	WA Area 10 Non-Treaty Net (Seattle)
# 120	Ar10 NetTR	WA Area 10 Treaty Net (Seattle)
# 121	Ar10ANetNT	WA Area 10A Non-Treaty Net (Elliott Bay)
# 122	Ar10ANetTR	WA Area 10A Treaty Net (Elliott Bay)
# 123	Ar10ENetNT	WA Area 10E Non-Treaty Net (East Kitsap)
# 124	Ar10ENetTR	WA Area 10E Treaty Net (East Kitsap)
# 125	10F-G  Net	WA Area 10F-G Treaty Net (Lake Union)
# 126	Duwm R Net	Green/Duwamish R Net
# 127	Duwm R Spt	Green/Duwamish R Sport
# 128	L WaSm Spt	Lk Wash/Sammamish/Tribs Spt
# 129	Ar 11  Spt	WA Area 11 Sport (Tacoma)
# 130	Ar11 NetNT	WA Area 11 Non-Treaty Net (E/W Pass)
# 131	Ar11 NetTR	WA Area 11 Treaty Net (E/W Pass)
# 132	Ar11ANetNT	WA Area 11A Non-Treaty Net (Comm. Bay)
# 133	Ar11ANetTR	WA Area 11A Treaty Net (Comm. Bay)
# 134	Puyl R Net	Puyallup R Net
# 135	Puyl R Spt	Puyallup R Sport
# 136	Ar 13  Spt	WAArea 13 Marine Sport
# 137	Ar13 NetNT	Area 13 Non-Treaty Net (So Puget Sound)
# 138	Ar13 NetTR	Area 13 Treaty Net (So Puget Sound)
# 139	Ar13CNetNT	Area 13C Non-Treaty Net (Chambers Bay)
# 140	Ar13CNetTR	Area 13C Treaty Net (Chambers Bay)
# 141	Ar13ANetNT	Area 13A Non-Treaty Net (Carr Inlet)
# 142	Ar13ANetTR	Area 13A Treaty Net (Carr Inlet)
# 143	Ar13DNetNT	Area 13D Non-Treaty Net
# 144	Ar13DNetTR	Area 13D Treaty Net
# 145	A13FKNetNT	Area 13F-13K Non-Treaty Net
# 146	A13FKNetTR	Area 13F-13K Treaty Net
# 147	Nisq R Net	Nisqually R Net
# 148	McAlls Net	McAllister Creek Net
# 149	13D-K TSpt	13D-13K Trib Sport
# 150	Nisq R Spt	Nisqually R Sport
# 151	Desc R Spt	Deschutes R Sport
# 152	Ar 12  Spt	Area 12 Marine Sport
# 153	1212BNetNT	Area 12-12B Hood Canal Non-Treaty Net
# 154	1212BNetTR	Area 12-12B Hood Canal Treaty Net
# 155	A9-9ANetNT	Area 9/9A Non-Treaty Net
# 156	A9-9ANetTR	Area 9/9A Treaty Net (On Res)
# 157	Ar12ANetNT	Area 12A Non-Treaty Net (Quilcene Bay)
# 158	Ar12ANetTR	Area 12A Treaty Net (Quilcene Bay)
# 159	A12CDNetNT	Area 12C-12D Non-Treaty Net (SE Hood Canal)
# 160	A12CDNetTR	Area 12C-12D Treaty Net (SE Hood Canal)
# 161	Skok R Net	Skokomish R Net
# 162	Quilcn Net	Quilcene R Net
# 163	1212B TSpt	12, 12B Trib FW Sport
# 164	12A Tb Spt	12A Trib FW Sport
# 165	12C-D TSpt	12C, 12D Trib FW Sport
# 166	Skok R Spt	Skokomish R Sport

    ),
    comment = "")
```


```{r rmis_rr_lu_BC, eval=FALSE}
#possible BC to assign
select(rmis_rr, 1:16) |> filter(rlsp=="2") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)
select(rmis_rr, 1:16) |> filter(rlsp=="2", f_type != "escp") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)

rmis_rr_lu |> 
  mutate(
    FisheryID = case_when(
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "01" & f_type == "troll" ~ 174, #NW VI Trl
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "02" & f_type == "troll" ~ 175 #SW VI Trl

    ),
    comment = "")
```


```{r }
rmis_rr_lu |> 
  #filter(FisheryID==40) |> 
  filter(FisheryID==175) |> 
  select(FisheryID, recovery_location_code) |> 
  left_join(rmis_rr, by = "recovery_location_code") |> 
  unite("rel_st_reg_bsn", c(release_location_state, release_location_rmis_region, release_location_rmis_basin)) |> 
  count(run_year, rel_st_reg_bsn) |> 
  #ggplot(aes(run_year, n, color = rel_st_reg_bsn)) + geom_line()
  filter(n>5) |> 
  ggplot(aes(run_year, rel_st_reg_bsn, fill = n)) + geom_tile()


```


```{r eval=FALSE}
#AHB file...orig csv in "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/FishMap.csv"
ahb_fishmap <- readxl::read_excel("fram_fishery_rmis_loc.xlsx", sheet = "ahb_mapping")

#!! Note confusion on AK fisheries
#!! CoTC post-season only includes up to 198 in Fishery table
#!! AHB mapping goes up to 205
#!! but doesn't align with recovery_location_name and/or "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/1989LocationsSchema.pdf"
#!! for example, FRAM FID 198 is
#!!   "SW AK NET" in AHB mapping, but "Southeast Alaska Net" in CoTC Fishery table
#!!   and AHB mapping associates 198 to 1M1SW, but 1M1 is listed as Southeast in 1989 spec, with "NW" referring to the NW quadrant of SEAK
#!! moreover, 
rmis_rr |> filter(recovery_location_code == "1M1NW")
ahb_fishmap |> filter(PSC_Code == "1M1NW")

#~232K clean matches
rmis_rr |> 
  mutate(
    #named "Gear" in AHB file...
    fishery_single = floor(fishery/10)
      ) |> 
  inner_join(
    fishmap, 
    by = c(
      "recovery_location_code" = "PSC_Code",
      "fishery_single" = "Gear"
      )) |> 
#  filter(FRAM_Fish_ID > 0) |> 
  filter(FRAM_Fish_ID > 0, fishery < 50) |> 
  count(FRAM_Fish_ID, FRAM_Fish_Name, fishery, gear, recovery_location_code, recovery_location_name) |> 
  arrange(desc(n))


```




## OLDER

Starting to toy with a version of the *Edit Distinct* assignment logic based on number of characters. Unfinished, possibly not worth finishing.

```{r not_run_nchar_edit_distinct, eval=FALSE}
#Edit_Distinct.Gear == first character of RMIS fishery
#approx logic: check match of Edit_Distinct.PSC_Code against corresponding Num_Chars of recovery_location_code
#Edit_Distinct.Fishery_Number is a PSC fishery code, which then needs further mapping to FRAM

msm_tbl$Edit_Distinct |> count(Num_Chars)


split(msm_tbl$Edit_Distinct, msm_tbl$Edit_Distinct$Num_Chars)[1:2] |> 
  map(
    function(df){
      nc = df$Num_Chars[1]
      rmis_recs |> 
        mutate(
          PSC_Code = str_sub(recovery_location_code, 1, nc)
        ) |> 
        left_join(df, by = "PSC_Code")
    }
  )

```


# Recovery patterns

## Recoveries by release state

Totals by year, needs further stratification. Note highly varied y-axis as currently written.

```{r rec_by_rel_state}
rmis_rr |> 
  count(run_year, release_location_state) |> #release_location_rmis_region
  ggplot(aes(run_year, n, fill = release_location_state)) + 
  geom_col(show.legend = F) +
  facet_wrap(~release_location_state, ncol = 1, scales = "free")

  #filter(as.numeric(cwt_1st_mark) < 5000) 
```

## Recoveries by release region, all

Including escapement

```{r relregn_raster_with_escp}
rmis_rr |> 
  count(run_year, f_type, release_location_rmis_region) |>
  filter(!is.na(f_type)) |> 
  ggplot(aes(run_year, release_location_rmis_region, fill = n)) + 
  geom_raster(show.legend = T) +
  wacolors::scale_fill_wa_c("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Key fisheries only...

```{r relregn_raster_net_trl_spt}
rmis_rr |> 
  filter(f_type %in% c("net", "troll", "sport")) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, release_location_rmis_region, fill = n)) + 
  geom_raster(show.legend = T) +
  wacolors::scale_fill_wa_c("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Same as above as lines

```{r relregn_lines_net_trl_spt}
#lines n-recs region (line color) by year
rmis_rr |> 
  filter(f_type %in% c("net", "troll", "sport")) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, n, color = release_location_rmis_region)) + 
  geom_line(show.legend = T) +
  #wacolors::scale_fill_wa_d("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Lines for PS releases only, facet by f_type

```{r relregn_lines_net_trl_spt_ps}
#split by ps release regions
rmis_rr |> 
  filter(
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region %in% regions$ps
    ) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, n, color = release_location_rmis_region)) + 
  geom_line(show.legend = T) +
  wacolors::scale_fill_wa_d("rainier", reverse = T) +
  facet_wrap(~f_type, ncol = 1)
```

Same as above, aggregating over regions within PS

```{r relregn_lines_net_trl_spt}
#aggregate by ps_release region, f_type color
rmis_rr |> 
  filter(
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region %in% regions$ps
    ) |> 
  count(run_year, f_type) |>
  ggplot(aes(run_year, n, color = f_type)) + 
  geom_line(show.legend = T) +
  facet_wrap(~f_type, ncol = 1)
```

Comparing categorical time periods (fishery recoveries by rel_region)

```{r comp_time_fishery_rec}
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport")
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, f_type, release_location_rmis_region) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  filter(year_block != "93-09") |> 
  ggplot(aes(release_location_rmis_region, n, fill = year_block)) +
  geom_col(position = position_dodge()) + coord_flip() +
  facet_wrap(~f_type, scales = "free", ncol = 1)
```

No ColR, time period comp by release "state" including BC

```{r comp_time_fishery_rec_no_ColR}
#comparing time periods of recoveries in fisheries, excluding ColR releases
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport"),
    !(release_location_rmis_region %in% regions$col_riv)
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, release_location_state) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  filter(year_block != "93-09", release_location_state %in% c("BC", "OR", "WA")) |> 
  ggplot(aes(release_location_state, n, fill = year_block)) +
  geom_col(position = position_dodge())
```

Drill down to examine just Fraser R releases

```{r comp_time_fishery_rec_fraser}
#very little to work with in recent years...
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region == "FRTH"
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, release_location_rmis_basin) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  ggplot(aes(release_location_rmis_basin, n, fill = year_block)) +
  geom_col(position = position_dodge())

rmis_rr |> 
  filter(release_location_rmis_basin == "LOFR", !is.na(f_type)) |> 
  count(run_year, f_type) |> 
  ggplot(aes(run_year, n, fill = f_type)) +
  geom_col(position = position_dodge())

rmis_rr |> 
  filter(release_location_rmis_basin == "LOFR", f_type == "sport") |> 
  count(run_year, rlsp) |> 
  ggplot(aes(run_year, n, fill = rlsp)) +
  geom_col(position = position_dodge())
```

## NEXT: look for release region with adequate recoveries both time blocks. Focus on fishery recoveries assuming that escp recs probably ok if fishery ok

```{r}
rmis_rr |> 
  distinct(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  arrange(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  #split(~release_location_state) 
  filter(release_location_state == "WA") |> print(n=50)
  


rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport")
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19"))
    )


```

## trial dummy with prelim MSM mapped 

```{r}
#trial dummy example
mpdrec <- readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MappedRecoveries.xlsx", sheet = "MappedRecoveries")

mpdrec |>
  ggplot(aes(RunYear)) +
  geom_bar()
#equivalently...
mpdrec |>
  count(RunYear) |> 
  ggplot(aes(RunYear, n)) +
  geom_col()


#all recoveries
mpdrec |>
  ggplot(aes(factor(RunYear), factor(PrNum))) +
  geom_bin2d()

#all non-escapement recoveries
mpdrec |>
  filter(MSMFishCode != 228) |> 
  ggplot(aes(factor(RunYear), factor(PrNum))) +
  geom_bin2d() +
  scale_fill_distiller(direction = 1)

```

## PR by year

## PR_MU by year


