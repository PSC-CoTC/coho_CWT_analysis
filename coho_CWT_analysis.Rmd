---
title: "Coho CWT FRAM & MSM Analysis"
author: "Dan.Auerbach@dfw.wa.gov, Angelika.Hagen-Breaux@dfw.wa.gov, carrie_cook-tabor@fws.gov"
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  bookdown::html_document2:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
---

```{r setup, results = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9)

library("tidyverse")
library("gt")
library("patchwork")
library("odbc"); library("DBI")
theme_set(theme_light())
#library("ggridges")

dir_proj <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis"

fp <- list(
  rmis_recs = file.path(dir_proj, "rmis_coho_recoveries_86_2020.rds"),
  rmis_rel = file.path(dir_proj, "rmis_coho_releases_for_rec_86_2020.rds"),
  rmis_rec_rel = file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"),
  
  mdb_pre = "O:/code/coho/fram_mdbs/US_PFMC_NOF_FinalCohoFRAM_MultiYr.mdb",
  mdb_pst = "O:/code/coho/fram_mdbs/PSC_CoTC_PostSeason_CohoFRAMDB_thru2020_021622.mdb"

  # "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MSM_86-91_Oct2006.mdb"
  # "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MSM_98-2020- SF2019.mdb"
  )

rmis_rr <- readRDS(fp$rmis_rec_rel) |> 
  filter(!is.na(release_location_state)) |>  #drop 3 recent
  mutate(age = run_year - brood_year) |> 
  rowid_to_column("uid")

regions <- list(
  col_riv = c("CECR", "CRGN", "LOCR", "UPCR"),
  ps = c("SPS", "MPS", "NPS", "HOOD", "JUAN", "SKAG", "NOWA"),
  wa_cst = c("NWC", "GRAY", "WAGN", "WILP")
)

rgns <- map_df(regions, ~paste0(.x, collapse =",")) |> 
  pivot_longer(names_to = "rgn", values_to = "release_location_rmis_region", everything()) |> 
  separate_rows(release_location_rmis_region)


lu <- list(
  #CCT queried releases, QAQC'd and assigned to PR and PR_MU
  #these are assigned to FRAM marked wild StockIDs
  #and are limited to ONLY tag_codes for MARKED releases
  cwt_stk = read_csv(file.path(dir_proj, "MSMDB/MSM_Stock_CWT2.csv")) |> 
    mutate(run_year = Run_ID+1985) |> 
    select(run_year, tag_code = CWT_Code, area = Area_Agg,
           pr = PR_Number, pr_mu = PR_MU_Number, n_rel = Number_Released,
           StockID = FRAMStkID, everything()) |> 
    filter(!is.na(pr), !is.na(pr_mu), pr_mu > 0) |> 
    #exclude a double-mapped row
    filter(!(run_year == 1996 & tag_code == "071544" & StockID == 166))
  ,
  #AHB file...orig csv in "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/FishMap.csv"
  ahb_fishmap = readxl::read_excel("rmis_loc_fram_fishery.xlsx", sheet = "ahb_mapping") |> 
    filter(FRAM_Fish_ID > 0) |> 
    select(FisheryID = FRAM_Fish_ID, FisheryName = FRAM_Fish_Name, fishery_single = Gear, Num_Chars, PSC_Code) |> 
    distinct(FisheryID, FisheryName, fishery_single, Num_Chars, PSC_Code) #drop identical duplicate rows
  ,
  #DA incomplete rel state/region/basin to pr/pr_mu/StockID
  rmis_rgn_stkid = readxl::read_excel(file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx"))
)



#same: readxl::read_excel("rmis_loc_fram_fishery.xlsx", sheet = "tbl_fishery_cotc_post")
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0(
    "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=",
    "O:/code/coho/fram_mdbs/PSC_CoTC_PostSeason_CohoFRAMDB_thru2020_021622.mdb",
    ";")
  )

fram_fishery <- tbl(db_con, "Fishery") |> 
  filter(Species == "COHO") |> 
  select(FisheryID:FisheryTitle) |> 
  collect()

DBI::dbDisconnect(db_con)

```

# Summary

This script analyzes coho coded wire tag (CWT) recoveries (and associated releases) reported in RMIS.

# Data

## RMIS LUs

```{r rmis_lu_downloads, eval=FALSE}
# walk(
#   c("https://www.rmpc.org/data/fishery.csv", "https://www.rmpc.org/data/gear.csv"), #others for various fields... 
# ~.x |> download.file(destfile = paste0("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_", basename(.x)))
# )

#DA added into "rmis_loc_fram_fishery.xlsx"

## All release locations, could be used to supplement CCT cwt_stk...
# download.file(
#   "https://www.rmpc.org/data/RL041_ALL_FULLSET.csv",
#   "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_rel_loc_all.csv"
#   )

read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_rel_loc_all.csv")

```

## RMIS wrangling

These chunks preserve one-time operations to generate starting datasets from RMIS.

```{r read_in_rmis_recoveries, eval=FALSE}
dir_rmis_recs <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/RMISRecoveries/"

focal_cols_recs <- c("recovery_id", "tag_code", "run_year", "recovery_location_code", "recovery_location_name", "fishery", "gear", "estimated_number")

# rmis_recs <- purrr::map_dfr(
#   list.files(dir_rmis_recs, full.names = T)
#   ,
#   ~readr::read_csv(.x, col_select = all_of(focal_cols_recs))
#   )
# 
# saveRDS(rmis_recs, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_recoveries_86_2020.rds")

```

```{r get_releases_by_tag_code, eval=FALSE}
rmis_recs |> 
  mutate(year_set = if_else(run_year <= 1992, "86-92", "93-20")) |> 
  #distinct(year_set, tag_code) |> split(~year_set) |> 
  distinct(tag_code) |> rownames_to_column(var = "id") |> 
  mutate(
    id = as.numeric(id), 
    block = cut(id, breaks = c(seq(0,20000,by=2000))),
    block = letters[as.integer(block)]
    ) |> #count(block)
  split(~block) |> 
  writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx")

f <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx"

#readxl::read_excel(f, sheet = "a") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "b") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "c") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "d") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "e") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "f") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "g") |> pluck("tag_code") |> writeLines("clipboard")

focal_cols_rel <- c("tag_code_or_release_id", "brood_year", "release_location_code", "hatchery_location_code", "stock_location_code", "release_location_name", "hatchery_location_name", "stock_location_name", "release_location_state", "release_location_rmis_region", "release_location_rmis_basin", "cwt_1st_mark", "cwt_1st_mark_count", "cwt_2nd_mark", "cwt_2nd_mark_count")

rmis_rel <- map_df(
  c(
  "https://www.rmis.org/reports/CSV13497.txt",
  "https://www.rmis.org/reports/CSV13656.txt",
  "https://www.rmis.org/reports/CSV13738.txt",
  "https://www.rmis.org/reports/CSV13814.txt",
  "https://www.rmis.org/reports/CSV13854.txt",
  "https://www.rmis.org/reports/CSV14030.txt",
  "https://www.rmis.org/reports/CSV14116.txt"
  ),
  ~read_csv(.x, col_select = all_of(focal_cols_rel)) |> 
    mutate(
      cwt_1st_mark = as.character(cwt_1st_mark),
      cwt_2nd_mark = as.character(cwt_2nd_mark)
      )
  )

#saveRDS(rmis_rel, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_releases_for_rec_86_2020.rds")

```

```{r build_rec_rel, eval=FALSE}

left_join(
  readRDS(fp$rmis_recs) |> 
    mutate(
      rlsp = str_sub(recovery_location_code, 1, 1),
      rlwtr = str_sub(recovery_location_code, 2, 2),
      rlsctr = str_sub(recovery_location_code, 3, 3),
      rlrgn = str_sub(recovery_location_code, 4, 5),
      rlarea = str_sub(recovery_location_code, 6, 9),
      rllocn = str_sub(recovery_location_code, 10, 16),
      rlsubl = str_sub(recovery_location_code, 17, 19),
      f_type = case_when(
        between(fishery, 10, 19) ~ "troll",
        between(fishery, 20, 39) ~ "net",
        between(fishery, 40, 49) ~ "sport",
        between(fishery, 50, 59) ~ "escp"
      )
    )
  ,
  readRDS(fp$rmis_rel) |> select(-contains("n_code")),
  by = c("tag_code" = "tag_code_or_release_id")
  ) ##|> saveRDS(file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"))

```

# Stock mapping

The LU begun from this first chunk was initiated but then paused due to existing CCT work in `lu$cwt_stk`

Exporting a format for the needed lookup from RMIS release location fields (state, region, basin) and the MSM/FRAM production region and management units (PR and PR_MU), and thence to FRAM StockID(s). Some of this is already available in, for example, the escapement compilation template sheet?

```{r lu_rmis_rel_to_pr_prmu_xlsx, eval=FALSE}

# rmis_rr |> 
#   distinct(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
#   arrange(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
#   mutate(pr = NA, pr_mu = NA, StockID = NA) |> 
##Manually modified, do not overwrite:  #writexl::write_xlsx(file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx"))


# #unused below...but considered in beginning of file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx")
# readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Escapement files/Coho/fram_coho_escapement_2022.xlsx", sheet = "year_template") |> 
#   select(
#     MSM_PR = ProductionRegionNumber, 
#     MSM_PR_MU = ManagementUnitNumber,
#     RRTerm_PR, RRTerm_PR_MU, 
#     StockID, 
#     StockLongName, 
#     StockName
#     )

```

Examining `rmis_rr` against `lu$cwt_stk` mapping

```{r rmis_rr_cwt_stk, eval=FALSE}

#basically mapped for 1998 forward, presumably due to expectation that older are already mapped elsewhere in MSM?
lu$cwt_stk |> count(run_year) |> print(n=100)

distinct(rmis_rr, tag_code) #12936 releases
distinct(lu$cwt_stk, tag_code) #5491 mapped

length(setdiff(rmis_rr$tag_code, lu$cwt_stk$tag_code)) #7642 codes not mapped to PR...
length(setdiff(lu$cwt_stk$tag_code, rmis_rr$tag_code)) #oddballs, most of the mapped are in recs
#for example...
filter(lu$cwt_stk, tag_code == "180691*1")
#confirming that many 6-character, leading 0 codes are in recs...
rmis_rr |> filter(nchar(tag_code) <= 6, str_sub(tag_code, 1,1) == "0")
#but 5294 shared/mapped codes (recall dup run_year)
length(intersect(rmis_rr$tag_code, lu$cwt_stk$tag_code)) 

nrow(distinct(lu$cwt_stk, run_year, tag_code)) == nrow(lu$cwt_stk)
count(lu$cwt_stk, run_year, tag_code) |> filter(n>1)
# filter(lu$cwt_stk, run_year == 1996, tag_code == "071544")
# filter(lu$cwt_stk, Stock_Name == "TANNER CR (BNVILLE)") #released in multiple pr_mus
# filter(lu$cwt_stk, Release_Name == "YOUNGS R & BAY") #looks like it should be pr_mu==2


#rmis_rr |> left_join(lu$cwt_stk, by = c("run_year", "tag_code")) |> count(is.na(pr))

rmis_rr_cwt_stk <- inner_join(rmis_rr, lu$cwt_stk, by = c("run_year", "tag_code"))

rmis_rr_cwt_stk |> 
  #group_by(run_year, area) |> summarise()
  #count(run_year, area) |> ggplot(aes(run_year, n)) + geom_col() + facet_wrap(~area)
  count(run_year, pr) |> #pivot_wider(names_from = run_year, values_from = n) |> arrange(pr)
  ggplot(aes(run_year, n)) + geom_col() + facet_wrap(~pr)


```

Question 5/31/22 - which programs have had the most stable/consistent releases?

```{r big_beef_example}
rmis_rr |> count(hatchery_location_name, stock_location_name)

#rmis_rel <- readRDS(fp$rmis_rel)

rmis_rr |> 
  filter(f_type != "escp") |> 
  group_by(stock_location_name, brood_year) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  ggplot(aes(factor(brood_year), stock_location_name, fill = cwt_1st_mark_count, color = cwt_1st_mark_count)) + geom_tile()

#rmis_rr |> filter(f_type != "escp") |> pluck("brood_year") |> range() #1980:2018

#programs with most years of fishery-recovered releases
rmis_rr |> filter(f_type != "escp") |> 
  distinct(stock_location_name, brood_year) |>
  count(stock_location_name) |> 
  filter(n > 34) |> 
  arrange(desc(n))

#explore with "BIG BEEF CR"
## non-escapement recoveries & mark-counts by brood year
## post-2004 see a clear drop in typical cwt_1st_mark_count without a big drop in n_recs
## could be various factors, but perhaps interesting and definitely inflects other ideas
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  group_by(stock_location_name, brood_year) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  pivot_longer(cols = c(n_recs, cwt_1st_mark_count), names_to = "var", values_to = "val") |> 
  ggplot(aes(factor(brood_year), val)) + geom_col() + facet_wrap(~var, ncol = 1, scales = "free")

## non-escapement recoveries by run_year and fishery
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  group_by(stock_location_name, run_year, f_type) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  pivot_longer(cols = c(n_recs, cwt_1st_mark_count), names_to = "var", values_to = "val") |> 
  ggplot(aes(factor(run_year), val, fill = f_type)) + geom_col() + facet_wrap(~var, ncol = 1, scales = "free")

## same as above, starting to focus on fishery changes 
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  group_by(stock_location_name, run_year, f_type) |> 
  summarise(
    n_recs = n(),
    cwt_1st_mark_count = min(cwt_1st_mark_count),
    .groups = "drop"
  ) |> 
  pivot_longer(cols = c(n_recs, cwt_1st_mark_count), names_to = "var", values_to = "val") |> 
  filter(var == "n_recs") |> 
  ggplot(aes(factor(run_year), val, fill = f_type)) + geom_col() + facet_wrap(~f_type, ncol = 1)

## CCT FRAM stock mapping appears unhelpful?
## is it simply not used? or is the mapping off?
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  left_join(lu$cwt_stk, by = c("run_year", "tag_code")) |> 
## 761 recs for 1998-2000 mapped to StockID 46 "Area 12/12B Wild Marked"
  #count(FRAMStkID)
  filter(!is.na(FRAMStkID)) |> count(run_year) |> print(n=50) 

## looking ahead to fishery mapping work below...
rmis_rr |> 
  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "BIG BEEF CR")) |> 
  count(stock_location_name, run_year, rlsp, rlwtr, rlsctr, f_type) |> 
  filter(rlsp == "3", rlsctr == "1") |> 
  unite(col = "rlft", c(rlsp, rlwtr, rlsctr, f_type)) |> 
  mutate(run_year = factor(run_year)) |> 
  #ggplot(aes(run_year, rlft, fill=n)) + geom_tile() 
  
  ggplot(aes(run_year, n, fill=rlft)) + geom_col(position = "dodge")
```


# Fishery mapping

## misc initial

```{r pull_msm_edit_distinct, eval=FALSE}
#86-91, 92-97, 98-2020

db <- "C:/Users/auerbdaa/Downloads/MSM_98-2020- SF2019_cmpct.mdb"
#db <- fp$db_msm
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=", db, ";")
  )

msm_tbl_names <- c("Edit_Distinct")

msm_tbl <- map(set_names(msm_tbl_names), ~collect(tbl(db_con, .x)))

DBI::dbDisconnect(db_con)

msm_tbl$Edit_Distinct

```

```{r FishAggMap, eval=FALSE}
#AHB very coarse mapping  
read_csv(file.path(dir_proj, "MSMDB/FishAggMap.csv"))
```

```{r rec_location_code_init_EDA, eval=FALSE}
rmis_rr |> 
  filter(
    str_sub(recovery_location_code,1,3) == "6MO"
  ) |> 
  count(recovery_location_code) |> arrange(desc(n))

#38 distinct, vast majority in first 22
rmis_rr |> count(str_sub(recovery_location_code,1,3)) |> arrange(desc(n)) |> print(n=100)

#4989 distinct but only first ~2K matter
rmis_rr |> count(recovery_location_code) |> arrange(desc(n)) |> 
  rowid_to_column() |> ggplot(aes(rowid, n)) + geom_col()

#excluding escapement about ~4K, 
#with ~2K having more than 5 recs 
#and ~2.7K more than 5 incl escp
rmis_rr |> 
  filter(fishery < 50) |>
  count(recovery_location_code) |> arrange(desc(n)) |> 
  filter(n > 5) |> 
  rowid_to_column() |> ggplot(aes(rowid, n)) + geom_col()
```

```{r write_starting_rmis_loc_fram_fishery, eval=FALSE}
# rmis_rr |> 
#   count(
#     loc3 = str_sub(recovery_location_code,1,3),
#     recovery_location_code,
#     recovery_location_name,
#     fishery, gear
#     ) |> 
#   arrange(desc(n)) 
# ## DA began mapping to FRAM FisheryID
# ##  writexl::write_xlsx("NOOVERWRITErmis_loc_fram_fishery")

# ##another older version: write_csv("rmis_rec_loc_fishery_gear_init.csv", na = "")
# read_csv("rmis_rec_loc_fishery_gear_init.csv")
# filter(rmis_rr, recovery_location_code == "1M1") |> select(1:8)

## DA began to build from PSC_V41_Specification.pdf, pg 49-60 
## realized this must exist already, searched, DL'd and added into workbook
# readxl::read_excel("rmis_loc_fram_fishery.xlsx", sheet = "rmis_lu_gear")
```

## rmis_rr_lu

Attempt to build lookup from RMIS recovery location codes to FRAM FisheryIDs

This first chunk distinguishes the unique *recovery_location_codes* and builds new fields by character position, following the RMIS schema (PSC_V41_Specification_Nov2021.pdf).

In addition, the RMIS "gear" lookup is joined, providing *gear_name* strings. 

```{r build_starting_lu_rmis_loc_fram_fishery, eval=FALSE}
rmis_rr_lu <- rmis_rr |> 
  count(
    recovery_location_code, recovery_location_name,
    rlsp, rlwtr, rlsctr, rlrgn, #chars 1,2,3,4:5
    rlarea, rllocn, rlsubl, #chars 6:9,10:16,17:19 
    fishery, gear, f_type) |> 
  arrange(rlsp, desc(n)) |> 
  mutate(
    rlsp_desc = set_names(c("AK", "BC", "WA", "ID", "OR", "CA", "HS", "FR"),1:8)[rlsp],
    rlwtr_desc = set_names(c("Marine", "Freshw"), c("M", "F"))[rlwtr],
    rlsctr_desc = case_when(
      rlsp == "1" & rlsctr == "1" ~ "Southeast AK",
      rlsp == "1" & rlsctr == "2" ~ "Southcentral AK",
      rlsp == "1" & rlsctr == "3" ~ "Arctic-Yukon",
      rlsp == "1" & rlsctr == "4" ~ "Westward AK",
      rlsp == "2" & rlsctr == "N" ~ "N of Cape Caution",
      rlsp == "2" & rlsctr == "S" ~ "S of Cape Caution",
      rlsp == "3" & rlsctr == "1" ~ "Puget Sound",
      rlsp == "3" & rlsctr == "2" ~ "Coastal",
      rlsp == "3" & rlsctr == "3" ~ "Ocean",
      rlsp == "3" & rlsctr == "4" ~ "Columbia",
      rlsp == "5" & rlsctr == "2" ~ "Coastal",
      rlsp == "5" & rlsctr == "3" ~ "Columbia",
      rlsp == "6" & rlsctr == "K" ~ "Klamath-Trinity",
      rlsp == "6" & rlsctr == "C" ~ "Central Valley",
      rlsp == "6" & rlsctr == "A" ~ "North Coastal",
      rlsp == "6" & rlsctr == "B" ~ "Central Coastal",
      rlsp == "6" & rlsctr == "D" ~ "Sout Coastal",
      rlsp == "6" & rlsctr == "O" ~ "Ocean",
      rlsp == "6" & rlsctr == "M" ~ "Mountain"
    )
    ,
    rlrgn_desc = case_when(
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "01" ~ "NW Van Isl troll",
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "02" ~ "SW Van Isl troll",      
      
      rlsp == "3" & rlrgn == "01" ~ "Nooksack/Sam term comm",
      rlsp == "3" & rlrgn == "02" ~ "Skagit term comm",
      rlsp == "3" & rlrgn == "03" ~ "Stilly/Sno term comm",
      rlsp == "3" & rlrgn == "04" ~ "Hood Canal term comm",
      rlsp == "3" & rlrgn == "05" ~ "S Puget Sound term comm",
      rlsp == "3" & rlrgn == "06" ~ "Domestic mixed comm",
      rlsp == "3" & rlrgn == "07" ~ "Internat mixed comm",
      rlsp == "3" & rlrgn == "08" ~ "Strait JDF term comm",
      rlsp == "3" & rlrgn == "11" ~ "Internat mixed spt 5/6/7",
      rlsp == "3" & rlrgn == "12" ~ "Skagit/Stilly/Sno term spt 8",
      rlsp == "3" & rlrgn == "13" ~ "Domestic mixed spt 9",
      rlsp == "3" & rlrgn == "14" ~ "S Puget Sound spt 10/11//13",
      rlsp == "3" & rlrgn == "15" ~ "Hood Canal spt 12",
      rlsp == "3" & rlrgn == "17" ~ "N Coast streams",
      rlsp == "3" & rlrgn == "18" ~ "Grays Hbr & tribs",
      rlsp == "3" & rlrgn == "19" ~ "Willapa Hbr & tribs",
      rlsp == "3" & rlrgn == "20" ~ "Columbia",
      rlsp == "3" & rlrgn == "21" ~ "MA1",
      rlsp == "3" & rlrgn == "22" ~ "MA2",
      rlsp == "3" & rlrgn == "23" ~ "MA3",
      rlsp == "3" & rlrgn == "24" ~ "MA4",
      rlsp == "3" & rlrgn == "25" ~ "MA5 troll only",
      rlsp == "3" & rlrgn == "26" ~ "MA6 troll only",

      rlsp == "5" & rlrgn == "21" ~ "Coast private",
      rlsp == "5" & rlrgn == "22" ~ "Coast public",
      rlsp == "5" & rlrgn == "31" ~ "WA below Bonn",
      rlsp == "5" & rlrgn == "32" ~ "OR below Bonn",
      rlsp == "5" & rlrgn == "33" ~ "Willamette",
      rlsp == "5" & rlrgn == "34" ~ "Bonn to McNary",
      rlsp == "5" & rlrgn == "35" ~ "Snake",
      
      rlsp == "6" & rlrgn == "FB" ~ "Fort Bragg", #appears unused in these codes
      rlrgn == "" ~ ""
    ),
    # rlarea_desc = "",
    # rllocn_desc = "",
    # rlsubl_desc = ""
  ) |> 
  left_join(
    #the gear_name is non-distinct across agencies for some fishery-gear combos
    #but duplication and differences in appear non-significant
    #so preserving first version as distinct()
    read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_gear.csv") |> 
      #mutate(f_g = paste0(fishery,"_", gear)) |> count(f_g) |> arrange(desc(n)) |> filter(n > 1) |> print(n=100)
      distinct(fishery, gear, .keep_all = T)
    ,
    by = c("fishery", "gear")
  )
```

The (incomplete) chunks below begin FisheryID assignment by state/region.

### California 

```{r rmis_rr_lu_CA, eval=FALSE}
#possible CA codes to assign...
#https://wildlife.ca.gov/Fishing/Ocean/Regulations/Salmon
#from N to S: KMZ-->Ft.Bragg-->San Fran-->Montery&South
select(rmis_rr, 1:16) |> filter(rlsp=="6") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn) |> print(n=100)

rmis_rr_lu |> 
  mutate(
    FisheryID = case_when(
      #str_detect(rllocn, c("")) & f_type == "sport" ~ 3, #Ft Brg Spt
      #str_detect(rllocn, c("")) & f_type == "troll" ~ 4, #Ft Brg Trl
      str_detect(rllocn, c("BGCB|OBBG|OBCB|OBFK")) & f_type == "sport" ~ 5, #Ca KMZ Spt, northernmost
      str_detect(rllocn, c("BGCB|OBBG|OBCB|OBFK")) & f_type == "troll" ~ 6, #Ca KMZ Trl, northernmost
      str_detect(rllocn, c("FRPP|FRPS|NHPS|PPPS|PSMB")) & f_type == "sport" ~ 7, #So Cal Spt
      str_detect(rllocn, c("FRPP|FRPS|NHPS|PPPS|PSMB")) & f_type == "troll" ~ 8 #So Cal Trl

    ),
    comment = "")
```

### Oregon

```{r rmis_rr_lu_OR, eval=FALSE}
#possible OR to assign
#large majority are escapement
#unclear how FRAM ColR fisheries combine/split OR/WA 
select(rmis_rr, 1:16) |> filter(rlsp=="5") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)

```

### Washington

```{r rmis_rr_lu_WA, eval=FALSE}
#possible WA to assign
select(rmis_rr, 1:20) |> filter(rlsp=="3") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)
#excluding escp/hatcheries
select(rmis_rr, 1:20) |> filter(rlsp=="3", f_type != "escp") |> 
  count(recovery_location_code, recovery_location_name, rlsp, rlwtr, rlsctr, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)

#working scratch
rmis_rr_lu |> filter(str_detect(recovery_location_name, "HOKO"))

rmis_rr_lu |> filter(rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="11" & rlarea=="06  ") |> print(n=50)


rmis_rr_lu_wa <- rmis_rr_lu |> 
  mutate(
    FisheryID = case_when(
# 30	LCRWaT Spt	Col. Rvr. Wash Trib Spt
# 31	UpColR Spt	Col. Rvr. Sport Above Bonneville
# 32	UpColR Net	Col. Rvr. Net Above Bonneville
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="21" & fishery %in% 40:49 ~ 33, #A1-Ast Spt	WA Area 1 & Astoria Sport; this includes various older "OCEAN SPORT AREA 71/81/91"...
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="21" & fishery %in% 10:19 ~ 34, #A1-Ast Trl	WA Area 1 & Astoria Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="22" & fishery==10 & gear==41 ~ 35, #Area2Trl NT	WA Area 2 Non-Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="22" & fishery==15 & gear==40 ~ 36, #Area2TrlTR	WA Area 2 Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="22" & fishery %in% 40:49 ~ 37, #Area 2 Spt	WA Area 2 Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="23" & fishery==10 & gear==41 ~ 38, #WA Area 3 Non-Treaty troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="23" & fishery==15 & gear==40 ~ 39, #WA Area 3 Treaty troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="23" & fishery %in% 40:49 ~ 40, #WA Area 3 Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="24" & fishery %in% 40:49 ~ 41,	#Area 4 Spt	WA Area 4 Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="24" & fishery==10 & gear==41 ~ 42,	#A4/4BTrlNT	WA Area 4/4B Non-Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn=="24" & fishery==15 & gear==40 ~ 43,	#A4/4BTrlTR	WA Area 4/4B Treaty Troll
      rlsp=="3" & rlwtr=="M" & rlsctr=="3" & rlrgn %in% c("25","26") & fishery==15 ~ 44, #A5-6C Trl	WA Area 5-6-6C Troll; all Treaty troll

      rlsp=="3" & rlwtr=="M" & rlsctr=="2" & rlrgn=="19" & fishery %in% 40:49 ~ 45, #Willpa Spt	Willapa Bay Sport (2.1)
      rlsp=="3" & rlwtr=="F" & rlsctr=="2" & rlrgn=="19" & fishery==46 ~ 46,	#Wlp Tb Spt	Willapa Tributary Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="2" & rlrgn=="19" & fishery %in% 20:29 ~ 47, #WlpaBT Net	Willapa Bay & FW Trib Net; all 22-14, Non-treaty Drift Gillnet

      rlsp=="3" & rlwtr=="M" & rlsctr=="2" & rlrgn=="18" & fishery %in% 40:49 ~ 48, #GryHbr Spt	Grays Harbor Sport (2.2)
#!!unclear how to split out from above? # 49	SGryHb Spt	South Grays Harbor Sport
      rlsp=="3" & rlwtr=="M" & rlsctr=="2" & rlrgn=="18" & fishery %in% 20:29 ~ 50, #GryHbr Net	Grays Harbor Estuary Net; all NT drift gillnet

      recovery_location_code=="3F21802  220004 R" & fishery==46 ~ 51, #Hump R Spt	Humptulips R Sport
#!!need info to split NT/TR on gear and other fields: recovery_location_code=="3F21802  220190 R" & fishery==22 ~ 52, #LwCheh Net	Lower Chehalis R Net
#!!would this have reported recoveries? 53	Hump R C&S	Humptulips R C&S
      recovery_location_code=="3F21802  220190 R" & fishery==46 ~ 54, #Chehal Spt	Chehalis R Sport
      recovery_location_code=="3F21802  220004 R" & fishery==22 ~ 55, #Hump R Net	Humptulips R Net
#!!need info to split NT/TR on gear and other fields: recovery_location_code=="3F21802  220190 R" & fishery==22 ~ 56, #UpCheh Net	Upper Chehalis R Net
#!!would this have reported recoveries? 57	Chehal C&S	Chehalis R C&S
#!!no recoveries? 58	Wynoch Spt	Wynochee R Sport
#!!no recoveries? 59	Hoquam Spt	Hoquiam R Sport
#!!no recoveries? 60	Wishkh Spt	Wishkah R Sport
      recovery_location_code %in% c("3F21802  220360 R", "3F21802  220360 R02", "3F21802  220462 R", "3F21802  220414 R") & fishery==46 ~ 61, #Satsop Spt	Satsop R Sport
#!!no recoveries? 62	Quin R Spt	Quinault R Sport
      recovery_location_code=="3F21702  210398 R" & fishery==22 ~ 63, #Quin R Net	Quinault R Net
#!!would this have reported recoveries? 64	Quin R C&S	Quinault R C&S
      recovery_location_code=="3F21703  210016 R" & fishery==46 ~ 65, #Queets Spt	Queets R Sport
      recovery_location_code=="3F21703  210024 R" & fishery==46 ~ 66, #Clrwtr Spt	Clearwater R Sport
#!!no recoveries? 67	Salm R Spt	Salmon R Sport (Queets)
      recovery_location_code=="3F21703  210016 R" & fishery==22 ~ 68, #Queets Net	Queets R Net
#!!would this have reported recoveries? 69	Queets C&S	Queets R C&S
      recovery_location_code=="3F21703  200096 R" & fishery==46 ~ 70, #Quilly Spt	Quillayute R Sport; should this also get the couple of Sol Duc R spt recs?
      recovery_location_code=="3F21703  200096 R" & fishery %in% 20:29 ~ 71, #Quilly Net	Quillayute R Net; should this get the 770 Sol Duc R recs?
#!!would this have reported recoveries? 72	Quilly C&S	Quillayute R C&S
      recovery_location_code=="3F21703  200422 R" & fishery==46 ~ 73, #Hoh R  Spt	Hoh R Sport
      recovery_location_code=="3F21703  200422 R" & fishery %in% 20:29 ~ 74, #Hoh R  Net	Hoh R Net
#!!would this have reported recoveries? 75	Hoh R  C&S	Hoh R C&S

      recovery_location_code %in% c("3F21704  200015 R", "3F21704  200005 R") & fishery==46 ~ 76, #Mak FW Spt	Makah Tributary Sport
      recovery_location_code %in% c("3F21704  200015 R", "3F21704  200005 R") & fishery %in% 20:29 ~ 77, #Mak FW Net	Makah Freshwater Net
#!!would this have reported recoveries? 78	Makah  C&S	Makah C&S
# 79	A 4-4A Net	WA Area 4-4A Net
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="07" & rlarea %in% c("04  ","45X1","05","06  ") & fishery==23 & gear=="14" ~ 80, #A4B6CNetNT	WA Area 4B-5-6C Non-Treaty Net; not assigned 23-16 Set Gillnet, 23-52 Mixed Net
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="07" & rlarea %in% c("04  ","45X1","05","06  ") & fishery==23 & gear!="14" ~ 81, #A4B6CNetTR	WA Area 4B-5-6C Treaty Net; assigned 23-16 Set Gillnet, 23-52 Mixed Net
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="08" & rlarea =="06  " & rllocn=="D" & fishery==23 & gear=="14" ~ 82, #Ar6D NetNT	6D Non-Treaty Net (Dungeness Bay & R); no FW net recs with "DUNGENESS" in name
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="08" & rlarea =="06  " & rllocn=="D" & fishery==23 & gear!="14" ~ 83, #Ar6D NetTR	6D Treaty Net (Dungeness Bay & R); no FW net recs with "DUNGENESS" in name
      
      recovery_location_code=="3F10806  180272 R" & fishery==23 ~ 84, #Elwha  Net	Elwha R Net
#!!no recoveries? # 85	WJDF T Net	West JDF Straits Trib Net
#!!which rivers are these? # 86	EJDF T Net	East JDF Straits Trib Net
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="07" & rlarea %in% c("07", "07  ", "07x1") & rllocn!="E" & fishery==23 & gear %in% c("14","19") ~ 87, #A6-7ANetNT	WA Area 7-7A Non-Treaty Net
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="07" & rlarea %in% c("07", "07  ", "07x1") & rllocn!="E" & fishery==23 & gear %in% c("12","16","17","20","29","49","52") ~ 88, #A6-7ANetTR	WA Area 7-7A Treaty Net
#!!which rivers are these?# 89	EJDF FWSpt	East JDF Straits Trib Sport
#!! next is NOT including 3M11105 currently in A5 that could go here? HOKO R & MOUTH, SEKIU R & MOUTH, etc
      recovery_location_code %in% c("3F10805  190148 R", "3F10805  190113 R") & fishery %in% 40:49 ~ 90, #WJDF FWSpt	West JDF Straits Trib Sport; HOKO & PYSHT FW   
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="11" & rlarea=="05  " ~ 91, #Area 5 Spt	WA Area 5 Sport (Sekiu); includes various terminal zones that perhaps could/should assign elsewhere
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="11" & rlarea=="06  " ~ 92, #Area 6 Spt	WA Area 6 Sport (Port Angeles); includes various terminal zones that perhaps could/should assign elsewhere
      rlsp=="3" & rlwtr=="M" & rlsctr=="1" & rlrgn=="11" & rlarea=="07  " ~ 93, #Area 7 Spt	WA Area 7 Sport (San Juan Islands)
#!! next is NOT including 3M11106 DUNGENESS BAY & SPIT sport recs in A6: "3M11106  872132","3M11106  872134", "3M11106  872133"
      recovery_location_code %in% c("3F10806  180018 R") & fishery %in%40:49 ~ 94, #Dung R Spt	Dungeness R Sport
      recovery_location_code=="3F10806  180272 R" & fishery %in% 40:49 ~ 95,	#ElwhaR Spt	Elwha R Sport

# 96	A7BCDNetNT	WA Area 7B-7C-7D Non-Treaty Net
# 97	A7BCDNetTR	WA Area 7B-7C-7D Treaty Net
# 98	Nook R Net	Nooksack R Net
# 99	Nook R Spt	Nooksack R Sport
# 100	Samh R Spt	Samish R Sport
# 101	Ar 8 NetNT	WA Area 8 Non-Treaty Net (Skagit)
# 102	Ar 8 NetTR	WA Area 8 Treaty Net (Skagit)
# 103	Skag R Net	Skagit R Net
# 104	SkgR TsNet	Skagit River Test Net
# 105	SwinCh Net	Swinomish Channel Net
# 106	Ar 8-1 Spt	WA Area 8.1 Sport (Skagit Bay)
# 107	Area 9 Spt	WA Area 9 Sport (Admirality Inlet)
# 108	Skag R Spt	Skagit R Sport
# 109	Ar8A NetNT	WA Area 8A Non-Treaty Net
# 110	Ar8A NetTR	WA Area 8A Treaty Net
# 111	Ar8D NetNT	WA Area 8D Non-Treaty Net (Tulalip Bay)
# 112	Ar8D NetTR	WA Area 8D Treaty Net (Tulalip Bay)
# 113	Stil R Net	Stillaguamish R Net
# 114	Snoh R Net	Snohomish R Net
# 115	Ar 8-2 Spt	WA Area 8.2 Sport (Everett)
# 116	Stil R Spt	Stillaguamish R Sport
# 117	Snoh R Spt	Snohomish R Sport
# 118	Ar 10  Spt	WA Area 10 Sport (Seattle)
# 119	Ar10 NetNT	WA Area 10 Non-Treaty Net (Seattle)
# 120	Ar10 NetTR	WA Area 10 Treaty Net (Seattle)
# 121	Ar10ANetNT	WA Area 10A Non-Treaty Net (Elliott Bay)
# 122	Ar10ANetTR	WA Area 10A Treaty Net (Elliott Bay)
# 123	Ar10ENetNT	WA Area 10E Non-Treaty Net (East Kitsap)
# 124	Ar10ENetTR	WA Area 10E Treaty Net (East Kitsap)
# 125	10F-G  Net	WA Area 10F-G Treaty Net (Lake Union)
# 126	Duwm R Net	Green/Duwamish R Net
# 127	Duwm R Spt	Green/Duwamish R Sport
# 128	L WaSm Spt	Lk Wash/Sammamish/Tribs Spt
# 129	Ar 11  Spt	WA Area 11 Sport (Tacoma)
# 130	Ar11 NetNT	WA Area 11 Non-Treaty Net (E/W Pass)
# 131	Ar11 NetTR	WA Area 11 Treaty Net (E/W Pass)
# 132	Ar11ANetNT	WA Area 11A Non-Treaty Net (Comm. Bay)
# 133	Ar11ANetTR	WA Area 11A Treaty Net (Comm. Bay)
# 134	Puyl R Net	Puyallup R Net
# 135	Puyl R Spt	Puyallup R Sport
# 136	Ar 13  Spt	WAArea 13 Marine Sport
# 137	Ar13 NetNT	Area 13 Non-Treaty Net (So Puget Sound)
# 138	Ar13 NetTR	Area 13 Treaty Net (So Puget Sound)
# 139	Ar13CNetNT	Area 13C Non-Treaty Net (Chambers Bay)
# 140	Ar13CNetTR	Area 13C Treaty Net (Chambers Bay)
# 141	Ar13ANetNT	Area 13A Non-Treaty Net (Carr Inlet)
# 142	Ar13ANetTR	Area 13A Treaty Net (Carr Inlet)
# 143	Ar13DNetNT	Area 13D Non-Treaty Net
# 144	Ar13DNetTR	Area 13D Treaty Net
# 145	A13FKNetNT	Area 13F-13K Non-Treaty Net
# 146	A13FKNetTR	Area 13F-13K Treaty Net
# 147	Nisq R Net	Nisqually R Net
# 148	McAlls Net	McAllister Creek Net
# 149	13D-K TSpt	13D-13K Trib Sport
# 150	Nisq R Spt	Nisqually R Sport
# 151	Desc R Spt	Deschutes R Sport
# 152	Ar 12  Spt	Area 12 Marine Sport
# 153	1212BNetNT	Area 12-12B Hood Canal Non-Treaty Net
# 154	1212BNetTR	Area 12-12B Hood Canal Treaty Net
# 155	A9-9ANetNT	Area 9/9A Non-Treaty Net
# 156	A9-9ANetTR	Area 9/9A Treaty Net (On Res)
# 157	Ar12ANetNT	Area 12A Non-Treaty Net (Quilcene Bay)
# 158	Ar12ANetTR	Area 12A Treaty Net (Quilcene Bay)
# 159	A12CDNetNT	Area 12C-12D Non-Treaty Net (SE Hood Canal)
# 160	A12CDNetTR	Area 12C-12D Treaty Net (SE Hood Canal)
# 161	Skok R Net	Skokomish R Net
# 162	Quilcn Net	Quilcene R Net
# 163	1212B TSpt	12, 12B Trib FW Sport
# 164	12A Tb Spt	12A Trib FW Sport
# 165	12C-D TSpt	12C, 12D Trib FW Sport
# 166	Skok R Spt	Skokomish R Sport

    ),
    comment = "") |> 
  drop_na(FisheryID)

```

### British Columbia

```{r rmis_rr_lu_BC, eval=FALSE}
#possible BC to assign
select(rmis_rr, 1:16) |> filter(rlsp=="2") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)
select(rmis_rr, 1:16) |> filter(rlsp=="2", f_type != "escp") |> count(recovery_location_code, recovery_location_name, rlrgn, rlarea, rllocn, f_type) |> arrange(desc(n)) |>  print(n=100)

rmis_rr_lu |> 
  mutate(
    FisheryID = case_when(
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "01" & f_type == "troll" ~ 174, #NW VI Trl
      rlsp == "2" & rlwtr == "M" & rlsctr == "S" & rlrgn == "02" & f_type == "troll" ~ 175 #SW VI Trl

    ),
    comment = "")
```

### Alaska

## testing

```{r }
#currently mapped FRAM fishery recoveries
y <- inner_join(
  rmis_rr_lu_wa |> select(FisheryID, recovery_location_code, rlsp:gear),
  rmis_rr |> select(1:25, FisheryID_ahb = FisheryID, FisheryName_ahb = FisheryName), 
  by = c('recovery_location_code', 'rlsp', 'rlwtr', 'rlsctr', 'rlrgn', 'rlarea', 'rllocn', 'rlsubl', 'fishery', 'gear')
) |> left_join(fram_fishery, by = "FisheryID")

y |> count(FisheryID, FisheryName) |> ggplot(aes(paste(FisheryID, FisheryName, sep = ":"), n)) + geom_col() + coord_flip()

y |> count(FisheryID, FisheryName, release_location_rmis_region) |> 
  ggplot(aes(paste(FisheryID, FisheryName, sep = ":"), n, fill = release_location_rmis_region)) + geom_col() + coord_flip()

y |> 
  unite("rel_st_reg_bsn", c(release_location_state, release_location_rmis_region, release_location_rmis_basin)) |> 
  count(FisheryID, FisheryName, run_year, rel_st_reg_bsn) |> 
  filter(FisheryID %in% c(91), n > 5) |> 
  ggplot(aes(run_year, n, color = rel_st_reg_bsn, fill = rel_st_reg_bsn)) + 
  geom_col() +
  facet_wrap(~FisheryID, scales = "free_y")

# #check for linear declines in number of recoveries by release region
# #this is probably not helpful, see below for normalized to pct of recoveries within fishery by year
# #also probably statistically dubious to OLS regress a count response on year...
# y_lm_yr <- y |> 
#   unite("rel_st_reg", c(release_location_state, release_location_rmis_region)) |> 
#   count(FisheryID, FisheryName, run_year, rel_st_reg) |> 
#   filter(FisheryID %in% c(91)) |> 
#   filter(n > 4) |> 
#   nest_by(FisheryID, FisheryName, rel_st_reg) |>
#   filter(nrow(data) > 2) |> 
#   mutate(lm = list(lm(n ~ run_year, data = data))) |> 
#   summarise(broom::tidy(lm)) |>
#   filter(term=="run_year") |> 
#   mutate(p.value = round(p.value, 4)) |> 
#   arrange(p.value)
# 
# y_lm_yr |> filter(p.value < 0.15)
# y_lm_yr |> filter(estimate > 0)
# 
# y |> 
#   unite("rel_st_reg", c(release_location_state, release_location_rmis_region)) |> 
#   count(FisheryID, FisheryName, run_year, rel_st_reg) |> 
#   filter(FisheryID %in% c(91)) |> 
#   filter(n > 4) |> 
#   filter(rel_st_reg %in% (y_lm_yr |> filter(p.value < 0.15) |> pluck("rel_st_reg"))) |> 
#   ggplot(aes(run_year, n, color = rel_st_reg, fill = rel_st_reg)) + 
#   geom_col(show.legend = F) +
#   geom_smooth(color=1, se=F, method = "lm", show.legend = F) +
#   #geom_text(aes(label=paste("lm pval =", p.value)), data = y_lm_yr, x = 1998, y = 400, color = 1) +
#   geom_text(aes(label=paste("lm pval =", p.value)), data = y_lm_yr |> filter(p.value < 0.15), x = 1998, y = 400, color = 1) +
#   facet_wrap(~FisheryID+FisheryName+rel_st_reg, scales = "fixed", labeller = label_wrap_gen(multi_line = F))
  
#better: normalize to percentage of recoveries within year

ypct <- y |> 
  unite("rel_st_reg", c(release_location_state, release_location_rmis_region)) |> 
  count(FisheryID, FisheryName, run_year, rel_st_reg) |> 
  group_by(FisheryID, run_year) |> 
  mutate(n_pct = n / sum(n)) |> 
  ungroup()

ypct_lm_yr <- ypct |> 
# #  filter(n > 4) |> #min recs per regions per year per fishery
#   filter(FisheryID %in% c(91)) |> 
  nest_by(FisheryID, FisheryName, rel_st_reg) |>
  filter(nrow(data) > 2) |> #min years with some recoveries
  mutate(lm = list(lm(n_pct ~ run_year, data = data))) |> 
  summarise(broom::tidy(lm), .groups = "drop") |>
  filter(term=="run_year") |> 
  mutate(p.value = round(p.value, 4)) |> 
  arrange(p.value)

(
  ypct |>   
    filter(FisheryID %in% c(91)) |> 
    group_by(FisheryID, FisheryName, run_year) |> 
    summarise(total_recoveries = sum(n), .groups = "drop") %>% 
    {
    ggplot(., aes(run_year, total_recoveries)) + geom_col() +
    labs(title = paste("Coho FRAM", .$FisheryID[1], .$FisheryName[1]))
    }
) + (
  ypct |>   
    filter(FisheryID %in% c(91)) |> 
    filter(rel_st_reg %in% (ypct_lm_yr |> filter(FisheryID %in% c(91)) |> filter(p.value < 0.15) |> pluck("rel_st_reg"))) |> 
    ggplot(aes(run_year, n_pct, color = rel_st_reg, fill = rel_st_reg)) + 
    geom_col(show.legend = F) +
    geom_smooth(color=1, se=F, method = "lm", show.legend = F) +
    scale_y_continuous("per-year % of recoveries in fishery", labels = scales::percent) +
    #geom_text(aes(label=paste("lm pval =", p.value)), data = ypct_lm_yr, x = 1998, y = 400, color = 1) +
    geom_text(aes(label=paste("lm pval =", p.value)), data = ypct_lm_yr |> filter(FisheryID %in% c(91)) |> filter(p.value < 0.15), x = 1998, y = 0.5, color = 1) +
    facet_wrap(~FisheryID+rel_st_reg, scales = "fixed", labeller = label_wrap_gen(multi_line = F)) +
    labs(
      title = "Change in annual percentage of fishery recoveries by RMIS release region", 
      subtitle = "showing regions with significant OLS linear regression: pct ~ run_year"
    )
) + plot_layout(nrow = 2, heights = c(1,4))

#on an all-FisheryID version of the object...
ypct_lm_yr |> 
  filter(p.value < 0.15) |> 
  filter(FisheryID %in% c(33, 37, 40, 41, 48, 91, 92, 93)) |> 
  ggplot(aes(rel_st_reg, estimate, color = estimate > 0)) +
  geom_point(show.legend = F) + 
  geom_linerange(aes(ymin = estimate - std.error, ymax = estimate + std.error), show.legend = F) +
  geom_hline(yintercept = 0) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous("lm reg slope estimate: pct ~ year") +
  scale_color_manual(values = c("gold", "purple")) +
  facet_wrap(~FisheryID+FisheryName, scales = "free", labeller = label_wrap_gen(multi_line = F), ncol = 2)

```

# AHB fishmap

```{r rmis_rr_ahb_map}

#!! Note confusion on AK fisheries
#!! CoTC post-season only includes up to 198 in Fishery table
#!! AHB mapping goes up to 205
#!! but doesn't align with recovery_location_name and/or "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/1989LocationsSchema.pdf"
#!! for example, FRAM FID 198 is
#!!   "SW AK NET" in AHB mapping, but "Southeast Alaska Net" in CoTC Fishery table
#!!   and AHB mapping associates 198 to 1M1SW, but 1M1 is listed as Southeast in 1989 spec, with "NW" referring to the NW quadrant of SEAK
#!! rmis_rr |> filter(recovery_location_code == "1M1NW")
#!! lu$ahb_fishmap |> filter(PSC_Code == "1M1NW")

#some direct matches, but cannot directly join on PSC_Code...have to use the Num_Chars field
#and/but that means using many possible lengths of recovery_location_code

#iterator over Num_chars...seems crazy inefficient? but it runs...
#and addition of uid in setup allows recombination
#BUT turns out it double maps ~5K rows

rmis_rr_ahb_map <- rmis_rr |> 
  select(uid, recovery_location_code, fishery) |> 
  mutate(fishery_single = floor(fishery/10)) 

rmis_rr_ahb_map <- map_df(
  sort(unique(lu$ahb_fishmap$Num_Chars)),
  ~inner_join(
    rmis_rr_ahb_map |> 
      mutate(PSC_Code = str_sub(recovery_location_code, 1, .x))
    ,
    lu$ahb_fishmap |> filter(Num_Chars == .x)
    ,
    by = c("PSC_Code", "fishery_single")
  )
)

#some cases of same fishery from different n-chars being considered on same recovery_location_code
#some cases initially from simple row duplication in lookup, now fixed on read-in
overmapped <- rmis_rr_ahb_map |> count(uid) |> filter(n>1) |> select(uid)

# semi_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
#   count(recovery_location_code, fishery, fishery_single, PSC_Code, FisheryID, FisheryName, Num_Chars) |> 
#   writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/lu_ahb_fishmap_overmapped_qaqc.xlsx")

#now rejoin to full dataset, after making FisheryID distinct per UID
rmis_rr <- left_join(
  rmis_rr, 
  #split out multiple-mapped, make distinct per UID and rebind
  bind_rows(
    anti_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
      select(uid, FisheryID)
    ,
    semi_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
      group_by(uid) |> 
      slice_min(Num_Chars, n = 1, with_ties = F) |> 
      ungroup() |> 
      select(uid, FisheryID) #|> count(uid) |> filter(n>1)
  )
  ,
  by = "uid") |> 
  left_join(fram_fishery, by = "FisheryID")


# rmis_rr |> filter(FisheryID %in% 91:93) |> count(FisheryID)
# #exact match?!?!
# y |> filter(FisheryID %in% 91:93) |> count(FisheryID)
# 
# left_join(
#   y |> count(FisheryID),
#   rmis_rr_ahb_map |> count(FisheryID),
#   by = "FisheryID"
#   ) |> print(n=100)

```

# Preliminary psuedo-ER comparison

## Skagit test case

```{r skagit_stock_mapping_eda}
#95 tag codes associated with "SKAGIT R     03.0176"
#all release_location_name "CASCADE R    03.1411"
lu$cwt_stk |> filter(StockID %in% 17:24) |> count(StockID, Hatchery_Name, Stock_Name, Release_Name)

#mapped 1998-2020, order of magnitude more in 2003-2005, fairly consistent 2010-2020
rmis_rr |> 
#  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "SKAGIT R     03.0176")) |> #~77K recoveries, 22K fishery 55K escp
  left_join(lu$cwt_stk, by = c("run_year", "tag_code")) |> 
  #count(StockID) #~42K of 77K recoveries mapped, 11K non-escp
  drop_na(StockID) |> count(run_year) |> print(n=50) 

#could skip mapping and just use stock_location_name
#especially if focused on later years with all CASCADE R as release_location_name
#unassigned release_location_names appear to be pre-1998
rmis_rr |> 
#  filter(f_type != "escp") |> 
  filter(str_detect(stock_location_name, "SKAGIT R     03.0176")) |>
  filter(between(run_year, 1998, 2020)) |> 
  count(release_location_name) |> arrange(desc(n)) |> print(n=50)
  
rmis_rr |> filter(str_detect(release_location_name, "SKAGIT R TRIBS"))
```

Prototype using AHB fishery mapping and CCT stock mapping

```{r add_cct_stockID}
#now add StockIDs to dataset with FisheryID added above in "AHB fishmap"
rmis_rr <- rmis_rr |> left_join(lu$cwt_stk, by = c("run_year", "tag_code"))
```

```{r calc_rmis_pseudo_er}
#first is all rows, not using CCT StockID
#THIS UNMARKED RELEASE GROUPS cwt_1st_mark == "0000"
rmis_rr_skagit <- rmis_rr |> 
  filter(
    str_detect(stock_location_name, "SKAGIT R     03.0176"),
    age == 3,
    !str_detect(release_location_name, "BAKER")
    ) |> 
  #count(stock_location_name, f_type)
  #count(StockID, f_type)
  #count(FisheryID) |> arrange(desc(n)) |> print(n=100)
  drop_na(estimated_number) |>  #only drops a few from 75849 to 75715
  group_by(
    run_year,
    #starts_with("release_location_"),
    #starts_with("recovery_location_"), 
    stock_location_name,
    f_type, FisheryID, FisheryName
    ) |> 
  summarise(across(estimated_number, sum), .groups = "drop") |> 
  group_by(run_year, stock_location_name) |> 
  mutate(est_num_tot_yr = sum(estimated_number)) |> ungroup() |> 
  mutate(er = estimated_number / est_num_tot_yr)

#limited to only those assigned by CCT
#mostly marked releases, but looks to still be a few with cwt_1st_mark == "0000"
#possibly due to CCT analysis of mark rates on releases external to RMIS
rmis_rr_skagit_cct <- rmis_rr |> 
  filter(
    str_detect(stock_location_name, "SKAGIT R     03.0176"),
    age == 3,
    !str_detect(release_location_name, "BAKER")
    ) |> 
  drop_na(estimated_number, StockID) |>
  group_by(run_year, StockID, f_type, FisheryID, FisheryName) |> 
  summarise(across(estimated_number, sum), .groups = "drop") |> 
  group_by(run_year, StockID) |> 
  mutate(est_num_tot_yr = sum(estimated_number)) |> 
  ungroup() |> 
  mutate(er = estimated_number / est_num_tot_yr)


# rmis_rr_skagit |> filter(f_type=="escp") |> print(n=50)
# rmis_rr_skagit_cct |> filter(f_type=="escp")

```

```{r calc_postseason_fram_pseudo_er}
fram <- list()
focal_run_ids <- 34:44 #2010:2020
focal_stock_ids <- 17:20
fram$escp <- framr::read_coho_escp(fp$mdb_pst, runs = focal_run_ids, stocks = focal_stock_ids)
fram$mort <- framr::read_coho_mort(fp$mdb_pst, runs = focal_run_ids, stocks = focal_stock_ids)

#initially focusing on landed mort only
fram_lc_er_skagit <- left_join(
  fram$mort |>
    group_by(RunYear, StockID, StockLongName, FisheryID, FisheryName) |> 
    summarise(
      across(c(LandedCatch, MSFLandedCatch), sum),
      lc_yr = LandedCatch + MSFLandedCatch, .groups = "drop") |> 
    group_by(RunYear, StockID, StockLongName) |> 
    mutate(across(lc_yr, list(sum = sum), .names = "{.col}_{.fn}")) |> 
    ungroup()
  ,
  fram$escp |> 
    group_by(RunYear, StockID) |> 
    summarise(across(escp, sum), .groups = "drop") 
  ,
  by = c("RunYear", "StockID")
) |>
  mutate(
    run_year = as.integer(RunYear), RunYear = NULL,
    abund = lc_yr_sum + escp,
    across(c(lc_yr, lc_yr_sum), list(er = ~.x/abund))
  ) |> 
  select(run_year, everything())

```

```{r}
# #if preserving stock_location_name & StockID in initial group_by, duplication from StockID being both assigned (to 18) and NA for many post-1998 run_year-FisheryID combinations
# rmis_rr_skagit |> count(stock_location_name, f_type, FisheryID, FisheryName, run_year) |> filter(n > 1L) 
# rmis_rr_skagit |> filter(is.na(FisheryID), run_year == 1998) #example with NA FisheryID
# rmis_rr_skagit |> filter(FisheryID==81, run_year == 2001) #

rmis_rr_skagit |> 
  select(run_year, stock_location_name, f_type, FisheryID, FisheryName, er) |> 
  # #pivot_wider(names_from = run_year, values_from = er) |> arrange(FisheryID) |> print(n=100)
  ## "quasi ER by recovery type"
  # group_by(run_year, stock_location_name, f_type) |> summarise(across(er, sum), .groups = "drop") |> 
  # ggplot(aes(run_year, f_type, fill = er)) +
  # geom_tile()
  
  drop_na(f_type) |> #filter(is.na(f_type)) #drop a few insignificant year-recovery groups with RMIS fishery outside f_type ranges
  mutate(
    FisheryID = if_else(f_type=="escp", 0, FisheryID),
    fidnm = paste(FisheryID, FisheryName, sep = ":") |> fct_reorder(.x = FisheryID, .fun = min)
    ) |> 
  ggplot(aes(run_year, fidnm, fill = er)) +
  geom_tile() 

rmis_rr_skagit_cct |> 
  select(run_year, StockID, f_type, FisheryID, FisheryName, er) |> 
  pivot_wider(names_from = run_year, values_from = er) |> arrange(FisheryID) |> print(n=100)


#only StockID 18 wild marked in CCT mapping
#which is not present in CoTC FRAM, so compare to hatchery marked? StockID 20
#differencing convention is positive when FRAM-based LC ER > RMIS-based [fishery recs]/[fishery + escapement recs]  
fram_rmis <- left_join(
  fram_lc_er_skagit |> filter(StockID==20),
  rmis_rr_skagit_cct |> 
    select(run_year, StockID, f_type, FisheryID, FisheryName, er) |> 
    mutate(StockID=20),
  by = c("run_year", "StockID", "FisheryID", "FisheryName")
) |> 
  mutate(fram_rmis = lc_yr_er - er) 

fram_rmis |> count(FisheryID)
fram_rmis |> count(is.na(fram_rmis))

fram_rmis |>
  drop_na(er) |> 
  ggplot(aes(fct_reorder(paste(FisheryID, FisheryName), fram_rmis), fram_rmis)) +
  geom_boxplot(outlier.shape = NA) +
  geom_text(aes(label = run_year), size = 2, position = "jitter", alpha = 0.4) +
  coord_flip()

fram_rmis |> 
  drop_na(er) |> 
  filter(FisheryID %in% c(91, 103, 108)) |> 
  ggplot(aes(factor(run_year), fram_rmis)) +
  geom_col() +
  facet_wrap(~FisheryID+FisheryName, labeller = label_wrap_gen(multi_line = F))


fram_rmis |> drop_na(er) |> filter(run_year==2019) |> arrange(desc(fram_rmis))
fram_rmis |> filter(run_year==2019) |> arrange(desc(lc_yr_er))
fram_lc_er_skagit |> 
  group_by(StockID, FisheryID, FisheryName) |> 
  summarise(across(lc_yr_er, mean), .groups = "drop") |> 
  pivot_wider(names_from = StockID, values_from = lc_yr_er) |> 
  arrange(desc(`20`)) |> print(n=20)

#above ypct_lm in "testing" indicates releases from WA_SKAG make up signif lower % of recs in A5
#would seem to suggest that FRAM impacts could be over-estimated? (since more Skagit tags during BP years)
#but on avg 2010-2019 appears that RMIS rate is higher in this very rough/prelim comparison between {post-season LC/(LC+escp)} and {fishery/(fishery+escapement)}
fram_rmis |> 
  filter(FisheryID %in% c(91, 103, 108, 190)) |> 
  select(run_year, FisheryID, FisheryName, fram = lc_yr_er, rmis = er) |> pivot_longer(cols = c(fram, rmis)) |> 
  ggplot(aes(run_year, value, color = name, fill = name)) +
  geom_col(position = "dodge") +
  scale_x_continuous(breaks = 2010:2020) +
  stat_smooth(method="lm", formula=y~1, se=FALSE) +
  facet_wrap(~FisheryID+FisheryName, labeller = label_wrap_gen(multi_line = F))


#could/should compare using all recoveries from Skagit stock rather than only those CCT mapped?
fram_rmis <- left_join(
  fram_lc_er_skagit |> filter(StockID==20),
  rmis_rr_skagit |> 
    select(run_year, stock_location_name, f_type, FisheryID, FisheryName, er) |> 
    mutate(StockID=20),
  by = c("run_year", "StockID", "FisheryID", "FisheryName")
  ) |> 
  mutate(fram_rmis = lc_yr_er - er) 


```

## Multistock

Generalizing above to a few more well-represented units

```{r fram_lc_er}
#rmis_rr |> drop_na(StockID) |> count(StockID) |> arrange(desc(n))

fram <- list()
focal_run_ids <- 34:44 #2010:2020
focal_stock_ids <- c(20, 96, 164, 166, 176) #Skagit, Green, Willapa, Columbia Early, Columbia Late
fram$escp <- framr::read_coho_escp(fp$mdb_pst, runs = focal_run_ids, stocks = focal_stock_ids)
fram$mort <- framr::read_coho_mort(fp$mdb_pst, runs = focal_run_ids, stocks = focal_stock_ids)

#initially focusing on landed mort only
fram_lc_er <- left_join(
  fram$mort |>
    group_by(RunYear, StockID, StockLongName, FisheryID, FisheryName) |> 
    summarise(
      across(c(LandedCatch, MSFLandedCatch), sum),
      lc_yr = LandedCatch + MSFLandedCatch, .groups = "drop") |> 
    group_by(RunYear, StockID, StockLongName) |> 
    mutate(across(lc_yr, list(sum = sum), .names = "{.col}_{.fn}")) |> 
    ungroup()
  ,
  fram$escp |> 
    group_by(RunYear, StockID) |> 
    summarise(across(escp, sum), .groups = "drop") 
  ,
  by = c("RunYear", "StockID")
) |>
  mutate(
    run_year = as.integer(RunYear), RunYear = NULL,
    abund = lc_yr_sum + escp,
    across(c(lc_yr, lc_yr_sum), list(er = ~.x/abund))
  ) |> 
  select(run_year, everything())
```

```{r fram_rmis}
#fram object has many more year-stock-fishery levels present than rmis
#this does not yet drop repeat cols of year-stock total landed catch, escapement, abundance and total er
#important cols are 
# - lc_yr: per year-stock, the sum over timesteps and NS/MSF landed catch for a FRAM fishery
# - lc_yr_er: the fishery-specific FRAM "landed ER"
# - pseudo_er: the fishery-specific RMIS "pseudo-ER" of (fishery recoveries)/(all recoveries incl escapement)
# - fram_rmis: the difference of FRAM - RMIS

fram_rmis <- left_join(
  fram_lc_er
  ,
  rmis_rr |> 
    filter(age == 3) |> 
    drop_na(estimated_number, StockID) |>
    mutate(StockID = if_else(StockID == 18, 20, StockID)) |> 
    group_by(run_year, StockID, f_type, FisheryID, FisheryName) |> 
    summarise(across(estimated_number, sum), .groups = "drop") |> 
    group_by(run_year, StockID) |> 
    mutate(est_num_tot_yr = sum(estimated_number)) |> ungroup() |> 
    mutate(pseudo_er = estimated_number / est_num_tot_yr) |> 
    select(run_year, StockID, f_type, FisheryID, FisheryName, pseudo_er)
  ,
  by = c("run_year", "StockID", "FisheryID", "FisheryName")
) |> 
  mutate(fram_rmis = lc_yr_er - pseudo_er) 

```

```{r fram_rmis_diff_boxplots}
fram_rmis |> 
  drop_na(pseudo_er) |> 
  mutate(fidnm = paste(FisheryID, FisheryName, sep = ":") |> fct_reorder(.x = FisheryID, .fun = min)) |> 
  ggplot(aes(fidnm, fram_rmis)) +
  geom_boxplot(outlier.shape = NA) +
  geom_text(aes(label = run_year), size = 2, position = "jitter", alpha = 0.4) +
  coord_flip() +
  facet_wrap(~StockID+StockLongName, scales = "free_y", labeller = label_wrap_gen(multi_line = F), ncol = 1)

```

```{r}
fram_rmis |> 
  drop_na(pseudo_er) |> 
  mutate(
    fidnm = paste(FisheryID, FisheryName, sep = ":") |> fct_reorder(.x = FisheryID, .fun = min),
    sidnm = paste(StockID, StockLongName, sep = ":") |> fct_reorder(.x = StockID, .fun = min)
    ) |> 
  group_by(sidnm, fidnm) |> 
  summarise(across(c(lc_yr_er, pseudo_er, fram_rmis), list(mean=mean)), .groups = "drop") |> 
  filter(abs(fram_rmis_mean)> 0.01) |> 
  ggplot(aes(fidnm, fram_rmis_mean, fill = fram_rmis_mean > 0)) +
  geom_col(show.legend = F) +
  scale_fill_manual(values = c("purple", "gold")) +
  facet_wrap(~sidnm, scales = "free_x", ncol=1) +
  labs(
    title = "Mean 2010-2020 CoTC post-season FRAM - RMIS pseudo ERs",
    subtitle = "gold/above 0: FRAM landed/(landed+escp) > RMIS fishery/(fishery+escp)"
    
  )

```

```{r}
fram_rmis |> 
  drop_na(pseudo_er) |> 
  mutate(
    fidnm = paste(FisheryID, FisheryName, sep = ":") |> fct_reorder(.x = FisheryID, .fun = min),
    sidnm = paste(StockID, StockLongName, sep = ":") |> fct_reorder(.x = StockID, .fun = min)
    ) |> 
  group_by(sidnm) |> 
  slice_min(order_by = fram_rmis, n = 5, with_ties = F) |> ungroup() |> 
#  filter(FisheryID %in% c(91, 103, 108, 190)) |> 
  select(run_year, sidnm, fidnm, fram = lc_yr_er, rmis = pseudo_er) |> pivot_longer(cols = c(fram, rmis)) |> 
  ggplot(aes(run_year, value, color = name, fill = name)) +
  geom_col(position = "dodge") +
  scale_x_continuous(breaks = 2010:2020) +
  stat_smooth(method="lm", formula=y~1, se=FALSE) +
  facet_grid(rows = vars(fidnm), cols = vars(sidnm), labeller = label_wrap_gen(multi_line = F))

```


# Task Overview Apr22

## compare escapement ratios

escp:catch or escp/abund in BKFRAM vs escp:catch in RMIS


## missing Canadian escapements

assess utility of 2022-02-23 StAD Escapement Report_Coho_EPAD.xlsx

```{r}
stad <- readxl::read_xlsx(
  "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/2022-02-23 StAD Escapement Report_Coho_EPAD.xlsx",
  #sheet = "Observed Tagcodes"
  sheet = "Obs-Est-Exp"
  )

distinct(rmis_rr, tag_code) #12936

# ## for sheet "Observed Tagcodes"
# #distinct(stad, TAGCODE) #365 for
# length(intersect(rmis_rr$tag_code, stad$TAGCODE)) / 365
# inner_join(
#   rmis_rr, 
#   stad |> select(tag_code = TAGCODE), 
#   by = c("tag_code")
#   ) |> 
#   count(f_type)

## for sheet "Obs-Est-Exp"
#distinct(stad, Tagcode) #385
length(intersect(rmis_rr$tag_code, stad$Tagcode)) / 385

inner_join(
  rmis_rr, 
  stad |> select(tag_code = Tagcode, recovery_location_code = `PSC Location Code`), 
  #by = c("tag_code") #~59K 
  by = c("tag_code", "recovery_location_code") #0 rows where a shared tag_code also shared the rec_loc_code
  ) |> 
  count(f_type)

#next is to add 3yo for shared tag_codes
#need to continue cross-referencing fields 
rmis_rr |> 
  bind_rows(
    stad |> 
      mutate(age = `Recovery Year` - `Brood Year`) |> #count(age)
      filter(
        age == 3,
        Tagcode %in% unique(rmis_rr$tag_code)
      ) |>
      mutate(
        fishery = 50
      ) |> 
      select(
        tag_code = Tagcode, 
        recovery_location_code = `PSC Location Code`,
        run_year = `Recovery Year`,
        brood_year = `Brood Year`,
        fishery
        #etc....
      )
  )
    

```

## Impute missing freshwater sport recoveries

calculate based on FRAM info

# Initial look at recovery patterns in RMIS-based units

## Recoveries by release state

Totals by year, needs further stratification. Note highly varied y-axis as currently written.

```{r rec_by_rel_state}
rmis_rr |> 
  count(run_year, release_location_state) |> #release_location_rmis_region
  ggplot(aes(run_year, n, fill = release_location_state)) + 
  geom_col(show.legend = F) +
  facet_wrap(~release_location_state, ncol = 1, scales = "free")

  #filter(as.numeric(cwt_1st_mark) < 5000) 
```

## Recoveries by release region, all

Including escapement

```{r relregn_raster_with_escp}
rmis_rr |> 
  count(run_year, f_type, release_location_rmis_region) |>
  filter(!is.na(f_type)) |> 
  ggplot(aes(run_year, release_location_rmis_region, fill = n)) + 
  geom_raster(show.legend = T) +
  wacolors::scale_fill_wa_c("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Key fisheries only...

```{r relregn_raster_net_trl_spt}
rmis_rr |> 
  filter(f_type %in% c("net", "troll", "sport")) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, release_location_rmis_region, fill = n)) + 
  geom_raster(show.legend = T) +
  wacolors::scale_fill_wa_c("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Same as above as lines

```{r relregn_lines_net_trl_spt}
#lines n-recs region (line color) by year
rmis_rr |> 
  filter(f_type %in% c("net", "troll", "sport")) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, n, color = release_location_rmis_region)) + 
  geom_line(show.legend = T) +
  #wacolors::scale_fill_wa_d("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Lines for PS releases only, facet by f_type

```{r relregn_lines_net_trl_spt_ps}
#split by ps release regions
rmis_rr |> 
  filter(
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region %in% regions$ps
    ) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, n, color = release_location_rmis_region)) + 
  geom_line(show.legend = T) +
  wacolors::scale_fill_wa_d("rainier", reverse = T) +
  facet_wrap(~f_type, ncol = 1)
```

Same as above, aggregating over regions within PS

```{r relregn_lines_net_trl_spt}
#aggregate by ps_release region, f_type color
rmis_rr |> 
  filter(
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region %in% regions$ps
    ) |> 
  count(run_year, f_type) |>
  ggplot(aes(run_year, n, color = f_type)) + 
  geom_line(show.legend = T) +
  facet_wrap(~f_type, ncol = 1)
```

Comparing categorical time periods (fishery recoveries by rel_region)

```{r comp_time_fishery_rec}
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport")
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, f_type, release_location_rmis_region) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  filter(year_block != "93-09") |> 
  ggplot(aes(release_location_rmis_region, n, fill = year_block)) +
  geom_col(position = position_dodge()) + coord_flip() +
  facet_wrap(~f_type, scales = "free", ncol = 1)
```

No ColR, time period comp by release "state" including BC

```{r comp_time_fishery_rec_no_ColR}
#comparing time periods of recoveries in fisheries, excluding ColR releases
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport"),
    !(release_location_rmis_region %in% regions$col_riv)
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, release_location_state) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  filter(year_block != "93-09", release_location_state %in% c("BC", "OR", "WA")) |> 
  ggplot(aes(release_location_state, n, fill = year_block)) +
  geom_col(position = position_dodge())
```

Drill down to examine just Fraser R releases

```{r comp_time_fishery_rec_fraser}
#very little to work with in recent years...
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region == "FRTH"
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, release_location_rmis_basin) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  ggplot(aes(release_location_rmis_basin, n, fill = year_block)) +
  geom_col(position = position_dodge())

rmis_rr |> 
  filter(release_location_rmis_basin == "LOFR", !is.na(f_type)) |> 
  count(run_year, f_type) |> 
  ggplot(aes(run_year, n, fill = f_type)) +
  geom_col(position = position_dodge())

rmis_rr |> 
  filter(release_location_rmis_basin == "LOFR", f_type == "sport") |> 
  count(run_year, rlsp) |> 
  ggplot(aes(run_year, n, fill = rlsp)) +
  geom_col(position = position_dodge())
```

## NEXT: look for release region with adequate recoveries both time blocks. Focus on fishery recoveries assuming that escp recs probably ok if fishery ok

```{r}
rmis_rr |> 
  distinct(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  arrange(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  #split(~release_location_state) 
  filter(release_location_state == "WA") |> print(n=50)
  


rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport")
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19"))
    )


```

## trial dummy with prelim MSM mapped 

```{r}
#trial dummy example
mpdrec <- readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MappedRecoveries.xlsx", sheet = "MappedRecoveries")

mpdrec |>
  ggplot(aes(RunYear)) +
  geom_bar()
#equivalently...
mpdrec |>
  count(RunYear) |> 
  ggplot(aes(RunYear, n)) +
  geom_col()


#all recoveries
mpdrec |>
  ggplot(aes(factor(RunYear), factor(PrNum))) +
  geom_bin2d()

#all non-escapement recoveries
mpdrec |>
  filter(MSMFishCode != 228) |> 
  ggplot(aes(factor(RunYear), factor(PrNum))) +
  geom_bin2d() +
  scale_fill_distiller(direction = 1)

```

## PR by year

## PR_MU by year


