---
title: "Coho CWT FRAM & MSM Analysis"
author: "Dan.Auerbach@dfw.wa.gov, Angelika.Hagen-Breaux@dfw.wa.gov, carrie_cook-tabor@fws.gov"
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  bookdown::html_document2:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
---

```{r setup, results = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9)

library("tidyverse")
library("gt")
library("odbc"); library("DBI")
#library("ggridges")

dir_proj <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis"

fp <- list(
  rmis_recs = file.path(dir_proj, "rmis_coho_recoveries_86_2020.rds"),
  rmis_rel = file.path(dir_proj, "rmis_coho_releases_for_rec_86_2020.rds"),
  rmis_rec_rel = file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds")
  )

rmis_rr <- readRDS(fp$rmis_rec_rel) |> 
  filter(!is.na(release_location_state)) |>  #drop 3 recent
  mutate(age = run_year - brood_year)

regions <- list(
  col_riv = c("CECR", "CRGN", "LOCR", "UPCR"),
  ps = c("SPS", "MPS", "NPS", "HOOD", "JUAN", "SKAG", "NOWA"),
  wa_cst = c("NWC", "GRAY", "WAGN", "WILP")
)

rgns <- map_df(regions, ~paste0(.x, collapse =",")) |> 
  pivot_longer(names_to = "rgn", values_to = "release_location_rmis_region", everything()) |> 
  separate_rows(release_location_rmis_region)



lu <- list(
  #CCT queried releases, QAQC'd and assigned to PR and PR_MU
  cwt_stk = read_csv(file.path(dir_proj, "MSMDB/MSM_Stock_CWT2.csv")) |> 
    mutate(run_year = Run_ID+1985) |> 
    select(run_year, tag_code = CWT_Code, area = Area_Agg,
           pr = PR_Number, pr_mu = PR_MU_Number, n_rel = Number_Released, everything()) |> 
    filter(!is.na(pr), !is.na(pr_mu), pr_mu > 0) |> 
    #exclude a double-mapped row
    filter(!(run_year == 1996 & tag_code == "071544" & FRAMStkID == 166))
  ,
  #DA incomplete rel state/region/basin to pr/pr_mu/StockID
  rmis_rgn_stkid = readxl::read_excel(file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx"))
)

# #key dbs
# "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MSM_86-91_Oct2006.mdb"
# "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MSM_98-2020- SF2019.mdb"


```

# Summary

This script analyzes coho coded wire tag (CWT) recoveries (and associated releases) reported in RMIS.

# Data

## RMIS LUs

```{r rmis_lu_downloads, eval=FALSE}
# walk(
#   c("https://www.rmpc.org/data/fishery.csv", "https://www.rmpc.org/data/gear.csv"), #others for various fields... 
# ~.x |> download.file(destfile = paste0("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_", basename(.x)))
# )

#DA added into "rmis_loc_fram_fishery.xlsx"

## All release locations, could be used to supplement CCT cwt_stk...
# download.file(
#   "https://www.rmpc.org/data/RL041_ALL_FULLSET.csv",
#   "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_rel_loc_all.csv"
#   )

read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_rel_loc_all.csv")

```

## RMIS wrangling

These chunks preserve one-time operations to generate starting datasets from RMIS.

```{r read_in_rmis_recoveries, eval=FALSE}
dir_rmis_recs <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/RMISRecoveries/"

focal_cols_recs <- c("recovery_id", "tag_code", "run_year", "recovery_location_code", "recovery_location_name", "fishery", "gear", "estimated_number")

# rmis_recs <- purrr::map_dfr(
#   list.files(dir_rmis_recs, full.names = T)
#   ,
#   ~readr::read_csv(.x, col_select = all_of(focal_cols_recs))
#   )
# 
# saveRDS(rmis_recs, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_recoveries_86_2020.rds")

```

```{r get_releases_by_tag_code, eval=FALSE}
rmis_recs |> 
  mutate(year_set = if_else(run_year <= 1992, "86-92", "93-20")) |> 
  #distinct(year_set, tag_code) |> split(~year_set) |> 
  distinct(tag_code) |> rownames_to_column(var = "id") |> 
  mutate(
    id = as.numeric(id), 
    block = cut(id, breaks = c(seq(0,20000,by=2000))),
    block = letters[as.integer(block)]
    ) |> #count(block)
  split(~block) |> 
  writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx")

f <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx"

#readxl::read_excel(f, sheet = "a") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "b") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "c") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "d") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "e") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "f") |> pluck("tag_code") |> writeLines("clipboard")
#readxl::read_excel(f, sheet = "g") |> pluck("tag_code") |> writeLines("clipboard")

focal_cols_rel <- c("tag_code_or_release_id", "brood_year", "release_location_code", "hatchery_location_code", "stock_location_code", "release_location_name", "hatchery_location_name", "stock_location_name", "release_location_state", "release_location_rmis_region", "release_location_rmis_basin", "cwt_1st_mark", "cwt_1st_mark_count", "cwt_2nd_mark", "cwt_2nd_mark_count")

rmis_rel <- map_df(
  c(
  "https://www.rmis.org/reports/CSV13497.txt",
  "https://www.rmis.org/reports/CSV13656.txt",
  "https://www.rmis.org/reports/CSV13738.txt",
  "https://www.rmis.org/reports/CSV13814.txt",
  "https://www.rmis.org/reports/CSV13854.txt",
  "https://www.rmis.org/reports/CSV14030.txt",
  "https://www.rmis.org/reports/CSV14116.txt"
  ),
  ~read_csv(.x, col_select = all_of(focal_cols_rel)) |> 
    mutate(
      cwt_1st_mark = as.character(cwt_1st_mark),
      cwt_2nd_mark = as.character(cwt_2nd_mark)
      )
  )

#saveRDS(rmis_rel, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_releases_for_rec_86_2020.rds")

```

```{r build_rec_rel, eval=FALSE}

left_join(
  readRDS(fp$rmis_recs) |> 
    mutate(
      rl1 = str_sub(recovery_location_code, 1, 1),
      rl2 = str_sub(recovery_location_code, 2, 2),
      rl3 = str_sub(recovery_location_code, 3, 3),
      rl45 = str_sub(recovery_location_code, 4, 5),
      f_type = case_when(
        between(fishery, 10, 19) ~ "troll",
        between(fishery, 20, 39) ~ "net",
        between(fishery, 40, 49) ~ "sport",
        between(fishery, 50, 59) ~ "escp"
      )
    )
  ,
  readRDS(fp$rmis_rel) |> select(-contains("n_code")),
  by = c("tag_code" = "tag_code_or_release_id")
  ) ##|> saveRDS(file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"))

```

# Mapping

## stocks

Exporting a format for the needed lookup from RMIS release location fields (state, region, basin) and the MSM/FRAM production region and management units (PR and PR_MU), and thence to FRAM StockID(s). Some of this is already available in, for example, the escapement compilation template sheet?

The LU begun in from this first chunk was initiated but then paused due to existing CCT work in `lu$cwt_stk`

```{r lu_rmis_rel_to_pr_prmu_xlsx, eval=FALSE}

# rmis_rr |> 
#   distinct(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
#   arrange(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
#   mutate(pr = NA, pr_mu = NA, StockID = NA) |> 
##Manually modified, do not overwrite:  #writexl::write_xlsx(file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx"))


# #unused below...but considered in beginning of file.path(dir_proj, "lu_rmis_rel_to_pr_prmu.xlsx")
# readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Escapement files/Coho/fram_coho_escapement_2022.xlsx", sheet = "year_template") |> 
#   select(
#     MSM_PR = ProductionRegionNumber, 
#     MSM_PR_MU = ManagementUnitNumber,
#     RRTerm_PR, RRTerm_PR_MU, 
#     StockID, 
#     StockLongName, 
#     StockName
#     )

```

Examining `rmis_rr` against `lu$cwt_stk` mapping

```{r rmis_rr_cwt_stk, eval=FALSE}

#basically mapped for 1998 forward, presumably due to expectation that older are already mapped elsewhere in MSM?
lu$cwt_stk |> count(run_year) |> print(n=100)

distinct(rmis_rr, tag_code) #12936 releases
distinct(lu$cwt_stk, tag_code) #5491 mapped

length(setdiff(rmis_rr$tag_code, lu$cwt_stk$tag_code)) #7642 codes not mapped to PR...
length(setdiff(lu$cwt_stk$tag_code, rmis_rr$tag_code)) #oddballs, most of the mapped are in recs
#for example...
filter(lu$cwt_stk, tag_code == "180691*1")
#confirming that many 6-character, leading 0 codes are in recs...
rmis_rr |> filter(nchar(tag_code) <= 6, str_sub(tag_code, 1,1) == "0")
#but 5294 shared/mapped codes (recall dup run_year)
length(intersect(rmis_rr$tag_code, lu$cwt_stk$tag_code)) 

nrow(distinct(lu$cwt_stk, run_year, tag_code)) == nrow(lu$cwt_stk)
count(lu$cwt_stk, run_year, tag_code) |> filter(n>1)
# filter(lu$cwt_stk, run_year == 1996, tag_code == "071544")
# filter(lu$cwt_stk, Stock_Name == "TANNER CR (BNVILLE)") #released in multiple pr_mus
# filter(lu$cwt_stk, Release_Name == "YOUNGS R & BAY") #looks like it should be pr_mu==2


#rmis_rr |> left_join(lu$cwt_stk, by = c("run_year", "tag_code")) |> count(is.na(pr))

rmis_rr_cwt_stk <- inner_join(rmis_rr, lu$cwt_stk, by = c("run_year", "tag_code"))

rmis_rr_cwt_stk |> 
  #group_by(run_year, area) |> summarise()
  #count(run_year, area) |> ggplot(aes(run_year, n)) + geom_col() + facet_wrap(~area)
  count(run_year, pr) |> #pivot_wider(names_from = run_year, values_from = n) |> arrange(pr)
  ggplot(aes(run_year, n)) + geom_col() + facet_wrap(~pr)


```


## fishery

```{r pull_msm_edit_distinct, eval=FALSE}
#86-91, 92-97, 98-2020

db <- "C:/Users/auerbdaa/Downloads/MSM_98-2020- SF2019_cmpct.mdb"
#db <- fp$db_msm
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=", db, ";")
  )

msm_tbl_names <- c("Edit_Distinct")

msm_tbl <- map(set_names(msm_tbl_names), ~collect(tbl(db_con, .x)))

DBI::dbDisconnect(db_con)

msm_tbl$Edit_Distinct

```

```{r FishAggMap, eval=FALSE}
#AHB very coarse mapping  
read_csv(file.path(dir_proj, "MSMDB/FishAggMap.csv"))
```

```{r now_superseded_fram_fishery_rmis_loc, eval=FALSE}
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0(
    "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=",
    "O:/code/coho/fram_mdbs/PSC_CoTC_PostSeason_CohoFRAMDB_thru2020_021622.mdb",
    ";")
  )

fram_fishery <- tbl(db_con, "Fishery") |> 
  filter(Species == "COHO") |> 
  select(FisheryID:FisheryTitle) |> 
  collect()

DBI::dbDisconnect(db_con)

##Manually edited, no overwrite! writexl::write_xlsx(fram_fishery, "NOOVERWRITEfram_fishery_rmis_loc.xlsx")
#this file/approach superseded by below "rmis_loc_fram_fishery.xlsx"
```

```{r rec_location_code_init_EDA, eval=FALSE}
rmis_rr |> 
  filter(
    str_sub(recovery_location_code,1,3) == "6MO"
  ) |> 
  count(recovery_location_code) |> arrange(desc(n))

#38 distinct, vast majority in first 22
rmis_rr |> count(str_sub(recovery_location_code,1,3)) |> arrange(desc(n)) |> print(n=100)

#4989 distinct but only first ~2K matter
rmis_rr |> count(recovery_location_code) |> arrange(desc(n)) |> 
  rowid_to_column() |> ggplot(aes(rowid, n)) + geom_col()

#excluding escapement about ~4K, 
#with ~2K having more than 5 recs 
#and ~2.7K more than 5 incl escp
rmis_rr |> 
  filter(fishery < 50) |>
  count(recovery_location_code) |> arrange(desc(n)) |> 
  filter(n > 5) |> 
  rowid_to_column() |> ggplot(aes(rowid, n)) + geom_col()
```

```{r write_starting_rmis_loc_fram_fishery, eval=FALSE}
# rmis_rr |> 
#   count(
#     loc3 = str_sub(recovery_location_code,1,3),
#     recovery_location_code,
#     recovery_location_name,
#     fishery, gear
#     ) |> 
#   arrange(desc(n)) 
# ## DA began mapping to FRAM FisheryID
# ##  writexl::write_xlsx("NOOVERWRITErmis_loc_fram_fishery")


## DA began to build from PSC_V41_Specification.pdf, pg 49-60 
## realized this must exist already, searched, DL'd and added into workbook
# readxl::read_excel("rmis_loc_fram_fishery.xlsx", sheet = "rmis_lu_gear")


rmis_rr |> 
  count(rl1,rl2,rl3,rl45, fishery, gear, f_type) |> arrange(rl1, desc(n)) |> 
  mutate(
    rl1_desc = set_names(c("AK", "BC", "WA", "ID", "OR", "CA", "HS", "FR"),1:8)[rl1],
    rl3_desc = case_when(
      rl1 == "1" & rl3 == "1" ~ "Southeast AK",
      rl1 == "1" & rl3 == "2" ~ "Southcentral AK",
      rl1 == "1" & rl3 == "3" ~ "Arctic-Yukon",
      rl1 == "1" & rl3 == "4" ~ "Westward AK",
      rl1 == "2" & rl3 == "N" ~ "N of Cape Caution",
      rl1 == "2" & rl3 == "S" ~ "S of Cape Caution",
      rl1 == "3" & rl3 == "1" ~ "Puget Sound",
      rl1 == "3" & rl3 == "2" ~ "Coastal",
      rl1 == "3" & rl3 == "3" ~ "Ocean",
      rl1 == "3" & rl3 == "4" ~ "Columbia",
      rl1 == "5" & rl3 == "2" ~ "Coastal",
      rl1 == "5" & rl3 == "3" ~ "Columbia",
      rl1 == "6" & rl3 == "K" ~ "Klamath-Trinity",
      rl1 == "6" & rl3 == "C" ~ "Central Valley",
      rl1 == "6" & rl3 == "A" ~ "North Coastal",
      rl1 == "6" & rl3 == "B" ~ "Central Coastal",
      rl1 == "6" & rl3 == "D" ~ "Sout Coastal",
      rl1 == "6" & rl3 == "O" ~ "Ocean",
      rl1 == "6" & rl3 == "M" ~ "Mountain"
    ) 
    ##, f_g = paste0(fishery, "_", gear)
  ) |> 
  # left_join(
  #   read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_fishery.csv") |> 
  #     select(fishery, fishery_short_name),
  #   by = c("fishery")
  # )
  left_join(
    #the gear_name is non-distinct across agencies for some fishery-gear combos
    #but duplications and differences in appear non-significant
    #so preserving first version as distinct()
    read_csv("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_lu_gear.csv") |> 
      #mutate(f_g = paste0(fishery,"_", gear)) |> count(f_g) |> arrange(desc(n)) |> filter(n > 1) |> print(n=100)
      distinct(fishery, gear, .keep_all = T)
    ,
    by = c("fishery", "gear")
  ) |> 
  mutate(FisheryID = "", comment = "") |> #print(n=200)
  write_csv("rmis_rec_loc_fishery_gear_init.csv", na = "")





```


```{r eval=FALSE}
#AHB file...orig csv in "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/FishMap.csv"
ahb_fishmap <- readxl::read_excel("fram_fishery_rmis_loc.xlsx", sheet = "ahb_mapping")

#!! Note confusion on AK fisheries
#!! CoTC post-season only includes up to 198 in Fishery table
#!! AHB mapping goes up to 205
#!! but doesn't align with recovery_location_name and/or "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/1989LocationsSchema.pdf"
#!! for example, FRAM FID 198 is
#!!   "SW AK NET" in AHB mapping, but "Southeast Alaska Net" in CoTC Fishery table
#!!   and AHB mapping associates 198 to 1M1SW, but 1M1 is listed as Southeast in 1989 spec, with "NW" referring to the NW quadrant of SEAK
#!! moreover, 
rmis_rr |> filter(recovery_location_code == "1M1NW")
ahb_fishmap |> filter(PSC_Code == "1M1NW")

#~232K clean matches
rmis_rr |> 
  mutate(
    #named "Gear" in AHB file...
    fishery_single = floor(fishery/10)
      ) |> 
  inner_join(
    fishmap, 
    by = c(
      "recovery_location_code" = "PSC_Code",
      "fishery_single" = "Gear"
      )) |> 
#  filter(FRAM_Fish_ID > 0) |> 
  filter(FRAM_Fish_ID > 0, fishery < 50) |> 
  count(FRAM_Fish_ID, FRAM_Fish_Name, fishery, gear, recovery_location_code, recovery_location_name) |> 
  arrange(desc(n))


```




## OLDER

Starting to toy with a version of the *Edit Distinct* assignment logic based on number of characters. Unfinished, possibly not worth finishing.

```{r not_run_nchar_edit_distinct, eval=FALSE}
#Edit_Distinct.Gear == first character of RMIS fishery
#approx logic: check match of Edit_Distinct.PSC_Code against corresponding Num_Chars of recovery_location_code
#Edit_Distinct.Fishery_Number is a PSC fishery code, which then needs further mapping to FRAM

msm_tbl$Edit_Distinct |> count(Num_Chars)


split(msm_tbl$Edit_Distinct, msm_tbl$Edit_Distinct$Num_Chars)[1:2] |> 
  map(
    function(df){
      nc = df$Num_Chars[1]
      rmis_recs |> 
        mutate(
          PSC_Code = str_sub(recovery_location_code, 1, nc)
        ) |> 
        left_join(df, by = "PSC_Code")
    }
  )

```


# Recovery patterns

## Recoveries by release state

Totals by year, needs further stratification. Note highly varied y-axis as currently written.

```{r rec_by_rel_state}
rmis_rr |> 
  count(run_year, release_location_state) |> #release_location_rmis_region
  ggplot(aes(run_year, n, fill = release_location_state)) + 
  geom_col(show.legend = F) +
  facet_wrap(~release_location_state, ncol = 1, scales = "free")

  #filter(as.numeric(cwt_1st_mark) < 5000) 
```

## Recoveries by release region, all

Including escapement

```{r relregn_raster_with_escp}
rmis_rr |> 
  count(run_year, f_type, release_location_rmis_region) |>
  filter(!is.na(f_type)) |> 
  ggplot(aes(run_year, release_location_rmis_region, fill = n)) + 
  geom_raster(show.legend = T) +
  wacolors::scale_fill_wa_c("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Key fisheries only...

```{r relregn_raster_net_trl_spt}
rmis_rr |> 
  filter(f_type %in% c("net", "troll", "sport")) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, release_location_rmis_region, fill = n)) + 
  geom_raster(show.legend = T) +
  wacolors::scale_fill_wa_c("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Same as above as lines

```{r relregn_lines_net_trl_spt}
#lines n-recs region (line color) by year
rmis_rr |> 
  filter(f_type %in% c("net", "troll", "sport")) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, n, color = release_location_rmis_region)) + 
  geom_line(show.legend = T) +
  #wacolors::scale_fill_wa_d("gorge", reverse = T) +
  facet_wrap(~f_type, ncol = 1, scales = "free")
```

Lines for PS releases only, facet by f_type

```{r relregn_lines_net_trl_spt_ps}
#split by ps release regions
rmis_rr |> 
  filter(
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region %in% regions$ps
    ) |> 
  count(run_year, f_type, release_location_rmis_region) |>
  ggplot(aes(run_year, n, color = release_location_rmis_region)) + 
  geom_line(show.legend = T) +
  wacolors::scale_fill_wa_d("rainier", reverse = T) +
  facet_wrap(~f_type, ncol = 1)
```

Same as above, aggregating over regions within PS

```{r relregn_lines_net_trl_spt}
#aggregate by ps_release region, f_type color
rmis_rr |> 
  filter(
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region %in% regions$ps
    ) |> 
  count(run_year, f_type) |>
  ggplot(aes(run_year, n, color = f_type)) + 
  geom_line(show.legend = T) +
  facet_wrap(~f_type, ncol = 1)
```

Comparing categorical time periods (fishery recoveries by rel_region)

```{r comp_time_fishery_rec}
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport")
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, f_type, release_location_rmis_region) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  filter(year_block != "93-09") |> 
  ggplot(aes(release_location_rmis_region, n, fill = year_block)) +
  geom_col(position = position_dodge()) + coord_flip() +
  facet_wrap(~f_type, scales = "free", ncol = 1)
```

No ColR, time period comp by release "state" including BC

```{r comp_time_fishery_rec_no_ColR}
#comparing time periods of recoveries in fisheries, excluding ColR releases
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport"),
    !(release_location_rmis_region %in% regions$col_riv)
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, release_location_state) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  filter(year_block != "93-09", release_location_state %in% c("BC", "OR", "WA")) |> 
  ggplot(aes(release_location_state, n, fill = year_block)) +
  geom_col(position = position_dodge())
```

Drill down to examine just Fraser R releases

```{r comp_time_fishery_rec_fraser}
#very little to work with in recent years...
rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport"),
    release_location_rmis_region == "FRTH"
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19")),
    ) |> 
  group_by(year_block, release_location_rmis_basin) |>
  summarise(n = n(), est_num = sum(estimated_number, na.rm = T), .groups = "drop") |> 
  ggplot(aes(release_location_rmis_basin, n, fill = year_block)) +
  geom_col(position = position_dodge())

rmis_rr |> 
  filter(release_location_rmis_basin == "LOFR", !is.na(f_type)) |> 
  count(run_year, f_type) |> 
  ggplot(aes(run_year, n, fill = f_type)) +
  geom_col(position = position_dodge())

rmis_rr |> 
  filter(release_location_rmis_basin == "LOFR", f_type == "sport") |> 
  count(run_year, rl1) |> 
  ggplot(aes(run_year, n, fill = rl1)) +
  geom_col(position = position_dodge())
```

## NEXT: look for release region with adequate recoveries both time blocks. Focus on fishery recoveries assuming that escp recs probably ok if fishery ok

```{r}
rmis_rr |> 
  distinct(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  arrange(release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  #split(~release_location_state) 
  filter(release_location_state == "WA") |> print(n=50)
  


rmis_rr |> 
  filter(
    between(run_year, 1986, 2019),
    f_type %in% c("net", "troll", "sport")
    ) |> 
  mutate(
    year_block = case_when(
      between(run_year, 1986, 1992) ~ "86-92",
      between(run_year, 1993, 2009) ~ "93-09",
      between(run_year, 2010, 2019) ~ "10-19"
      ) |> factor(levels = c("86-92", "93-09", "10-19"))
    )


```

## trial dummy with prelim MSM mapped 

```{r}
#trial dummy example
mpdrec <- readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/MSMDB/MappedRecoveries.xlsx", sheet = "MappedRecoveries")

mpdrec |>
  ggplot(aes(RunYear)) +
  geom_bar()
#equivalently...
mpdrec |>
  count(RunYear) |> 
  ggplot(aes(RunYear, n)) +
  geom_col()


#all recoveries
mpdrec |>
  ggplot(aes(factor(RunYear), factor(PrNum))) +
  geom_bin2d()

#all non-escapement recoveries
mpdrec |>
  filter(MSMFishCode != 228) |> 
  ggplot(aes(factor(RunYear), factor(PrNum))) +
  geom_bin2d() +
  scale_fill_distiller(direction = 1)

```

## PR by year

## PR_MU by year


