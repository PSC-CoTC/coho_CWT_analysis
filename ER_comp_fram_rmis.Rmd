---
title: "Comparing Coho FRAM and RMIS estimates of exploitation"
author: "Dan.Auerbach@dfw.wa.gov, Angelika.Hagen-Breaux@dfw.wa.gov, carrie_cook-tabor@fws.gov"
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  bookdown::html_document2:
    self_contained: true
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
---

```{r setup, results = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9)

library("tidyverse")
library("gt")
library("patchwork")
library("odbc"); library("DBI")
theme_set(theme_light())

pal_ftype <- c("escp" = "#483778", "net" = "#D2A554", "sport" = "#626B5D", "troll" = "#8C8F9E")

dir_proj <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis"

fp <- list(
  #RMIS query dataset construction shown below
  rmis_recs = file.path(dir_proj, "rmis_coho_recoveries_86_2020.rds"),
  rmis_rel = file.path(dir_proj, "rmis_coho_releases_for_rec_86_2020.rds"),
  rmis_rec_rel = file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"),
  
  mdb_pst = "O:/code/coho/fram_mdbs/PSC_CoTC_PostSeason_CohoFRAMDB_thru2020_021622.mdb",
  
  lu_stock = "lu_cct_MSM_Stock_CWT_20220913.csv",
  lu_fish = "lu_ahb_FishMap_20220826.csv"
  )

lu <- list(
  ##CCT queried tag_codes of marked releases, QAQC'd and assigned to PR and PR_MU
  ##these are assigned to FRAM StockIDs
  cwt_stk = readr::read_csv(fp$lu_stock, col_select = -Comment) |>
    mutate(tag_code = str_remove(CWT_Code, "'")) |> 
    select(tag_code, n_rel = Number_Released, Release_name, Hatchery_name, Stock_name, StockID) |> 
    filter(!is.na(StockID))
  ,
  ##AHB extended prior FRAM fishery mapping on RMIS recovery_location_code and fishery/gear
  ##various QAQC during earlier project phases
  ahb_fishmap = readr::read_csv(fp$lu_fish) |> 
    select(FisheryID, FisheryName, fishery_single = Gear, Num_Chars, PSC_Code) |>
    distinct(FisheryID, FisheryName, fishery_single, Num_Chars, PSC_Code)
  )

# escp <- readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Escapement files/Coho/fram_coho_escapement_2022.xlsx", sheet = "dataset") |> 
#   select(StockID, StockLongName, year, escp_val, escp_val_data_source)

#for AHB, merging into her script
saveRDS(list(
  pal_ftype = pal_ftype, rmis_rr_rgn = rmis_rr_rgn, 
  samp_catch_coef_vals = samp_catch_coef_vals, 
  er_fram = er_fram, er_rmis = er_rmis, er_fram_rmis = er_fram_rmis,
  gg_stk = gg_stk
), file = "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ER_comp_fram_rmis_obj.rds")

```

This analysis examines post-season ("validation") estimates of stock and fishery specific mortality generated by [coho FRAM](https://framverse.github.io/fram_doc/calcs_data_coho.html), comparing them to patterns of coded wire tag (CWT) recoveries housed in the Regional Mark Information System [(RMIS)](https://www.rmpc.org/).

Coho FRAM predicts impacts to modeled stocks according to a "base period" drawn from CWT recoveries in catch years 1986-1992 (see https://framverse.github.io/fram_doc/index.html for additional description). The continued applicability of this parameterization is of interest to fisheries managers concerned with meeting conservation and harvest allocation objectives.

Comparing a dataset of recent recovery patterns with results based on older CWT recoveries does not address the fundamental assumption that inferences about the harvest of non-hatchery stocks are adequately informed by coded wire tagging that is overwhelmingly focused on hatchery production. Nor does this analysis attempt to determine whether recent year coho FRAM post-season exploitation rates (ER) are quantitatively accurate relative to those that might be reconstructed outside of FRAM: arriving at a "true" stock ER requires data from robust sampling throughout all phases of harvest and post-harvest escapement, and these data are not readily available for most of the coho FRAM stock units.

Instead, this investigation focuses on (dis)agreements in the relative assignment of catch mortality in primarily pre-terminal, highly mixed stock fisheries, seeking to understand how well the FRAM representation accords with current observations in RMIS. That is, we ask, "For a given stock, how well do the magnitude and relative ranks of annual per-fishery exploitation align between datasets?" Attempting to answer this seemingly straightforward question also highlights discrepancies that warrant additional auditing to ensure that data are sufficiently high quality to support management decisions and risk considerations.


# Data

Coho FRAM includes net, troll and sport fisheries that occur in pre-terminal, terminal and freshwater areas. Freshwater sport, most freshwater net and some near-terminal net were excluded from the analysis due to the practical constraint of limited and inconsistent sampling and the conceptual presumption that the stock composition of these fisheries is subject to much less uncertainty, notwithstanding some amount of "dip-ins" from neighboring river systems. In addition, RMIS Catch & Sample data were inspected and compared with fishery catch values used in post-season FRAM runs. Individual fishery-year combinations were removed when the sampled portion of catch diverged substantially from the total reported catch, and fisheries were excluded entirely if the proportion of catch that was sampled was chronically low. Where smaller annual differences occurred more sporadically, an expansion coefficent was generated based on the ratio of sampled to total reported catch (e.g., a total reported catch of 1600 and sampled catch totaling 1300 produced an adjustment coefficient of ~1.23). These coefficients were then applied to the sampling-expansion based "estimated_number" values reported for individual recoveries, thereby better aligning the fishery totals between FRAM and RMIS. See section "Handling of RMIS Catch/Sample data" in the accompanying report for additional description and code. 

```{r included_fisheries}
# #excluding:
# - freshwater sport (little/no sampling)
# - most terminal (stock comp presumed less varied; very uneven sampling)
# - others with little/no recent year catch and/or sampling
# included:
fishery_ids <- c(
  15, 17, 18, 19, 20, 21, 22, #CA/OR
  23, 33, 34, 35, 37, 38, 39, 40, 41, 42, 43, #B10/WA Ocn
  44, 45, 47, 48, 50, 81, 83, 88, 91, 92, 93, 
  97, 98, 102, 106, 107, 110, 112, 115,
  118, 120, 122, 124, 125, 129, 136, 142, 144,
  152, 154, 156, 158, 160, #161, 162, #161 Skok R 162 Quilcene R
  171, 172, 174, 175, 178, 179, 182, 189, #BC
  194, 195, 196, 197, 198, #AK
  #NT members of Tr/NT pairs missing from fram_samp_fulla
  80, 82, 87, 96, 101, 109, 111, 119, 121, 123, 
  130, 132, 137, 139, 141, 143, 145, 153, 155, 157, 159
  )

#per AHB request to combine NT & Tr net fisheries
#dropping several NT of now dropped pairs: 130, 132, 137, 139, 146 
fishery_ids_paired <- c(
  80, 82, 87, 96, 101, 109, 111, 119, 121, 123, 
  #130, 132, 137, 139,
  141, 143,
  #145,
  153, 155, 157, 159
  )

fishery_ids_ps_spt <- c(91:93, 107, 118, 129, 152, 136, 106, 115)


#per-fishery-year coefficients based on the proportion sampled of RMIS-reported catch
#these are applied to adjust the "estimated_number" values of the stock-specific recoveries in that fishery-year
#if a fishery-year reporting a catch of 1000 had sampling for 500, the coefficient value is 2
#attempting to "expand" the sampled portion of the total catch in RMIS
#the ideal situation would have the FRAM landed catch input match the RMIS total and sampled values
samp_catch_coef <- read_csv("fram_samp_fulla.csv") |> select(-1)

## fisheries with very large coefficients
# samp_catch_coef |> 
#   filter(Source=="Xpansion") |> 
#   select(FisheryID, FisheryName, Action, `2010`:`2019`) |> 
#   pivot_longer(names_to = "year", values_to = "coef", `2010`:`2019`) |> 
#   filter(coef >= 2) |> arrange(desc(coef)) |> 
#   unite("fy", FisheryID, FisheryName, year) |> 
#   ggplot(aes(coef, fct_reorder(fy, coef))) + geom_col() + geom_vline(xintercept = 8)

# ## fisheries with some years of 0 coefficents (i.e., irregular removal)
# ## note in some versions the FisheryName labeling is reversed for 38 (actually NT A3 trl) and 39 (Treaty)
# ## confirmed that 39/Tr A3 trl is the fishery with weaker sampling
# samp_catch_coef |>
#   filter(Source=="Xpansion") |>
#   select(FisheryID, FisheryName, Action, `2010`:`2019`) |>
#   pivot_longer(names_to = "year", values_to = "coef", `2010`:`2019`) |>
#   unite("fn", FisheryID, FisheryName) |>
#   filter(coef == 0) |> 
#   count(fn) |> 
#   filter(n != 10) |> #filter(n > 4) #c(39, 44, 142, 179, 182, 189)
#   arrange(desc(n)) |>
#   ggplot(aes(n, fct_reorder(fn, n))) + geom_col() + geom_vline(xintercept = 3)


# samp_catch_coef |> filter(Source == "Xpansion") |> count(Action)
# 
# samp_catch_coef |> 
#   filter(Source == "Xpansion", (Action != "Remove  fishery" | is.na(Action))) |> 
#   distinct(FisheryID) |> paste() |> cat()
## note this appears to have been constructed after "pairing" Tr/NT
## added back missing NT paired members

```

## FRAM

Estimates of landed catch and post-fishing escapement (from the *Mortality* and *Escapement* database tables respectively) were queried from the Pacific Salmon Commission Coho Technical Committee post-season FRAM database for run years 2010 to 2019. The 2015 "crash" and 2016 "post-crash" years were included in the dataset and some analyses but were generally considered uninformative of "typical" patterns.

```{r get_starting_fram_dataset}
fram <- list()

# ## initial focus on relatively data-rich units, particularly with PST relevance
# #Skagit, Sno, Quilcene, George Adams, Nisqually, Green, Quillayute, Queets, Quinault, Chehalis, Willapa, Columbia Early, Columbia Late, Fraser Lower, Fraser Upper
# stock_ids <- c(20, 38, 48, 58, 68, 96, 134, 142, 148, 152, 164, 166, 176, 226, 230)

# #all hatchery stocks, M and UM, including Northern hat/wild
# tbl(db_con, "Stock") |> filter(Species=="COHO") |> collect() |> filter(str_detect(StockLongName, "atch|ens")) |> pluck("StockID") |> paste(collapse = ", ")
stock_ids <- c(3, 4, 5, 6, 7, 8, 9, 10, 15, 16, 19, 20, 21, 22, 25, 26, 27, 28, 
  31, 32, 33, 34, 37, 38, 39, 40, 41, 42, 47, 48, 49, 50, 53, 54, 
  57, 58, 65, 66, 67, 68, 71, 72, 73, 74, 77, 78, 79, 80, 83, 84, 
  87, 88, 91, 92, 95, 96, 99, 100, 103, 104, 109, 110, 113, 114, 
  119, 120, 125, 126, 129, 130, 133, 134, 137, 138, 141, 142, 143, 144,
  147, 148, 151, 152, 155, 156, 159, 160, 163, 164, 165, 166, 167, 168,
  175, 176, 177, 178, 181, 182, 185, 186, 189, 190, 191, 192, 193, 194, 
  197, 198, 201, 202, 205, 206, 209, 210, 213, 214, 217, 218, 221, 222, 
  225, 226, 229, 230, 233, 234, 235, 236, 237, 238)

run_ids <- 34:44 #2010:2020

db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0(
    "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=",
    fp$mdb_pst, ";")
  )

fram$fishery <- tbl(db_con, "Fishery") |> 
  filter(Species == "COHO") |> 
  select(FisheryID:FisheryTitle) |> 
  collect()

DBI::dbDisconnect(db_con)


fram$escp <- framr::read_coho_escp(fp$mdb_pst, runs = run_ids, stocks = stock_ids)

fram$mort <- framr::read_coho_mort(fp$mdb_pst, runs = run_ids, stocks = stock_ids)

fram$mort |> distinct(StockID, StockLongName) |> arrange(StockID) |> gt()

fram$fishery |> filter(FisheryID %in% fishery_ids) |> gt()

```

## RMIS

All recoveries of marked coho between the years 1986 and 2020 were queried from RMIS, and these were joined with the release data associated with the distinct tag codes in this set.  This core dataset was augmented with recent year Canadian stock escapement recovery records provided by DFO. An age field was calculated as the difference between `run_year` and `brood_year`, allowing later limitation to the 3 year old fish tracked in FRAM, and records with a `sample_type` 5 were excluded as uninformative. Finally, the individual records were mapped to FRAM stocks according to a `tag_code` lookup table and to FRAM fisheries via reference to the `recovery_location_code` and `fishery` fields.

The first three chunks preserve one-time operations to generate starting datasets from RMIS, and the fourth performs the stock and fishery mapping.

```{r read_in_rmis_recoveries, eval=FALSE}
dir_rmis_recs <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/RMISRecoveries/"

focal_cols_recs <- c(
  "recovery_id", "tag_code", "run_year", 
  "recovery_location_code", "recovery_location_name", 
  "fishery", "gear", "estimated_number", "recorded_mark",
  "catch_sample_id", "sample_type")

rmis_recs <- purrr::map_dfr(
  list.files(dir_rmis_recs, pattern = ".TXT", full.names = T)
  ,
  ~readr::read_csv(.x, col_select = all_of(focal_cols_recs)) |> 
    dplyr::mutate(recorded_mark = as.character(recorded_mark))
  )

#saveRDS(rmis_recs, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_recoveries_86_2020.rds")

```

```{r get_releases_by_tag_code, eval=FALSE}
rmis_recs |>
  distinct(tag_code) |> rownames_to_column(var = "id") |>
  mutate(
    id = as.numeric(id),
    block = cut(id, breaks = c(seq(0,20000,by=2000))),
    block = letters[as.integer(block)]
    ) |> #count(block)
  split(~block) |>
  writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx")

f <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx"

readxl::read_excel(f, sheet = "a") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "b") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "c") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "d") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "e") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "f") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "g") |> pluck("tag_code") |> writeLines("clipboard")

focal_cols_rel <- c(
  "tag_code_or_release_id", "brood_year",
  "release_location_code", "hatchery_location_code", "stock_location_code",
  "release_location_name", "hatchery_location_name", "stock_location_name",
  "release_location_state", "release_location_rmis_region", "release_location_rmis_basin",
  "cwt_1st_mark", "cwt_1st_mark_count", "cwt_2nd_mark", "cwt_2nd_mark_count"
  )

rmis_rel <- map_df(
  c(
  "https://www.rmis.org/reports/CSV13497.txt",
  "https://www.rmis.org/reports/CSV13656.txt",
  "https://www.rmis.org/reports/CSV13738.txt",
  "https://www.rmis.org/reports/CSV13814.txt",
  "https://www.rmis.org/reports/CSV13854.txt",
  "https://www.rmis.org/reports/CSV14030.txt",
  "https://www.rmis.org/reports/CSV14116.txt"
  ),
  ~read_csv(.x, col_select = all_of(focal_cols_rel)) |> 
    mutate(
      cwt_1st_mark = as.character(cwt_1st_mark),
      cwt_2nd_mark = as.character(cwt_2nd_mark)
      )
  )

#saveRDS(rmis_rel, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_releases_for_rec_86_2020.rds")

```

```{r join_rel_to_rec, eval=FALSE}
left_join(
  readRDS(fp$rmis_recs) |> 
    mutate(
      rlsp = str_sub(recovery_location_code, 1, 1),
      rlwtr = str_sub(recovery_location_code, 2, 2),
      rlsctr = str_sub(recovery_location_code, 3, 3),
      rlrgn = str_sub(recovery_location_code, 4, 5),
      rlarea = str_sub(recovery_location_code, 6, 9),
      rllocn = str_sub(recovery_location_code, 10, 16),
      rlsubl = str_sub(recovery_location_code, 17, 19),
      f_type = case_when(
        between(fishery, 10, 19) ~ "troll",
        between(fishery, 20, 39) ~ "net",
        between(fishery, 40, 49) ~ "sport",
        between(fishery, 50, 59) ~ "escp"
      )
    )
  ,
  readRDS(fp$rmis_rel) |> select(-contains("n_code")),
  by = c("tag_code" = "tag_code_or_release_id")
  ) |> #saveRDS(file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"))

```

```{r rmis_rr}
#primary dataset, constructed and preserved in chunks above
rmis_rr <- readRDS(fp$rmis_rec_rel) |> 
  filter(
    sample_type != 5,
    !is.na(release_location_state)
    ) |>  #drop 3 recent
  mutate(age = run_year - brood_year) |> 
  rowid_to_column("uid")

#adding missing Canadian escapements
rmis_rr <- bind_rows(
  rmis_rr,
  readxl::read_xlsx(
    file.path(dir_proj, "ERAnalysis/2022-02-23 StAD Escapement Report_Coho_EPAD.xlsx"),
    sheet = "Obs-Est-Exp"
    ) |>
    rowid_to_column(var = "uid") |> 
    mutate(
      uid = uid + last(rmis_rr$uid),
      age = `Recovery Year` - `Brood Year`,
      fishery = 50,
      f_type = "escp"
    ) |> 
    select(
      uid,
      tag_code = Tagcode, 
      recovery_location_code = `PSC Location Code`,
      recovery_location_name = `Recovery Site Name`,
      run_year = `Recovery Year`,
      brood_year = `Brood Year`,
      age,
      fishery, f_type,
      estimated_number = `Final Expanded`
    ) |> 
    filter(
      tag_code %in% unique(rmis_rr$tag_code),
      age == 3
    ) 
  )


#add CCT mapped StockIDs
rmis_rr <- rmis_rr |> left_join(lu$cwt_stk, by = c("tag_code"))

#add AHB mapped FisheryIDs
#cannot directly join on 'PSC_Code'...have to use the Num_Chars field
#but that means using many possible lengths of recovery_location_code
#brute force iterator over Num_chars + uid to allow recombination

#first declare temp object of only key fields
rmis_rr_ahb_map <- rmis_rr |> 
  select(uid, recovery_location_code, fishery) |> 
  mutate(fishery_single = floor(fishery/10)) 
#now overwrite as split-then-bind pattern on Num_Chars
#per AHB request, added explicit right string padding to specified string length
#even when actual strings in RMIS and LU are/use fewer char
rmis_rr_ahb_map <- map_df(
  sort(unique(lu$ahb_fishmap$Num_Chars)),
  ~inner_join(
    rmis_rr_ahb_map |> 
      mutate(PSC_Code = str_sub(recovery_location_code, 1, .x) |> str_pad(width = .x, side = "right"))
    ,
    lu$ahb_fishmap |> filter(Num_Chars == .x) |> 
      mutate(PSC_Code = str_pad(PSC_Code, width = .x, side = "right"))
    ,
    by = c("PSC_Code", "fishery_single")
  )
)

#some cases of same fishery from different n-chars being considered on same recovery_location_code
#some cases initially from simple row duplication in lookup, now fixed on read-in
overmapped <- rmis_rr_ahb_map |> count(uid) |> filter(n>1) |> select(uid)

#now rejoin to full dataset, after making FisheryID distinct per UID
rmis_rr <- left_join(
  rmis_rr, 
  #split out multiple-mapped, make distinct per UID and rebind
  bind_rows(
    anti_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
      select(uid, FisheryID)
    ,
    semi_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
      group_by(uid) |> 
      slice_max(Num_Chars, n = 1, with_ties = F) |> 
      ungroup() |> 
      select(uid, FisheryID) #|> count(uid) |> filter(n>1)
  )
  ,
  by = "uid") |> 
  left_join(fram$fishery, by = "FisheryID")

rm(rmis_rr_ahb_map, overmapped)

#split Ocean troll into treaty/non-treaty
rmis_rr <- rmis_rr |> 
  mutate(
    FisheryID = if_else(FisheryID %in% c(35, 38, 42) & fishery==15, FisheryID+1, FisheryID),
    FisheryName = if_else(FisheryID==36, "Area2TrlTR", FisheryName),
    FisheryName = if_else(FisheryID==39, "Area3TrlTR", FisheryName),
    FisheryName = if_else(FisheryID==43, "A4/4BTrlTR", FisheryName)
  ) 

# rmis_rr |> filter(FisheryID %in% c(35, 36, 38, 39, 42, 43)) |> distinct(FisheryID, FisheryName, fishery, gear)
```

### Recovery patterns since 1986

As others have noted, recent years have generally seen fewer coho CWT recoveries than during the coho FRAM base period years, within both sampled fisheries and escapement (to hatcheries and in-river). 

```{r rmis_rr_rgn}
rmis_rr_rgn <- rmis_rr |> 
  filter(between(run_year, 1986, 2019)) |> 
  count(run_year, f_type, release_location_state, release_location_rmis_region, release_location_rmis_basin) |> 
  mutate(
    rgn = case_when(
      release_location_state == "AK" ~ "AK",
      release_location_state == "BC" | (is.na(release_location_state) & f_type == "escp") ~ "BC",
      
      release_location_rmis_region == "CECR" | release_location_rmis_region == "CRGN" |
        release_location_rmis_region == "LOCR" | release_location_rmis_region == "UPCR" ~ "Columbia R.",
      
      release_location_rmis_region == "HOOD" | release_location_rmis_region == "JUAN" |
        release_location_rmis_region == "MPS" | release_location_rmis_region == "NOWA" |
        release_location_rmis_region == "NPS" | release_location_rmis_region == "SKAG" |
        release_location_rmis_region == "SPS" ~ "WA Puget Sound",
      
      release_location_rmis_region == "GRAY" | release_location_rmis_region  == "NWC" |
        release_location_rmis_region =="WAGN" | release_location_rmis_region == "WILP" ~ "WA Coastal",
      
      release_location_rmis_region == "SOOR" | release_location_rmis_region == "KLTR" |
        release_location_rmis_region == "NOCA"  ~ "SONCC",
      
      release_location_rmis_region == "NOOR" | release_location_rmis_region == "ORGN" |
        release_location_rmis_region == "CECA" | release_location_rmis_region == "SAFA" |
        release_location_rmis_region == "SNAK" ~ "OR,CA,SNAK"
    ),
    yrs = case_when(
      between(run_year, 1986, 1992) ~ "1986-1992",
      between(run_year, 2010, 2019) ~ "2010-2019"
    )
  )

```

```{r recs_by_yrs, fig.height=6, fig.width=7}
rmis_rr_rgn |> 
  group_by(yrs, f_type) |> 
  summarise(n = sum(n), .groups = "drop") |> 
  drop_na(yrs, f_type) |> 
  ggplot(aes(yrs, n, fill = f_type)) +
  geom_col(position = position_dodge()) +
  scale_fill_manual(values = pal_ftype, name = "") +
  scale_x_discrete("") +
  scale_y_continuous("CWT count", labels = scales::comma) +
  labs(title = "Recovery counts by time period and type")
```

These decreases can be differentiated relative to the locations of tagged releases.

```{r recs_by_rgn_series_cols, fig.height=11, fig.width=9}
(
rmis_rr_rgn |>  
  filter(f_type != "escp") |> 
  ggplot(aes(run_year, n, fill = f_type)) + 
  geom_col() +
  scale_x_continuous("", n.breaks = 8, guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous("CWT count", labels = scales::comma) +
  scale_fill_manual(values = pal_ftype, name = "") + #wacolors::scale_fill_wa_d(palette = "larch", name = "") +
  facet_wrap(~rgn, ncol = 1) +
  labs(title = "Fishery recoveries")
) + (
rmis_rr_rgn |>  
  filter(f_type == "escp") |> 
  ggplot(aes(run_year, n, fill = f_type)) + 
  geom_col(show.legend = F) +
  scale_x_continuous("", n.breaks = 8, guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous("", labels = scales::comma) +
  scale_fill_manual(values = pal_ftype) + #wacolors::scale_fill_wa_d(palette = "uw") +
  facet_wrap(~rgn, ncol = 1) +
  labs(title = "Escapement recoveries") #+ theme(legend = element_blank())
) +
  plot_layout(nrow = 1, guides = 'collect')
```

# Exploitation calculations

Per stock, per year, a "pseudo-ER" was calculated by dividing the annual per-fishery landed catch (FRAM, non-selective + mark-selective, timesteps 1 to 5) or `estimated_number` (RMIS, summed over individual recoveries) by the sum of the total across fisheries and the non-fishery escapement. For the FRAM case:

$pseudoER_{s,f,y} = \frac{LC_{s,f,y}}{Escp_{s,y} + \sum_{f}LC_{s,f,y}}$

In addition, the "total pseudo-ER" was calculated similarly by dividing the across-fishery total by the sum of this value and escapement. For the RMIS case:

$pseudoER_{s,y} = \frac{\sum_{f}EstNum_{s,f,y}}{Escp_{s,y} + \sum_{f}EstNum_{s,f,y}}$

These values were then joined by year, stock and fishery to allow comparison between the two data sources.

```{r er_objects_included_fisheries}
#limiting expansion to 8x, drops several Canadian fishery-years
samp_catch_coef_vals <- samp_catch_coef |>
  filter(Source == "Xpansion", (Action != "Remove  fishery" | is.na(Action))) |>
  select(FisheryID, `2010`:`2019`) |> 
  pivot_longer(cols = -FisheryID, names_to = "run_year", values_to = "coef") |> 
  mutate(
    run_year = as.numeric(run_year),
    coef = if_else(coef > 8, 0, coef),
    coef = if_else(FisheryID %in% c(39, 44, 142, 179, 182, 189), 0, coef)
    )


er_fram <- full_join(
  fram$mort |>
    mutate(
      run_year = as.integer(RunYear), RunYear = NULL,
      FisheryID = if_else(FisheryID %in% fishery_ids_paired, FisheryID+1, as.double(FisheryID)),
      FisheryName = if_else(FisheryID %in% c(fishery_ids_paired, fishery_ids_paired+1),
                            str_sub(FisheryName, 1,8), FisheryName),
      FisheryID = if_else(FisheryID == 98, 97, as.double(FisheryID)),
      FisheryName = if_else(FisheryID == 97, "A7BCDNet", FisheryName)
    ) |> 
    filter(FisheryID %in% fishery_ids) |> 
    group_by(run_year, StockID, StockLongName, FisheryID, FisheryName) |> 
    summarise(
      across(c(LandedCatch, MSFLandedCatch), sum), #sum over timesteps
      fram_lnd_yr_fsh = LandedCatch + MSFLandedCatch,
      .groups = "drop") |> 
    left_join(
      samp_catch_coef_vals |> filter(coef == 0),
      by = c("FisheryID", "run_year")
    ) |> 
    mutate(fram_lnd_yr_fsh = if_else(!is.na(coef), coef * fram_lnd_yr_fsh, fram_lnd_yr_fsh)) |> 
    group_by(run_year, StockID, StockLongName) |> 
    mutate(
      LandedCatch = NULL, MSFLandedCatch = NULL,
      fram_lnd_yr_tot = sum(fram_lnd_yr_fsh)
    ) |> 
    ungroup()
  ,
  fram$escp |> 
    rename(fram_escp = escp) |> 
    mutate(run_year = as.integer(RunYear), RunYear = NULL) |> 
    group_by(run_year, StockID) |> 
    summarise(across(fram_escp, sum), .groups = "drop") 
  ,
  by = c("run_year", "StockID")
) |>
  mutate(
    fram_abnd = fram_lnd_yr_tot + fram_escp,
    fram_er_fsh = fram_lnd_yr_fsh / fram_abnd,
    fram_er_tot = fram_lnd_yr_tot / fram_abnd
  ) |> 
  select(run_year, everything()) |> 
  filter(between(run_year, 2010, 2019))


# #large majority of non-escp NA fisheries are 91 from AK
# rmis_rr |> 
#   drop_na(estimated_number, StockID) |>
#   filter(is.na(f_type)) |> count(fishery, rlsp)

er_rmis <- full_join(
  #analogous to FRAM mortality table
  rmis_rr |> 
    drop_na(estimated_number, StockID, FisheryID) |>
    mutate(
      FisheryID = if_else(FisheryID %in% fishery_ids_paired, FisheryID+1, as.double(FisheryID)),
      FisheryName = if_else(FisheryID %in% c(fishery_ids_paired, fishery_ids_paired+1),
                            str_sub(FisheryName, 1,8), FisheryName),
      FisheryID = if_else(FisheryID == 98, 97, as.double(FisheryID)),
      FisheryName = if_else(FisheryID == 97, "A7BCDNet", FisheryName)
    ) |> 
    filter(
      age == 3, f_type != "escp",
      between(run_year, min(er_fram$run_year), max(er_fram$run_year)),
      StockID %in% stock_ids,
      FisheryID %in% fishery_ids
    ) |> #count(sample_type)
    group_by(run_year, StockID, f_type, FisheryID, FisheryName) |> 
    summarise(rmis_est_num_yr_fsh = sum(estimated_number), .groups = "drop") |> 
    left_join(
      samp_catch_coef_vals, 
      by = c("FisheryID", "run_year")
    ) |>
    mutate(rmis_est_num_yr_fsh = if_else(!is.na(coef), rmis_est_num_yr_fsh * coef, rmis_est_num_yr_fsh)) |> 
    group_by(run_year, StockID) |> 
    mutate(rmis_est_num_yr_tot = sum(rmis_est_num_yr_fsh)) |> 
    ungroup()
  ,
  #analogous to FRAM escapement table
  rmis_rr |> 
    drop_na(estimated_number, StockID) |> 
    filter(
      age == 3, f_type == "escp",
      between(run_year, min(er_fram$run_year), max(er_fram$run_year)),
      StockID %in% stock_ids
    ) |> 
    group_by(run_year, StockID) |> 
    summarise(rmis_escp = sum(estimated_number), .groups = "drop")
  ,
  by = c("run_year", "StockID")
  ) |> 
  mutate(
    run_year = as.integer(run_year),
    rmis_abnd = rmis_est_num_yr_tot + rmis_escp,
    rmis_er_fsh = rmis_est_num_yr_fsh / rmis_abnd,
    rmis_er_tot = rmis_est_num_yr_tot / rmis_abnd
  )


er_fram_rmis <- full_join(
  er_fram |> select(-StockLongName, -FisheryName, -coef),
  er_rmis |> select(-FisheryName, -coef),
  by = c("run_year", "StockID", "FisheryID")
) |> 
  left_join(fram$mort |> distinct(StockID, StockLongName), by = "StockID") |> 
  left_join(fram$mort |> distinct(FisheryID, FisheryName), by = "FisheryID") |> 
  mutate(
    fidnm = paste(FisheryID, FisheryName, sep = ":") |> fct_reorder(.x = FisheryID, .fun = min),
    sidnm = paste(StockID, StockLongName, sep = ":") |> fct_reorder(.x = StockID, .fun = min),
    d_yr_fsh = fram_lnd_yr_fsh - rmis_est_num_yr_fsh,
    d_yr_tot = fram_lnd_yr_tot - rmis_est_num_yr_tot,
    d_escp_fram_rmis = fram_escp - rmis_escp,
    d_er_fsh = fram_er_fsh - rmis_er_fsh,
    d_er_tot = fram_er_tot - rmis_er_tot
    ) |> 
  filter(between(run_year, 2010, 2019))

# #a trace smattering of NA fisheries when mapped stock-year escapement recoveries without fishery recoveries 
# #prevents comparison even though FRAM has both mort and escp
# er_fram_rmis |> filter(is.na(FisheryID))
# er_rmis |> filter(run_year==2014, StockID==194) #only escapement
# rmis_rr |> filter(run_year==2014, StockID==194) |> count(f_type) #confirming only escapement
# fram$mort |> filter(RunYear==2014, StockID==194)
# fram$escp |> filter(RunYear==2014, StockID==194)
# er_fram_rmis |> filter(run_year==2014, StockID==194)

```


# Results

```{r export_xlsx}
list(
  er_fram_rmis = er_fram_rmis
) |>
  write.csv(file = paste0("results/er_fram_rmis_",Sys.Date(),".csv"))
#  writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/er_fram_rmis_all_hat_stocks_with2020.xlsx")

```

The FRAM and RMIS pseudo-ERs can be compared from "stock-centric" and "fishery-centric" perspectives. 

Differences across individual fisheries for single stocks are presented first, followed by differences organized by fishery, across stocks.

```{r gg_stk_function}

gg_stk <- function(sid = 20, min_fram_landed = 10){
    tot <- filter(er_fram_rmis, StockID == sid) |> 
      drop_na(d_er_tot) |>
      mutate(run_year = as.character(run_year)) |> 
      distinct(sidnm, run_year, FRAM = fram_er_tot, RMIS = rmis_er_tot) |>
      pivot_longer(-c(sidnm, run_year), names_to = "var", values_to = "val")
    
    tot_d_yr <- filter(er_fram_rmis, StockID == sid) |> 
      drop_na(d_er_tot) |>
      distinct(sidnm, run_year, d_er_tot) |> 
      pluck("d_er_tot") |> abs()
      
    tot_d_yr = map_chr(
          c(0.01, 0.05, 0.1),
          ~paste0("d_yr<",.x,": ", sum(tot_d_yr < .x))
          ) |> paste(collapse = ";  ")
 
    fsh <- bind_rows(
      filter(er_fram_rmis, StockID == sid, fram_lnd_yr_fsh >= min_fram_landed) |> 
        mutate(run_year = as.character(run_year)),
      #across years, end of fishery row
      filter(er_fram_rmis, StockID == sid, fram_lnd_yr_fsh >= min_fram_landed) |> 
        mutate(
          d_er_fsh = if_else(is.na(rmis_er_fsh), fram_er_fsh, d_er_fsh),
          d_er_fsh = if_else(is.na(fram_er_fsh), -1*rmis_er_fsh, d_er_fsh)
          ) |> 
        group_by(sidnm, fidnm) |>
        summarise(
          run_year = "mean",
          d_er_fsh = mean(d_er_fsh, na.rm=T), .groups = "drop"),
      #across fisheries, bottom of year col
      filter(er_fram_rmis, StockID == sid, fram_lnd_yr_fsh >= min_fram_landed) |> 
        mutate(
          d_er_fsh = if_else(is.na(rmis_er_fsh), fram_er_fsh, d_er_fsh),
          d_er_fsh = if_else(is.na(fram_er_fsh), -1*rmis_er_fsh, d_er_fsh)
        ) |> 
        mutate(run_year = as.character(run_year)) |> 
        group_by(sidnm, run_year) |>
        summarise(
          fidnm = "0: annual mean",
          d_er_fsh = mean(d_er_fsh, na.rm=T), .groups = "drop")
      ) 
    
    #fishery ranks as all-years summed percentages: sum per fishery / sum all fisheries
    #meant to stabilize year-to-year fluctuations in sampling etc.
    rnk <- filter(er_fram_rmis, StockID == sid, fram_lnd_yr_fsh > 0) |> 
      group_by(sidnm, fidnm) |> 
      summarise(
        fram_fsh = sum(fram_lnd_yr_fsh, na.rm = T),
        rmis_fsh = sum(rmis_est_num_yr_fsh, na.rm=T),
        .groups = "drop") |> 
      group_by(sidnm) |> 
      mutate(
        fram_tot = sum(fram_fsh),
        rmis_tot = sum(rmis_fsh),
        fram_fsh_tot = fram_fsh / fram_tot,
        rmis_fsh_tot = rmis_fsh / rmis_tot,
        across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.))),
        d_rnk = fram_fsh_tot_rnk - rmis_fsh_tot_rnk,
        d_rnk_color = case_when(
          fram_fsh_tot_rnk == rmis_fsh_tot_rnk ~ "darkgreen", #d_rnk == 0
          fram_fsh_tot_rnk < rmis_fsh_tot_rnk  ~ "orange", #d_rnk < 0
          fram_fsh_tot_rnk > rmis_fsh_tot_rnk  ~ "purple" #d_rnk > 0
        ),
        d_rnk_color = if_else(round(fram_fsh_tot, 3) == 0 & rmis_fsh_tot == 0, "grey50", d_rnk_color)
      ) |> 
      ungroup() |> 
      arrange(sidnm, fram_fsh_tot_rnk) |> 
      mutate(across(c(fram_fsh_tot, rmis_fsh_tot), ~round(.,3))) |> 
      select(sidnm, fidnm, contains("fsh_tot"), contains("d_rnk")) |> 
      unite("FRAM", starts_with("fram_")) |> 
      unite("RMIS", starts_with("rmis_")) |> 
      pivot_longer(c(FRAM, RMIS), names_to = "var", values_to = "val") |> 
      separate(val, into = c("pct", "rnk"), sep = "_") |> 
      mutate(
        pct = as.numeric(pct),
        rnk = factor(as.numeric(rnk))
      )
    
    snm <- tot$sidnm[1]
      
    gg_tot_bars <- bind_rows(
        tot,
        tot |> group_by(sidnm, var) |> summarise(run_year = "mean", across(val, mean), .groups = "drop") 
        ) |> 
      ggplot(aes(run_year, val, fill=var)) +
      geom_col(position = position_dodge()) +
      geom_text(aes(label = if_else(is.na(val), "", paste0(round(100*val, digits = 1), "%"))),
                position = position_dodge2(width = 1, preserve = "single"),
                size = 2, vjust = -0.5) +
      scale_fill_grey() +
      scale_x_discrete("", guide = guide_axis(n.dodge = 2)) +
      scale_y_continuous("", labels = scales::percent) +
      labs(
        title = "Annual total pseudo-ER, FRAM & RMIS",
        subtitle = tot_d_yr) +
      theme(legend.position = "right")
    
    gg_fsh <- fsh |>
      mutate(
        fidnm = factor(fidnm, levels = c(levels(er_fram_rmis$fidnm), "0: annual mean")),
        shp = case_when(
          d_er_fsh > 0 ~ "FRAM > RMIS",
          d_er_fsh < 0 ~ "FRAM < RMIS",
          d_er_fsh == 0 ~ "FRAM = RMIS",
          is.na(rmis_er_fsh) ~ "FRAM-only",
          is.na(fram_er_fsh) ~ "RMIS-only"
        ),
        #sze = if_else(!is.na(d_er_fsh), abs(d_er_fsh), 0)
        sze = if_else(!is.na(d_er_fsh), abs(d_er_fsh), fram_er_fsh)
      ) |>
      ggplot(aes(run_year, fidnm)) +
      geom_point(aes(shape = shp), size = 1) +
      geom_point(aes(shape = shp, size = sze, fill = d_er_fsh)) +
      geom_text(aes(label = if_else(is.na(d_er_fsh), "", paste0(round(100*d_er_fsh, digits = 0), "%"))), vjust = -0.5, size = 3) +
      scale_shape_manual(name = "", values = c("FRAM > RMIS" = 24, "FRAM < RMIS" = 25, "FRAM = RMIS" = 22, "FRAM-only" = 20, "RMIS-only" = 3)) +
      scale_size("ER diff. abs.", range = c(1.5, 5)) +
      scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2)) +
      guides(
        fill = guide_colorbar(title="ER difference"),
        x = guide_axis("Run Year", n.dodge = 2),
        y = guide_axis("")) +
      facet_wrap(~sidnm, ncol = 2, scales = "free_y") +
      labs(
        title = "Per-year per-fishery pseudo-ER difference",
        subtitle = paste("FRAM - RMIS, min. annual FRAM landed >=", min_fram_landed, "coho")
      )

    gg_rnk_col <- rnk |>
      ggplot(aes(fct_reorder(fidnm, pct, max), pct, group = var, fill = var)) +
      geom_col(position = position_dodge(width = 0.3), alpha = 0.5) +
      coord_flip() +
      scale_fill_manual(values = c(FRAM = "orange", RMIS = "purple")) + #scale_fill_grey() +
      theme(legend.position = "bottom")

    gg_rnk_ladder <- rnk |> 
      ggplot(aes(var, rnk, color = d_rnk_color, alpha = pct, group = fidnm)) + 
      geom_point(aes(size = pct), show.legend = F) + 
      geom_line(show.legend = F) +
      geom_text(
        data = filter(rnk, var == "FRAM"),
        aes(label = paste(fidnm, scales::percent(pct), sep = "  ")),
        size= 1.8, hjust = 1, vjust = -0.2, show.legend = F) +
      geom_text(
        data = filter(rnk, var == "RMIS"),
        aes(label = paste(fidnm, scales::percent(pct), sep = "  ")),
        size= 1.8, hjust = -0.1, vjust = -0.2, show.legend = F) +
      scale_x_discrete("") +
      scale_y_discrete("Rank", limits = rev) +
      scale_size(range = c(0.2, 4)) +
      scale_color_manual(values = c(darkgreen = "darkgreen", orange = "orange", purple = "purple")) +
      scale_alpha_continuous(range = c(0.4, 1)) #+labs(title = "Proportional ranks, 2010-2019")

    return(list(
      pseudo_er = gg_tot_bars + gg_fsh +
        plot_layout(ncol = 1, heights = c(1/4, 3/4)) +
        plot_annotation(title = snm),
      rel_rank = gg_rnk_col + gg_rnk_ladder + 
        plot_layout(ncol = 2) +
        plot_annotation(title = paste(snm, "Proportional ranking, 2010-2019"))
    ))
    
}

gg_stk()

##ranks still stratified by run_year
    # rnk <- filter(er_fram_rmis, StockID == sid, fram_lnd_yr_fsh > 0) |> 
    #   group_by(sidnm, run_year) |> 
    #   mutate(
    #     run_year = as.character(run_year),
    #     fram_fsh_tot = fram_lnd_yr_fsh / fram_lnd_yr_tot,
    #     rmis_fsh_tot = rmis_est_num_yr_fsh / rmis_est_num_yr_tot,
    #     across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.))),
    #     d_rnk = abs(fram_fsh_tot_rnk - rmis_fsh_tot_rnk)
    #   ) |> 
    #   ungroup() |> 
    #   arrange(sidnm, run_year, fram_fsh_tot_rnk)
    
    # gg_rnk <- rnk |> 
    #   select(sidnm, run_year, fidnm, 
    #          #fram_lnd_yr_fsh, rmis_est_num_yr_fsh,
    #          fram_fsh_tot, rmis_fsh_tot,
    #          fram_fsh_tot_rnk, rmis_fsh_tot_rnk
    #   ) |>
    #   mutate(across(c(fram_fsh_tot, rmis_fsh_tot), ~round(.,2))) |> 
    #   group_by(run_year) |> 
    #   filter(rmis_fsh_tot_rnk < 11) |> 
    #   ungroup() |> 
    #   unite("FRAM", starts_with("fram_")) |> 
    #   unite("RMIS", starts_with("rmis_")) |> 
    #   pivot_longer(c(FRAM, RMIS), names_to = "var", values_to = "val") |> 
    #   separate(val, into = c("est", "rnk"), sep = "_") |> 
    #   mutate(
    #     est = as.numeric(est),
    #     rnk = factor(as.numeric(rnk))
    #     ) |> 
    #   ggplot(aes(var, rnk, color = fidnm, group = fidnm)) + 
    #   geom_point(aes(size = est)) + geom_line() +
    #   #geom_text(aes(label=fidnm), hjust = 0.5) +
    #   geom_text(aes(label=scales::percent(est)), vjust = -0.1) +
    #   scale_y_discrete(limits = rev) +
    #   #scale_size(range = c(0.5, 3)) +
    #   facet_wrap(~run_year, scales = "free", nrow = 2)

```

## Puget Sound

### Skagit

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 2, 5 and 7 years respectively
  - FRAM value larger in 2013 and 2014, but otherwise RMIS value larger
  - RMIS escapement may be low in some years; in 2019 RMIS escp < fisheries, while FRAM escp ~2x fisheries
  
- **Fishery-specific**
  - annually varied +/- differences for most fisheries
  - contrasting differences did not fully offset in PS sport: lower FRAM for A10, A5, A9 and A8-2 not compensated by A8-1 and A7
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest impacts to A5, and FRAM assigns third-most impacts to A9, the second ranked RMIS fishery
  - RMIS indicates a considerably higher proportion of impact in A10, A8-2 and A2 than in FRAM
  - RMIS indicates a lower proportion of impact in 4/4B Treaty troll, A6, A8-1, and 8A net than in FRAM
  - Counter misalignment in 8-1 & 8-2 may be due to errors in datasets and/or mapping

```{r}
g <- gg_stk(20) 
g$pseudo_er; ggsave(file.path("results","f_20_Skagit.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_20_Skagit_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==20, between(run_year, 2017, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)
```


### Tulalip

- **Total across fisheries** 
  - pseudo-ER differences less than 0.1, 0.05 and 0.01 in 1, 5 and 7 years respectively
  - FRAM value larger in 2016 only
  - RMIS escapement may be low in some years; 2019 escp. missing entirely preventing ER calc (note no 2019 total column)
  
- **Fishery-specific**
  - most fisheries show negative differences where comparison possible, suggesting missing escapement 
  - contrasting Area 8D vs 8A net differences may be related to errors in dataset or mapping
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest impacts to 8D net (first) and 8A net (second)
  - both have A5 and A9 sport as third or fourth largest, and 8-2 as fifth; other fisheries are relatively minor in both

```{r}
g <- gg_stk(34)
g$pseudo_er; ggsave(file.path("results","f_34_Tulalip.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_34_Tulalip_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==34, between(run_year, 2017, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)
```


### Quilcene

- **Total across fisheries** 
  - pseudo-ER differences less than 0.1, 0.05 and 0.01 in 0, 2 and 4 years respectively
  - FRAM value consistently larger; RMIS larger in 2010 only
  - Fishery recoveries may be missing in some years; for example
    - in 2019 RMIS escp is ~3x fisheries while FRAM is ~1:1
    - in 2012 FRAM fisheries ~3x escp while RMIS fisheries < escp

- **Fishery-specific**
  - possibly mapping or other dataset errors affecting Hood Canal net fisheries 12A, 9A and 12/12B (see rank comment)
  - possible mis-assignments:
    - sport: FRAM impacts higher in A5, A10, and A6, while A9, A12, A4 and A2 lower than RMIS
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest impacts to 12A net
  - 9/9A net second for RMIS but 5th for FRAM, while 12/12B is third for FRAM but minor for RMIS 

```{r}
g <- gg_stk(48)
g$pseudo_er; ggsave(file.path("results","f_48_Quilcene.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_48_Quilcene_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==48, between(run_year, 2010, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)
```


### George Adams

- **Total across fisheries** 
  - no years close; RMIS likely missing fishery recoveries and/or mapping error

- **Fishery-specific**
  - many positive differences may be related to missing fishery recoveries and/or possibly mapping errors (e.g., among Hood Canal net fisheries)
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest impacts to 12CD net and large portions to A5, A9 and A10 sport
  - A12 sport missing from RMIS in most years hinders comparison
  - Area 12/12B net (FRAM higher) and Area 9/9A Net (RMIS higher) countering differences suggests mapping or reporting error

```{r}
g <- gg_stk(58)
g$pseudo_er; ggsave(file.path("results","f_58_GeorgeAdams.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_58_GeorgeAdams_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==58, between(run_year, 2017, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)
```

### Nisqually

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 0, 4 and 7  years respectively
  - FRAM value larger in 2012-4 and 2017-8; RMIS larger otherwise; no dominant pattern

- **Fishery-specific**
  - largest differences in 2015 Puget Sound sport, subject to atypical year caveats

- **Rank agreement**
  - both FRAM and current RMIS associate the greatest impacts to A5, A10 and A9 sport (recall in-river net not included)
  - contrasting ranks for A13 (FRAM higher) and A6 (RMIS higher) may be related to sampling intensity

```{r}
g <- gg_stk(68)
g$pseudo_er; ggsave(file.path("results","f_68_Nisqually.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_68_Nisqually_rel_rank.png"), width = 9, height = 10)
```

### Puyallup

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 0, 3 and 5 years respectively
  - FRAM value larger in 2011 and 2012 only
  - Larger RMIS values may be related to missing escapement recoveries in some years
  - In addition or alternatively, differences could be related to errors in BkFRAM targets and/or mark composition flagging that alter FRAM starting cohorts 
  
- **Fishery-specific**
  - year to year fishery differences primarily in context of larger RMIS pseudo-ERs
  - contrasting differences among Puget Sound sport fisheries in some years suggests FRAM assignments may not match particular year sampled patterns (e.g, A10 vs A6 or A9)
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest (pre-terminal) impacts to A10, A5 and A9 sport (first, second and third respectively), with A6 and A11 also appreciable 

```{r}
g <- gg_stk(84)
g$pseudo_er; ggsave(file.path("results","f_84_Puyallup.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_84_Puyallup_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==84, between(run_year, 2010, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)

#escp |> filter(StockID == 84, year == 2019) #2019 5869+1583=7452
```

### Green 

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 0, 4 and 8 years respectively
  - FRAM had larger value in all years but 2015
  - Fishery recoveries may be missing in some years; for example
    - in 2017 RMIS fisheries ~1/2 escp when FRAM ~1:1, vs 2018 and 2019 both similar
  
- **Fishery-specific**
  - As for total, larger differences may be related to missing RMIS fishery recoveries
  - Larger FRAM pseudo ER values in Area 10A net in 2017 align with possibility of fewer recoveries (or none, as in 2019)
  
- **Rank agreement**
  - Despite pseudo-ER differences, both FRAM and current RMIS associate the greatest proportion of impacts to the same three Puget Sound sport fisheries (A10, A5, A9)
  - Area 10A net and Area 4/4B troll account for a relatively lower proportion of RMIS recoveries, possibly related to differences in sampling intensity.

```{r}
g <- gg_stk(96)
g$pseudo_er; ggsave(file.path("results","f_96_Green.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_96_Green_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==96, between(run_year, 2017, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)

er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |>
  filter(StockID==96, between(run_year, 2010, 2019), FisheryID %in% c(122)) |>
  select(run_year, sidnm, fidnm, fram_lnd_yr_fsh:fram_er_tot, rmis_est_num_yr_fsh:rmis_er_tot) |> 
  mutate(
    fram_fsh_tot = fram_lnd_yr_fsh / fram_lnd_yr_tot,
    rmis_fsh_tot = rmis_est_num_yr_fsh / rmis_est_num_yr_tot
    )

```

## JDF & Coast

### Quillayute Fall

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 0, 1 and 4 years respectively
  - RMIS value larger in all years; differences may be related to missing escapement recoveries and/or mapping errors
  
- **Fishery-specific**
  - largest differences concentrated in A2 sport, the closest largest pre-terminal fishery; potentially accounted for by differences in escapement recoveries and/or BkFRAM targets and flagging
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest proportion of impacts to the same three fisheries: A2 and A1 sport and Area 4/4B troll

```{r}
g <- gg_stk(134)
g$pseudo_er; ggsave(file.path("results","f_134_QuillayuteFall.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_134_QuillayuteFall_rel_rank.png"), width = 9, height = 10)
```

### Queets

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 1, 2 and 4 years respectively, comparison possible in 6 years
  - larger RMIS value in 2014 and 2015, also largest differences in these years
    - RMIS fishery recoveries may be missing in some years: notably higher total estimated number in 2014, driven by A2 sport
  - RMIS escapement entirely missing in several years (2012, 2013, 2016, 2019) and possibly missing in others
  - releases may be a contributing factor? varied mark and/or tagging rates?
  
- **Fishery-specific**
  - contrasting differences may be related to errors in dataset or mapping
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest proportion of impacts to the same three fisheries: A2 and A1 sport and Area 4/4B troll
  - no recent recoveries in SW VI troll despite FRAM assigning ~7% of impacts over 2010-2019 

```{r}
g <- gg_stk(142)
g$pseudo_er; ggsave(file.path("results","f_142_Queets.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_142_Queets_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==142, between(run_year, 2010, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)

#SW VI Trl only 2 recoveries, both in 2005, despite appreciable proportion in FRAM
rmis_rr |> filter(StockID==142, FisheryID==175)
#at least in 2014, this fishery contributes appreciably to total catch and ER
er_fram_rmis |>
  filter(StockID==142, between(run_year, 2014, 2015), FisheryID==175)

er_fram_rmis |>
  filter(StockID==142, between(run_year, 2014, 2015)) |> 
  arrange(desc(rmis_est_num_yr_fsh))

```

### Quinault

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 1, 5 and 7 years respectively
  - RMIS value larger in all years; differences may be related to missing escapement recoveries and/or BKFRAM errors

- **Fishery-specific**
  - largest differences concentrated in A2 sport, the closest largest pre-terminal fishery; potentially accounted for by differences in escapement recoveries and/or BkFRAM targets and flagging
  - consistently higher FRAM pseudo ER values in A3 and A5 sport despite lower FRAM total pseudo ER; neither a major driver of total but may indicate shift in impact since base period
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest proportion of impacts to the same three fisheries: A2 and A1 sport and Area 4/4B troll
  - Area 3 sport, Newport sport and A5 sport shows considerably lower proportion of recent RMIS recoveries relative to FRAM catch assignments
  - Area 2 and 3 NT troll show higher proportion of recent RMIS recoveries relative to FRAM catch assignments

```{r}
g <- gg_stk(148)
g$pseudo_er; ggsave(file.path("results","f_148_Quinault.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_148_Quinault_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==148, between(run_year, 2010, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)

#A3 sport ER over-represented?
er_fram_rmis |>
  filter(StockID==148, between(run_year, 2017, 2019), FisheryID==40)
#while A2 NT troll under-represented?
er_fram_rmis |>
  filter(StockID==148, between(run_year, 2017, 2019), FisheryID==35)
```


### Chehalis

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 1, 6 and 10 years respectively
  - varied year to year in source of larger pseduo-ER value; differences small in several years

- **Fishery-specific**
  - Area 4/4B troll consistently assigned higher FRAM pseudo ER than present in RMIS; not a major driver of total, but difference in relative rank may indicate shift in impact since base period
  - Grays Harbor net also a consistently assigned higher FRAM pseudo ER than present in RMIS but differences possibly more related to escapement errors given small rank difference
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest proportion of impacts to Area 2 sport, and similar high relative ranks to Grays Harbor net, A7 sport and Grays sport
  - Willapa Bay net exhibits higher proportion of recent RMIS recoveries relative to FRAM catch assignments, but fishery is a relatively minor overall element of catch, and year-fishery pseudo-ERs are not uniformly higher in RMIS

```{r}
g <- gg_stk(152)
g$pseudo_er; ggsave(file.path("results","f_152_Chehalis.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_152_Chehalis_rel_rank.png"), width = 9, height = 10)
```

```{r}
#4/4B troll
#not heavily driven by samp coef: samp_catch_coef |> filter(FisheryID==43)
er_fram_rmis |>
  filter(StockID==152, between(run_year, 2010, 2019), FisheryID==43) |> 
  select(sidnm, fidnm, run_year, contains("er_fsh"))

#also not heavily driven by samp coef:samp_catch_coef |> filter(FisheryID==50)
er_fram_rmis |>
  filter(StockID==152, between(run_year, 2010, 2019), FisheryID==50) |> 
  select(sidnm, fidnm, run_year, contains("er_fsh"))

#Willapa impacts under-represented?
#not subject to major coef: samp_catch_coef |> filter(FisheryID==47)
#relatively minor overall element of catch, and not uniformly higher in RMIS, but also not driven by 2015
er_fram_rmis |>
  filter(StockID==152, between(run_year, 2010, 2019), FisheryID==47) |> 
  select(sidnm, fidnm, run_year, contains("er_fsh"))

```

### Willapa

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 0, 3 and 5 years respectively
  - FRAM value larger in 2014 and 2019
  - differences possibly related to missing recoveries and/or BKFRAM errors
    - 2017 fewest RMIS escapement recoveries and lowest ratio to FRAM escapement
    - 2019 RMIS escapement ~3.4x FRAM escapement and RMIS Willapa net recovery ~1.6x FRAM catch

- **Fishery-specific**
  - differences dominated by Willapa net, with RMIS pseudo ER substantially larger in earlier years (2010-12), but FRAM value larger after 2014, excepting 2017
    - note FRAM catch atypically low in 2019 in Willapa and across fisheries, while RMIS est_num within prior range but higher than FRAM; suggests possible BKFRAM or catch assignment issue
    - contrast with 2014 in which escapement recovery ratio typical, but very large catches may have affected fishery sampling (second lowest ratio of RMIS fishery est_num to FRAM catch)
    - possibly also missing fishery recoveries in 2018, with lowest ratio for fishery (est_num/catch)

- **Rank agreement**
  - both FRAM and current RMIS associate the greatest proportion of impacts to the same three fisheries: Willapa net, A2 and A1 sport; Willapa sport also appreciable in both

```{r}
g <- gg_stk(164)
g$pseudo_er; ggsave(file.path("results","f_164_Willapa.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_164_Willapa_rel_rank.png"), width = 9, height = 10)
```

```{r}
#not subject to major coef: samp_catch_coef |> filter(FisheryID==47)
er_fram_rmis |>
  filter(StockID==164, between(run_year, 2010, 2019), FisheryID==47) |> 
  select(sidnm, fidnm, run_year, contains("_yr_fsh"), contains("_yr_tot"), contains("escp"), contains("er_fsh")) |> 
  mutate(
    ratio_fsh = rmis_est_num_yr_fsh / fram_lnd_yr_fsh,
    ratio_escp = rmis_escp / fram_escp
    )

#note 2019 fram_escp 885 reflects TargetFlag==2 on BackwardsFRAM.TargetEscAge3 of 23995
```


## Columbia

### Early

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 2, 7 and 8 years respectively
  - differences larger since 2016, with RMIS values more consistently larger 

- **Fishery-specific**
  - largest difference in Buoy10 sport, but do not account for post-2016 larger RMIS total pseudo-ER
  - Newport sport shifts from mostly larger FRAM values to larger RMIS after 2016
    - 2018 RMIS fishery pseudo ER ~10.8% considerably larger than previous and FRAM
    - 2019 RMIS fishery pseudo ER ~10.8% persists and FRAM nearly identical (with smaller difference in 2019 total)
  
- **Rank agreement**
  - both FRAM and current RMIS associate the greatest proportion of impacts to the same 6 fisheries
    - very little indication in recent RMIS recoveries of different distribution of impacts relative to FRAM


```{r}
g <- gg_stk(166)
g$pseudo_er; ggsave(file.path("results","f_166_ColEarly.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_166_ColEarly_rel_rank.png"), width = 9, height = 10)
```


```{r col_early_eda, eval=FALSE}
#not subject to major coef: samp_catch_coef |> filter(FisheryID==23)
er_fram_rmis |>
  filter(StockID==166, between(run_year, 2010, 2019), FisheryID==23) |> 
  select(sidnm, fidnm, run_year, contains("_yr_fsh"), contains("_yr_tot"), contains("escp"), contains("er_fsh")) |> 
  mutate(
    ratio_fsh = rmis_est_num_yr_fsh / fram_lnd_yr_fsh,
    ratio_escp = rmis_escp / fram_escp
    )

#not subject to major coef: samp_catch_coef |> filter(FisheryID==17)
#but 2018 and 2019 jump out
er_fram_rmis |>
  filter(StockID==166, between(run_year, 2010, 2019), FisheryID==17) |> 
  select(sidnm, fidnm, run_year, contains("_yr_fsh"), contains("_yr_tot"), contains("escp"), contains("er_fsh")) |> 
  mutate(
    ratio_fsh = rmis_est_num_yr_fsh / fram_lnd_yr_fsh,
    ratio_escp = rmis_escp / fram_escp
    )


lu$cwt_stk |> filter(StockID==166) |> count(Hatchery_name, Stock_name) |> arrange(desc(n))

#careful summing cwt_1st_mark_count over recoveries - should distinct and join (similar for n_rel) 
rmis_rr |> drop_na(estimated_number) |> filter(StockID==166, age==3) |> #count(hatchery_location_name) |> arrange(desc(n))
  group_by(StockID,
           #tag_code,
           hatchery_location_name, 
           #Stock_name,
           run_year, f_type) |> 
  summarise(
    across(c(estimated_number), sum), .groups = "drop"
  ) |> 
  #filter(str_detect(hatchery_location_name, "DWOR"))
  drop_na(f_type) |> 
  filter(estimated_number > 10) |> 
  filter(f_type != "escp", between(run_year, 2010, 2019)) |> 
  ggplot(aes(run_year, estimated_number, fill = f_type)) + geom_col() + facet_wrap(~hatchery_location_name)

```

### Late

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 0, 0 and 2 years respectively
  - RMIS value larger in all years; differences likely related to missing recoveries and/or mapping errors
    - ratio of RMIS:FRAM for fisheries larger than RMIS:FRAM for escapement in all years
    - largest deviation in these ratios occurred in 2017 and 2019, when total pseudo ER difference also largest 

- **Fishery-specific**
  - consistency across fisheries points to handling of stock in FRAM and/or RMIS

- **Rank agreement**
  - despite differences in pseudo-ER magnitude, both FRAM and current RMIS associate the greatest proportion of impacts to similar fisheries
  
```{r}
g <- gg_stk(176)
g$pseudo_er; ggsave(file.path("results","f_176_ColLate.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_176_ColLate_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==176, between(run_year, 2010, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp) |> 
  mutate(
    ratio_fsh = rmis_est_num_yr_tot / fram_lnd_yr_tot,
    ratio_escp = rmis_escp / fram_escp
    )
```

## British Columbia

### Strait of Georgia mainland

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 1, 2 and 3 years respectively, comparison possible in 6 years
  - RMIS escapement missing entirely in several years and almost completely in 2011 and 2012

- **Fishery-specific**
  - several Canadian fisheries excluded entirely due to limited sampling and very few recoveries for those included limit possible comparison
  - absence of recoveries for Area 7BCD net and larger FRAM values for 4/4B troll despite otherwise larger RMIS values may indicate shifts since the coho FRAM base period 
  
- **Rank agreement**
  - Of the fisheries included and with recoveries, both FRAM and current RMIS associate substantial proportions to Area 5 sport and Area 6-7A net
  - N BC troll has the highest ranked proportional impacts in recent RMIS recoveries but accounts for a considerably lower portion of FRAM catches
  
```{r}
g <- gg_stk(206)
g$pseudo_er; ggsave(file.path("results","f_206_GeorgiaMain.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_206_GeorgiaMain_rel_rank.png"), width = 9, height = 10)
```

```{r}
er_fram_rmis |>
  drop_na(rmis_est_num_yr_tot, fram_lnd_yr_tot) |> 
  filter(StockID==206, between(run_year, 2010, 2019)) |> 
  distinct(run_year, sidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp) |> 
  mutate(
    ratio_fsh = rmis_est_num_yr_tot / fram_lnd_yr_tot,
    ratio_escp = rmis_escp / fram_escp
    )
```

### Strait of Georgia Van. Isl.

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 1, 7 and 8 years respectively
  - overall lower values result in small absolute differences but large proportional differences, particularly before 2017
  - missing escapement recoveries appear to be partially addressed in 2017-19, but FRAM values still larger, suggesting mapping errors and/or missing fishery recoveries

- **Fishery-specific**
  - several Canadian fisheries excluded entirely due to limited sampling
  - compared to SoG Mainland, fewer fishery-years with FRAM catch assigned in the absence of any RMIS
  
- **Rank agreement**
  - Of the fisheries included and with recoveries, both FRAM and current RMIS associate substantial proportions to N BC troll and Area 5 sport
  - Area 6-7 Net is assigned a considerably higher proportion of impacts in FRAM than is seen in recent RMIS recoveries
  - Conversely, NW AK troll is assigned a trace proportion of impacts in FRAM but has the third greatest proportion of recent RMIS recoveries
  
```{r}
g <- gg_stk(210)
g$pseudo_er; ggsave(file.path("results","f_210_GeorgiaVI.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_210_GeorgiaVI_rel_rank.png"), width = 9, height = 10)
```

### Fraser lower

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 2, 5 and 6 years respectively
  - larger differences before 2016 may be related to supplemental escapements

- **Fishery-specific**
  - several Canadian fisheries excluded entirely due to limited sampling
  - several fisheries missing recoveries in 2018-2019 prevent comparison
  - overall small magnitude of pseudo-ER post-2016 results in small absolute differences
  
- **Rank agreement**
  - Of the fisheries included and with recoveries, both FRAM and current RMIS associate the most impact to the same three fisheries
  - Area 7BCD Net is assigned a considerably higher proportion of impacts in FRAM than is seen in recent RMIS recoveries
  - Conversely, Area 4, 6 and 2 sport exhibit higher proportion in RMIS than in FRAM
  
```{r}
g <- gg_stk(226)
g$pseudo_er; ggsave(file.path("results","f_226_FraserLower.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_226_FraserLower_rel_rank.png"), width = 9, height = 10)
```

### Fraser upper

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 2, 5 and 8 years respectively
  - since 2016, FRAM value larger; varied differences before 2016
  - Limited or missing RMIS fishery and/or escapement recoveries may affect differences

- **Fishery-specific**
  - several Canadian fisheries excluded entirely due to limited sampling, and only a few fishery-years allow comparison for those included
  - overall small magnitude of pseudo-ER post-2016 results in small absolute differences
  
- **Rank agreement**
  - Of the fisheries included and with recoveries, both FRAM and current RMIS associate the most impact to Area 5 sport (but this fishery has the greatest number of years for comparison)
  - However, the relative ranks of many other included fisheries deviate appreciably
    - Area 4/4B troll and Area 7BCD net account for a considerably lower proportion of impact in RMIS than in FRAM
    - Area 2 and 4 sport account a considerably lower proportion of impact in RMIS than in FRAM, but are driven by only a few years of comparison
  
```{r}
g <- gg_stk(230)
g$pseudo_er; ggsave(file.path("results","f_230_FraserUpper.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_230_FraserUpper_rel_rank.png"), width = 9, height = 10)
```

### BC N Coast H/W

- **Total across fisheries** 
  - pseudo-ER differences less than 0.01, 0.05 and 0.1 in 1, 2 and 3 years respectively, comparison only possible up to 2017
  - RMIS value larger in all years; likely affected by limited or missing RMIS fishery and/or escapement recoveries

- **Fishery-specific**
  - several Canadian fisheries excluded entirely due to limited sampling, and only a few fishery-years allow comparison for those included
  - majority of information drawn from Alaskan fisheries which may be subject to mapping error
  
- **Rank agreement**
  - Of the fisheries included and with recoveries, both FRAM and current RMIS rank many equivalently, but with NW AK troll largest in RMIS versus N BC troll largest in FRAM

```{r}
g <- gg_stk(236)
g$pseudo_er; ggsave(file.path("results","f_236_BC_Ncoast_HW.png"), width = 9, height = 11)
g$rel_rank; ggsave(file.path("results","f_236_BC_Ncoast_HW_rel_rank.png"), width = 9, height = 10)
```

## Across stocks

### Annual and mean total pseudo-ERs 

The generally fewer recoveries for Canadian stocks appear to contribute to characteristically larger differences within British Columbia populations. This pattern could be related to rearing and release practices (i.e., limited tagging and/or marking), the type and coverage of fishery and escapement sampling, errors in mapping to FRAM stocks and/or fisheries, and/or errors in the validation run inputs.

However, for the stocks with the most years in which comparison was possible, the FRAM values were larger, possibly due to the addition of supplemental escapement recoveries provided by DFO outside of RMIS. Notably, the "total" picture for a stock such as "BC North Coast Hatchery/Wild" is strongly driven by a few (mostly Alaskan) fisheries during the earlier years of the series considered here.

```{r gg_total_er_boxes}
er_fram_rmis |> 
  drop_na(d_er_tot) |>
  group_by(sidnm) |> 
  distinct(sidnm, run_year, fram_er_tot, rmis_er_tot, d_er_tot) |> 
  mutate(
    across(contains("er_tot"), list(med = median)),
    n = n()) |> 
  ggplot(aes(fct_rev(sidnm), d_er_tot, fill = d_er_tot_med)) +
  geom_boxplot(aes(weight = n), outlier.shape = NA, varwidth = T, show.legend = F) +
  geom_jitter(aes(color = d_er_tot_med), alpha = 0.6, show.legend = F) +
  coord_flip() +
  geom_hline(yintercept = 0, size = 1.3) + 
  geom_hline(yintercept = c(-0.05, 0.05), linetype = 2) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype = 3) + 
  scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2), aesthetics = c("fill", "color")) +
  guides(
    fill = guide_colorbar(title="ER difference"),
    x = guide_axis(""),
    y = guide_axis("")) +
  labs(
    title = "Differences in annual total pre-terminal pseudo-ER", subtitle = "FRAM - RMIS; positive value if FRAM larger"
  )

```

```{r gg_total_er_boxes_focal}
er_fram_rmis |> 
  drop_na(d_er_tot) |>
  filter(StockID %in% c(20, 38, 48, 58, 68, 96, 134, 142, 148, 152, 164, 166, 176, 226, 230)) |> 
  group_by(sidnm) |> 
  distinct(sidnm, run_year, fram_er_tot, rmis_er_tot, d_er_tot) |> 
  mutate(
    across(contains("er_tot"), list(med = median)),
    n = n()) |> 
  #filter(n > 9) |> 
  ggplot(aes(fct_rev(sidnm), d_er_tot, fill = d_er_tot_med)) +
  geom_boxplot(aes(weight = n), outlier.shape = NA, varwidth = T, show.legend = F) +
  geom_jitter(aes(color = d_er_tot_med), alpha = 0.6, show.legend = F) +
  coord_flip() +
  geom_hline(yintercept = 0, size = 1.3) + 
  geom_hline(yintercept = c(-0.05, 0.05), linetype = 2) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype = 3) + 
  scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2), aesthetics = c("fill", "color")) +
  guides(
    fill = guide_colorbar(title="ER difference"),
    x = guide_axis(""),
    y = guide_axis("")) +
  labs(
    title = "Differences in annual total pre-terminal pseudo-ER", subtitle = "FRAM - RMIS; positive value if FRAM larger"
  )

```

```{r total_er_annual, eval=FALSE}
## gt
er_fram_rmis |> 
  drop_na(d_er_tot) |>
  group_by(sidnm) |> 
  distinct(sidnm, run_year, fram_er_tot, rmis_er_tot, d_er_tot) |>
  ungroup() |>
  arrange(sidnm) |> #print(n=50)
  gt(groupname_col = "sidnm", rowname_col = "run_year") |> 
  summary_rows(groups = T, fns = "mean", formatter = fmt_percent, decimals = 1) |> 
  fmt_percent(contains("_er"), decimals = 1) |> 
  tab_style(
    style = list(cell_fill(color = "purple", alpha = 0.5)),
    locations = cells_body(rows = d_er_tot < -0.05)) |> 
  tab_style(
    style = list(cell_fill(color = "orange", alpha = 0.5)),
    locations = cells_body(rows = d_er_tot > 0.05)) |> 
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_summary()
  )

## gg triangles
er_fram_rmis |> 
  drop_na(d_er_tot) |>
  group_by(sidnm) |> 
  distinct(sidnm, run_year, fram_er_tot, rmis_er_tot, d_er_tot) |> 
  ungroup() |>
  mutate(
    run_year = as.character(run_year),
    shp = case_when(
      d_er_tot > 0 ~ "FRAM > RMIS",
      d_er_tot < 0 ~ "FRAM < RMIS",
      d_er_tot == 0 ~ "FRAM = RMIS"
    ),
    sze = if_else(!is.na(d_er_tot), abs(d_er_tot), 0)
  ) |> 
  ggplot(aes(run_year, fct_rev(sidnm))) +
  geom_point(aes(shape = shp), size = 2) +
  geom_point(aes(shape = shp, size = sze, fill = d_er_tot)) +
  geom_text(aes(label = paste0(round(100*d_er_tot, digits = 0), "%")), nudge_y = 0.3) +
  scale_shape_manual(name = "", values = c("FRAM > RMIS" = 24, "FRAM < RMIS" = 25, "FRAM = RMIS" = 22, "FRAM-only" = 20, "RMIS-only" = 3)) +
  scale_size("ER diff. abs.", range = c(1, 10)) +
  scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2)) +
  guides(
    #size = guide_bins(range = c(2.5, 10)),
    fill = guide_colorbar(title="ER difference"),
    x = guide_axis("Run Year"),
    y = guide_axis("")) +
  labs(
    title = "Differences in annual total pre-terminal pseudo-ER", subtitle = "FRAM - RMIS"
  )

```

### Annual fishery impact relative ranks

```{r}
er_fram_rmis_rnk <- er_fram_rmis |> 
  filter(
    fram_lnd_yr_fsh > 0,
    !str_detect(sidnm, "UnMark")
    ) |> 
  group_by(sidnm, fidnm) |> 
  summarise(
    fram_fsh = sum(fram_lnd_yr_fsh, na.rm = T),
    rmis_fsh = sum(rmis_est_num_yr_fsh, na.rm=T),
    .groups = "drop") |> 
  group_by(sidnm) |> 
  mutate(
    fram_tot = sum(fram_fsh),
    rmis_tot = sum(rmis_fsh),
    fram_fsh_tot = fram_fsh / fram_tot,
    rmis_fsh_tot = rmis_fsh / rmis_tot,
    across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.))),
    d_rnk = abs(fram_fsh_tot_rnk - rmis_fsh_tot_rnk)
  ) |> 
  ungroup() |> 
  arrange(sidnm, fram_fsh_tot_rnk) |> 
  mutate(across(c(fram_fsh_tot, rmis_fsh_tot), ~round(.,3)))

#27 of 40 marked hatchery stocks (with any recoveries) have the same fishery designated proportionally largest  
er_fram_rmis_rnk |> 
  filter(rmis_tot > 0) |> 
  group_by(sidnm) |> 
  slice_min(fram_fsh_tot_rnk, n = 1) |> 
  ungroup() |> 
  count(d_rnk == 0) |> 
  mutate(pct = n / sum(n))
  
#10 of 40 match top 3, and 22 have sum of rank differences <= 3 in top 3
er_fram_rmis_rnk |> 
  filter(rmis_tot > 0) |> 
  group_by(sidnm) |> 
  slice_min(fram_fsh_tot_rnk, n = 3) |>
  summarise(d_rnk = sum(d_rnk)) |> 
  ungroup() |> arrange(d_rnk) |> 
  summarise(
    top3_same = sum(d_rnk == 0),
    top3_close = sum(d_rnk <= 3)) 


# er_fram_rmis_rnk |> 
#   drop_na(d_rnk) |> 
#   rowwise() |> 
#   mutate(d_rnk_wt = d_rnk * mean(c(fram_fsh_tot, rmis_fsh_tot), na.rm=T)) |> 
#   #filter(is.na(d_rnk)) |> 
#   group_by(sidnm) |> 
#   summarise(d_rnk_wt_tot = sum(d_rnk_wt, na.rm = T), .groups = "drop") |> 
#   ggplot(aes(fct_reorder(sidnm, d_rnk_wt_tot), d_rnk_wt_tot)) + 
#   geom_col() + coord_flip()

```


## Differences by fishery

```{r}
#for smaller set of focal stock_ids, only minimal/inconsequential instances of impacts in RMIS that are missing from FRAM...(can see also earlier examination in coho_CWT_analysis)
er_fram_rmis |> 
  filter(is.na(fram_lnd_yr_fsh)) |> 
  arrange(desc(rmis_est_num_yr_fsh)) |> 
  select(run_year, sidnm, fidnm, rmis_est_num_yr_fsh, rmis_est_num_yr_tot) |> 
  print(n=30)
```

Most fisheries exhibit little or no consistent bias across stocks and/or years, with the distribution of per-year-per-stock differences with +/-0.05 pseudo-ER units and medians near 0. 

This does not exclude the possibility of offsetting differences on a per-stock basis (e.g., consistently larger values from one dataset for one or several stocks set against consistenly smaller values for others), but it indicates the magnitude of such error is likely to be modest for many fisheries. In addition, several more heavily skewed distributions may be driven by few years and/or stocks (e.g., 13D Net, 10E NEt) and associated sampling issues (e.g., missing escapement recoveries for the stock that dominates catches in a near-terminal fishery). In other cases, mapping or reporting errors may account for patterns in other fisheries with similar stock compositions but roughly offset differences (e.g., 12A net vs 12B net).

```{r d_er_fsh_boxes}
er_fram_rmis |> 
  filter(
    fram_lnd_yr_fsh >= 10,
    abs(d_er_fsh) > 0.001,
    abs(d_er_fsh) < 0.5
    ) |>
  mutate(run_year = as.character(run_year)) |> 
  ggplot(aes(d_er_fsh, fidnm, fill = d_er_fsh)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = d_er_fsh), alpha = 0.4, position = position_jitter(height = 0.2), ) +
  scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2), aesthetics = c("fill", "color")) +
  geom_vline(xintercept = 0, size = 1.3) + 
  geom_vline(xintercept = c(-0.05, 0.05), linetype = 2) +
  geom_vline(xintercept = c(-0.1, 0.1), linetype = 3) +
  labs(
    title = "Fishery-specific pseudo-ERs, distributions across stocks and years",
    subtitle = "Min. 10 landed coho in FRAM, 0.001 < abs. diff < 0.5"
  )
```

The pattern of most stock-year differences less than 0.1 or 0.05 pseudo-ER units holds when looking more closely at several fisheries presumed to have highly mixed stock composition.

```{r ggridges_4_fishery}
er_fram_rmis |> 
  filter(
    FisheryID %in% c(118, 91, 43, 37),
    fram_lnd_yr_fsh >= 10
    ) |>
  mutate(run_year = as.character(run_year)) |> 
  ggplot(aes(x = d_er_fsh, y = run_year)) +
  ggridges::geom_density_ridges_gradient(aes(fill = stat(x)), show.legend = F) +
  geom_rug(aes(color = d_er_fsh), alpha = 0.5) +
  geom_vline(xintercept = 0, size = 1.3) + 
  geom_vline(xintercept = c(-0.05, 0.05), linetype = 2) +
  geom_vline(xintercept = c(-0.1, 0.1), linetype = 3) + 
  scale_fill_fermenter(name = "", type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2), aesthetics = c("fill", "color")) +
  scale_x_continuous("Difference in pseudo-ER, FRAM - RMIS") +
  scale_y_discrete("") +
  facet_wrap(~fidnm, ncol = 1)

```

Where larger differences occur for a fishery, the result may follow from one or a few stocks in one or several years in which errors can be traced to FRAM (input values, input flagging, stock mapping) and/or RMIS (sampling, reporting).

```{r a10_focal}
er_fram_rmis |> 
  filter(
    FisheryID %in% c(118),
    fram_lnd_yr_fsh >= 10
    ) |>
  mutate(run_year = as.character(run_year)) |> 
  drop_na(d_er_fsh) |> 
  ggplot(aes(x = sidnm, y = d_er_fsh)) +
  geom_col(aes(fill = run_year), position = position_dodge(width = 0.7, preserve = "single")) +
  coord_flip() +
  geom_hline(yintercept = 0, size = 1.3) + 
  geom_hline(yintercept = c(-0.05, 0.05), linetype = 2) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype = 3) + 
  scale_fill_brewer(palette = "Greens") +
  scale_y_continuous("Difference in pseudo-ER, FRAM - RMIS") +
  labs(
    title = "Fishery specific pseudo-ER differences",
    subtitle = "Area 10 Sport"
  )

```

## Longer term, single-stock, single-fishery

This section demonstrates a potential further analysis based only on RMIS recoveries. Focusing on a single RMIS `hatchery_location_name` and `stock_location_name` (possibly further constrained by `release_location_name`), the annual among-fishery proportional recoveries can be calculated. Conceptually, this corresponds to and extends the "rank impact" results above, comparing against FRAM. This approach reduces considerations related to mapping to FRAM stock (e.g., were all `tag_code` groups captured and correctly assigned) and allows for consideration of a longer time series (up to the full 1986-2020 starting RMIS dataset). These calculations do not directly take into account any changes in rearing and release practices, nor among-fishery changes in sampling practices. These could affect interpretation of any long term trends, but would not be expected to impact results for any given year. Regardless, the comparison of differences in time series attributes between fisheries may indicate patterns that merit further study. Note that the `group`ing and plotting uses the mapping to FRAM fisheries, but RMIS `recovery_location_*` values could be substituted straightforwardly.

```{r}
rmis_rr |> 
  drop_na(estimated_number) |>
  filter(
    age == 3,
    str_detect(hatchery_location_name, "MARBLEMOUNT HATCHERY"),
    str_detect(stock_location_name, "SKAGIT R     03.0176"),
    !str_detect(release_location_name, "BAKER")
    ) |> 
  group_by(
    run_year, #starts_with("release_location_"), #starts_with("recovery_location_"), 
    stock_location_name,
    f_type, FisheryID, FisheryName
    ) |> 
  summarise(across(estimated_number, sum), .groups = "drop") |> 
  group_by(run_year, stock_location_name) |> 
  mutate(est_num_yr = sum(estimated_number)) |> 
  ungroup() |> 
  mutate(est_num_yr_pct = round(estimated_number / est_num_yr, 4)) |> 
  filter(FisheryID %in% c(43, 91:92, 103)) |> 
  ggplot(aes(run_year, est_num_yr_pct)) +
  geom_point(aes(size = est_num_yr), alpha = 0.6) +
  geom_smooth(method = "lm") +
  facet_wrap(~FisheryID +FisheryName, nrow = 1) +
    labs(
    title = "MARBLEMOUNT HATCHERY - SKAGIT R     03.0176, excl. BAKER rel",
    subtitle = "Annual fishery recoveries / total fishery recoveries"
  )


# #many unmapped to 96 are pre-1997, but also many 1999-2018...
# #but both 0000s and 5000s mapped and unmapped to 96
# #for 2010 onward, the 0000s to 96 are trace, and plausibly related to RMIS data entry errors 
# rmis_rr |> drop_na(estimated_number) |>
#   filter(
#     age == 3,
#     str_detect(hatchery_location_name, "SOOS CREEK HATCHERY"), 
#     str_detect(stock_location_name, "BIG SOOS CR  09.0072"),
#     recorded_mark %in% c("5000", "0000")
#     ) |> 
#   count(hatchery_location_name, stock_location_name, StockID, run_year, recorded_mark) |> print(n=80)

# a snapshot of dominant recovery locations
rmis_rr |> drop_na(estimated_number) |> 
  filter(
    age == 3,
    str_detect(hatchery_location_name, "SOOS CREEK HATCHERY"), 
    str_detect(stock_location_name, "BIG SOOS CR  09.0072"),
    recorded_mark %in% c("5000", "0000")
  ) |> 
  count(recovery_location_name, recovery_location_code, f_type, FisheryID) |> 
  arrange(desc(n)) |> print(n=30)

rmis_rr |> 
  drop_na(estimated_number) |>
  filter(
    age == 3,
    str_detect(hatchery_location_name, "SOOS CREEK HATCHERY"), 
    str_detect(stock_location_name, "BIG SOOS CR  09.0072"),
    recorded_mark %in% c("5000", "0000")
    ) |> 
  group_by(
    run_year, #starts_with("release_location_"), #starts_with("recovery_location_"), 
    stock_location_name,
    f_type, FisheryID, FisheryName
    ) |> 
  summarise(across(estimated_number, sum), .groups = "drop") |> 
  group_by(run_year, stock_location_name) |> 
  mutate(est_num_yr = sum(estimated_number)) |> 
  ungroup() |> 
  mutate(est_num_yr_pct = round(estimated_number / est_num_yr, 4)) |> 
  filter(FisheryID %in% c(43, 91, 120, 122, 126)) |> 
  ggplot(aes(run_year, est_num_yr_pct)) +
  geom_point(aes(size = est_num_yr), alpha = 0.6) +
  geom_smooth(method = "lm") +
  facet_wrap(~FisheryID +FisheryName, nrow = 1) +
  labs(
    title = "SOOS CREEK HATCHERY - BIG SOOS CR  09.0072",
    subtitle = "Annual fishery recoveries / total fishery recoveries"
  )


```

# Next steps:  BackwardsFRAM v Escapement 

This section demonstrates an approach to identify an area of high-priority input review: agreement between the "realized" escapement values in post-season runs (i.e., those used throughout this analysis) and the BackwardsFRAM target escapement values, used to establish the "recruit scalers" that set starting cohorts (see [FRAM documentation](https://framverse.github.io/fram_doc) for more details). The latter are compiled from various regional expert sources and data stewards, and while they are subject to revision outside of FRAM post-season runs, are considered to represent the best available estimates. Backwards runs are specified to meet convergence criteria that ensure agreement with these targets, but only for those stock units where the provided value is understood to correspond directly; for some aggregates, a BackwardsFRAM `TargetFlag` value of 2 means that the provided value is disaggregated (i.e., across mark status) using other values. In this case, the provided target value and the forward run realized escapement value can and do diverge, but further examination is required to determine Whether or not this is the correct/desirable outcome.

```{r}
db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0(
    "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=",
    fp$mdb_pst, ";")
  )

fram$backwards <- tbl(db_con, "BackwardsFRAM") |> 
  filter(RunID %in% run_ids, StockID %in% stock_ids) |> 
  select(RunID, StockID, target = TargetEscAge3, flag = TargetFlag) |> 
  collect()

DBI::dbDisconnect(db_con)

```

```{r}
left_join(
  fram$escp, 
  fram$backwards, 
  by = c("RunID", "StockID")
  ) |> 
  drop_na(target) |> 
  mutate(
    d = target - escp,
    d_pct = d / target
  ) |> 
  filter(abs(d_pct) > 0.15) |> split(~flag) |> walk(~print(.x, n=200))

```


# Conclusion

We hypothesized that results of coho FRAM validation runs for the fishing years 2010-2019 would correspond poorly with those calculated directly from RMIS recoveries during the same time span. Contrary to this expectation, for the stocks and fisheries with adequate data included in this analysis, we found that the 1986-1992 FRAM base period parameterization yielded output with mostly modest differences in pseduo-ERs and with mostly good agreement in terms of the relative ranking of impacts among per-terminal fisheries. In addition, most larger differences between the two datasets were plausibly explained by sampling limitations in fisheries, escapement or both. Nonetheless, determining with certainty the more accurate of the two values was difficult or impossible in almost all cases. 

This analysis may suggest a few specific stock-fishery interactions that warrant further scrutiny for possible adjustments in pre- and post-season modeling (e.g., how impacts are assigned among several Puget Sound sport fisheries). However, it clearly underscores the need for additional auditing of both the post-seaon coho FRAM and RMIS datasets. At minimum, additional careful review is warranted for the Backwards FRAM escapement targets (i.e., the numeric values of unharvested, returning adults) as well as the flagging to control mark rate composition of the cohorts constructed from those targets (i.e., were regionally-estimated values maintained as supplied, or did flagging to use pre-season or other mark rates alter the marked to unmarked ratio in the starting cohort). The catch values that are the other primary input to post-season coho FRAM runs would also benefit from additional cross-checking against those reported elsewhere in, among other sources, annual Pacific Fishery Management Council tables, RMIS catch and escapement, and agency-specific published values. Although still subject to observation error, the estimates of catch should be the least uncertain input to the post-season modeling effort, particularly for commercial fisheries.

