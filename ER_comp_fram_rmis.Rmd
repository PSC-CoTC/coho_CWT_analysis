---
title: "Comparing Coho FRAM and RMIS estimates of exploitation"
author: "Dan.Auerbach@dfw.wa.gov, Angelika.Hagen-Breaux@dfw.wa.gov, carrie_cook-tabor@fws.gov"
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
output: 
  bookdown::html_document2:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
---

```{r setup, results = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 9)

library("tidyverse")
library("gt")
library("patchwork")
library("odbc"); library("DBI")
theme_set(theme_light())

dir_proj <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis"

fp <- list(
  #RMIS query dataset construction shown below
  rmis_recs = file.path(dir_proj, "rmis_coho_recoveries_86_2020.rds"),
  rmis_rel = file.path(dir_proj, "rmis_coho_releases_for_rec_86_2020.rds"),
  rmis_rec_rel = file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"),
  
  mdb_pst = "O:/code/coho/fram_mdbs/PSC_CoTC_PostSeason_CohoFRAMDB_thru2020_021622.mdb",
  
  lu_stock = "lu_cct_MSM_Stock_CWT_20220711.csv",
  lu_fish = "lu_ahb_FishMap_20220808.csv"
  )

lu <- list(
  ##CCT queried releases, QAQC'd and assigned to PR and PR_MU
  ##these are assigned to FRAM marked wild StockIDs
  ##and are limited to tag_codes for marked releases
  cwt_stk = readr::read_csv(fp$lu_stock) |>
    mutate(tag_code = str_remove(CWT_Code, "'")) |> 
    select(tag_code, n_rel = Number_Released, Release_name, Hatchery_name, Stock_name, StockID) |> 
    filter(!is.na(StockID))
  ,
  ##AHB extended prior FRAM fishery mapping on RMIS recovery_location_code and fishery/gear
  ##various QAQC during earlier project phases
  ahb_fishmap = readr::read_csv(fp$lu_fish) |> 
    select(FisheryID, FisheryName, fishery_single = Gear, Num_Chars, PSC_Code) |>
    distinct(FisheryID, FisheryName, fishery_single, Num_Chars, PSC_Code)
  )

```

# Data

```{r included_fisheries}
#samp_catch_coef <- readxl::read_excel("C:/Users/auerbdaa/Downloads/fram_samp_fulla.xlsx", sheet = "fram_samp_fulla")
samp_catch_coef <- read_csv("fram_samp_fulla.csv") |> select(-1)

# samp_catch_coef |> filter(Source == "Xpansion") |> count(Action)
# 
# samp_catch_coef |> 
#   filter(Source == "Xpansion", (Action != "Remove  fishery" | is.na(Action))) |> 
#   distinct(FisheryID) |> paste() |> cat()
## note this appears to have been constructed after "pairing" Tr/NT
## below added back missing NT paired members

# #excluding:
# - freshwater sport (little/no sampling)
# - most terminal (stock comp presumed less varied; very uneven sampling)
# - others with little/no recent year catch and/or sampling
# included:
fishery_ids <- c(
  15, 17, 18, 19, 20, 21, 22, #CA/OR
  23, 33, 34, 35, 37, 38, 39, 40, 41, 42, 43, #B10/WA Ocn
  44, 47, 48, 50, 81, 83, 88, 91, 92, 93, 
  97, 98, 102, 106, 107, 110, 112, 115,
  118, 120, 122, 124, 125, 129, 136, 142, 144,
  152, 154, 156, 158, 160, 161, 162,
  171, 172, 174, 175, 178, 179, 182, 189, #BC
  194, 195, 196, 197, 198, #AK
  #NT members of Tr/NT pairs missing from fram_samp_fulla
  80, 82, 87, 96, 101, 109, 111, 119, 121, 123, 
  130, 132, 137, 139, 141, 143, 145, 153, 155, 157, 159
  )

#per AHB request to combine NT & Tr net fisheries
#dropping several NT of now dropped pairs: 130, 132, 137, 139, 146 
fishery_ids_paired <- c(
  80, 82, 87, 96, 101, 109, 111, 119, 121, 123, 
  #130, 132, 137, 139,
  141, 143,
  #145,
  153, 155, 157, 159
  )

fishery_ids_ps_spt <- c(91:93, 107, 118, 129, 152, 136, 106, 115)

##previously excluded from FRAM:
# fram_fishery_fw_spt <- c(
#   24, 27,28,29,30,31,46,51,54,58,59,60,61,62,65,66,67,70,73,
#   76,89,90,94,95,99,100,108,116,117,127,128,135,149,150,151,
#   163,164,165,166,169
#   )
##paralleled but non-FisheryID-based in RMIS: filter(!(f_type == "sport" & rlwtr == "F"))
```

## FRAM

```{r get_starting_fram_dataset}
fram <- list()

#Skagit, Sno, Quilcene, George Adams, Nisqually, Green, Quillayute, Queets, Quinault, Chehalis, Willapa, Columbia Early, Columbia Late, Fraser Lower, Fraser Upper
stock_ids <- c(20, 38, 48, 58, 68, 96, 134, 142, 148, 152, 164, 166, 176, 226, 230)

run_ids <- 34:44 #2010:2020

db_con <- DBI::dbConnect(
  drv = odbc::odbc(),
  .connection_string = paste0(
    "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=",
    fp$mdb_pst, ";")
  )

fram$fishery <- tbl(db_con, "Fishery") |> 
  filter(Species == "COHO") |> 
  select(FisheryID:FisheryTitle) |> 
  collect()

DBI::dbDisconnect(db_con)


fram$escp <- framr::read_coho_escp(fp$mdb_pst, runs = run_ids, stocks = stock_ids)

fram$mort <- framr::read_coho_mort(fp$mdb_pst, runs = run_ids, stocks = stock_ids)

fram$mort |> distinct(StockID, StockLongName) |> arrange(StockID) |> gt()
```

## RMIS

These chunks preserve one-time operations to generate starting datasets from RMIS.

```{r read_in_rmis_recoveries, eval=FALSE}
dir_rmis_recs <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/RMISRecoveries/"

focal_cols_recs <- c(
  "recovery_id", "tag_code", "run_year", 
  "recovery_location_code", "recovery_location_name", 
  "fishery", "gear", "estimated_number", "recorded_mark",
  "catch_sample_id", "sample_type")

rmis_recs <- purrr::map_dfr(
  list.files(dir_rmis_recs, pattern = ".TXT", full.names = T)
  ,
  ~readr::read_csv(.x, col_select = all_of(focal_cols_recs)) |> 
    dplyr::mutate(recorded_mark = as.character(recorded_mark))
  )

#saveRDS(rmis_recs, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_recoveries_86_2020.rds")

```

```{r get_releases_by_tag_code, eval=FALSE}
rmis_recs |>
  distinct(tag_code) |> rownames_to_column(var = "id") |>
  mutate(
    id = as.numeric(id),
    block = cut(id, breaks = c(seq(0,20000,by=2000))),
    block = letters[as.integer(block)]
    ) |> #count(block)
  split(~block) |>
  writexl::write_xlsx("T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx")

f <- "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/ERAnalysis/tag_codes_by_block.xlsx"

readxl::read_excel(f, sheet = "a") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "b") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "c") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "d") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "e") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "f") |> pluck("tag_code") |> writeLines("clipboard")
readxl::read_excel(f, sheet = "g") |> pluck("tag_code") |> writeLines("clipboard")

focal_cols_rel <- c(
  "tag_code_or_release_id", "brood_year",
  "release_location_code", "hatchery_location_code", "stock_location_code",
  "release_location_name", "hatchery_location_name", "stock_location_name",
  "release_location_state", "release_location_rmis_region", "release_location_rmis_basin",
  "cwt_1st_mark", "cwt_1st_mark_count", "cwt_2nd_mark", "cwt_2nd_mark_count"
  )

rmis_rel <- map_df(
  c(
  "https://www.rmis.org/reports/CSV13497.txt",
  "https://www.rmis.org/reports/CSV13656.txt",
  "https://www.rmis.org/reports/CSV13738.txt",
  "https://www.rmis.org/reports/CSV13814.txt",
  "https://www.rmis.org/reports/CSV13854.txt",
  "https://www.rmis.org/reports/CSV14030.txt",
  "https://www.rmis.org/reports/CSV14116.txt"
  ),
  ~read_csv(.x, col_select = all_of(focal_cols_rel)) |> 
    mutate(
      cwt_1st_mark = as.character(cwt_1st_mark),
      cwt_2nd_mark = as.character(cwt_2nd_mark)
      )
  )

#saveRDS(rmis_rel, "T:/DFW-Salmon Mgmt Modeling Team - General/Southern Fund Projects/Coho FRAM MSM CWT analysis/rmis_coho_releases_for_rec_86_2020.rds")

```

```{r join_rel_to_rec, eval=FALSE}
left_join(
  readRDS(fp$rmis_recs) |> 
    mutate(
      rlsp = str_sub(recovery_location_code, 1, 1),
      rlwtr = str_sub(recovery_location_code, 2, 2),
      rlsctr = str_sub(recovery_location_code, 3, 3),
      rlrgn = str_sub(recovery_location_code, 4, 5),
      rlarea = str_sub(recovery_location_code, 6, 9),
      rllocn = str_sub(recovery_location_code, 10, 16),
      rlsubl = str_sub(recovery_location_code, 17, 19),
      f_type = case_when(
        between(fishery, 10, 19) ~ "troll",
        between(fishery, 20, 39) ~ "net",
        between(fishery, 40, 49) ~ "sport",
        between(fishery, 50, 59) ~ "escp"
      )
    )
  ,
  readRDS(fp$rmis_rel) |> select(-contains("n_code")),
  by = c("tag_code" = "tag_code_or_release_id")
  ) |> #saveRDS(file.path(dir_proj, "rmis_coho_rec_rel_86_2020.rds"))

```

```{r rmis_rr}
#primary dataset, constructed and preserved in chunks above
rmis_rr <- readRDS(fp$rmis_rec_rel) |> 
  filter(
    sample_type != 5,
    !is.na(release_location_state)
    ) |>  #drop 3 recent
  mutate(age = run_year - brood_year) |> 
  rowid_to_column("uid")

#adding missing Canadian escapements
rmis_rr <- bind_rows(
  rmis_rr,
  readxl::read_xlsx(
    file.path(dir_proj, "ERAnalysis/2022-02-23 StAD Escapement Report_Coho_EPAD.xlsx"),
    sheet = "Obs-Est-Exp"
    ) |>
    rowid_to_column(var = "uid") |> 
    mutate(
      uid = uid + last(rmis_rr$uid),
      age = `Recovery Year` - `Brood Year`,
      fishery = 50,
      f_type = "escp"
    ) |> 
    select(
      uid,
      tag_code = Tagcode, 
      recovery_location_code = `PSC Location Code`,
      recovery_location_name = `Recovery Site Name`,
      run_year = `Recovery Year`,
      brood_year = `Brood Year`,
      age,
      fishery, f_type,
      estimated_number = `Final Expanded`
    ) |> 
    filter(
      tag_code %in% unique(rmis_rr$tag_code),
      age == 3
    ) 
  )


#add CCT mapped StockIDs
rmis_rr <- rmis_rr |> left_join(lu$cwt_stk, by = c("tag_code"))

#add AHB mapped FisheryIDs
#cannot directly join on 'PSC_Code'...have to use the Num_Chars field
#but that means using many possible lengths of recovery_location_code
#brute force iterator over Num_chars + uid to allow recombination

#first declare temp object of only key fields
rmis_rr_ahb_map <- rmis_rr |> 
  select(uid, recovery_location_code, fishery) |> 
  mutate(fishery_single = floor(fishery/10)) 
#now overwrite as split-then-bind pattern on Num_Chars
#per AHB request, added explicit right string padding to specified string length
#even when actual strings in RMIS and LU are/use fewer char
rmis_rr_ahb_map <- map_df(
  sort(unique(lu$ahb_fishmap$Num_Chars)),
  ~inner_join(
    rmis_rr_ahb_map |> 
      mutate(PSC_Code = str_sub(recovery_location_code, 1, .x) |> str_pad(width = .x, side = "right"))
    ,
    lu$ahb_fishmap |> filter(Num_Chars == .x) |> 
      mutate(PSC_Code = str_pad(PSC_Code, width = .x, side = "right"))
    ,
    by = c("PSC_Code", "fishery_single")
  )
)

#some cases of same fishery from different n-chars being considered on same recovery_location_code
#some cases initially from simple row duplication in lookup, now fixed on read-in
overmapped <- rmis_rr_ahb_map |> count(uid) |> filter(n>1) |> select(uid)

#now rejoin to full dataset, after making FisheryID distinct per UID
rmis_rr <- left_join(
  rmis_rr, 
  #split out multiple-mapped, make distinct per UID and rebind
  bind_rows(
    anti_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
      select(uid, FisheryID)
    ,
    semi_join(rmis_rr_ahb_map, overmapped, by = "uid") |> 
      group_by(uid) |> 
      slice_max(Num_Chars, n = 1, with_ties = F) |> 
      ungroup() |> 
      select(uid, FisheryID) #|> count(uid) |> filter(n>1)
  )
  ,
  by = "uid") |> 
  left_join(fram$fishery, by = "FisheryID")

rm(rmis_rr_ahb_map, overmapped)

#split Ocean troll into treaty/non-treaty
rmis_rr <- rmis_rr |> 
  mutate(
    FisheryID = if_else(FisheryID %in% c(35, 38, 42) & fishery==15, FisheryID+1, FisheryID),
    FisheryName = if_else(FisheryID==36, "Area2TrlTR", FisheryName),
    FisheryName = if_else(FisheryID==39, "Area3TrlTR", FisheryName),
    FisheryName = if_else(FisheryID==43, "A4/4BTrlTR", FisheryName)
  ) 

# rmis_rr |> filter(FisheryID %in% c(35, 36, 38, 39, 42, 43)) |> distinct(FisheryID, FisheryName, fishery, gear)
```

# Exploitation calculations

```{r er_objects_included_fisheries}

samp_catch_coef_vals <- samp_catch_coef |>
  filter(Source == "Xpansion", (Action != "Remove  fishery" | is.na(Action))) |>
  select(FisheryID, `2010`:`2019`) |> 
  pivot_longer(cols = -FisheryID, names_to = "run_year", values_to = "coef") |> 
  mutate(run_year = as.numeric(run_year))


er_fram <- full_join(
  fram$mort |>
    mutate(
      run_year = as.integer(RunYear), RunYear = NULL,
      FisheryID = if_else(FisheryID %in% fishery_ids_paired, FisheryID+1, as.double(FisheryID)),
      FisheryName = if_else(FisheryID %in% c(fishery_ids_paired, fishery_ids_paired+1),
                            str_sub(FisheryName, 1,8), FisheryName),
      FisheryID = if_else(FisheryID == 98, 97, as.double(FisheryID)),
      FisheryName = if_else(FisheryID == 97, "A7BCDNet", FisheryName)
    ) |> 
    filter(FisheryID %in% fishery_ids) |> 
    group_by(run_year, StockID, StockLongName, FisheryID, FisheryName) |> 
    summarise(
      across(c(LandedCatch, MSFLandedCatch), sum), #sum over timesteps
      fram_lnd_yr_fsh = LandedCatch + MSFLandedCatch,
      .groups = "drop") |> 
    ##excluding fishery-year levels for still-included fisheries
    ##resulting ERs for a stock then vary between years in terms of which fisheries contribute
    ##but should parallel RMIS
    #     anti_join(
    #       samp_catch_coef_vals |> filter(coef == 0),
    #       by = c("FisheryID", "run_year")
    #     ) |> 
    left_join(
      samp_catch_coef_vals |> filter(coef == 0),
      by = c("FisheryID", "run_year")
    ) |> 
    mutate(fram_lnd_yr_fsh = if_else(!is.na(coef), coef * fram_lnd_yr_fsh, fram_lnd_yr_fsh)) |> 
    group_by(run_year, StockID, StockLongName) |> 
    mutate(
      LandedCatch = NULL, MSFLandedCatch = NULL,
      fram_lnd_yr_tot = sum(fram_lnd_yr_fsh)
    ) |> 
    ungroup()
  ,
  fram$escp |> 
    rename(fram_escp = escp) |> 
    mutate(run_year = as.integer(RunYear), RunYear = NULL) |> 
    group_by(run_year, StockID) |> 
    summarise(across(fram_escp, sum), .groups = "drop") 
  ,
  by = c("run_year", "StockID")
) |>
  mutate(
    fram_abnd = fram_lnd_yr_tot + fram_escp,
    fram_er_fsh = fram_lnd_yr_fsh / fram_abnd,
    fram_er_tot = fram_lnd_yr_tot / fram_abnd
  ) |> 
  select(run_year, everything()) |> 
  filter(between(run_year, 2010, 2019))


er_rmis <- full_join(
  #analogous to FRAM mortality table
  rmis_rr |> 
    drop_na(estimated_number, StockID) |>
    mutate(
      FisheryID = if_else(FisheryID %in% fishery_ids_paired, FisheryID+1, as.double(FisheryID)),
      FisheryName = if_else(FisheryID %in% c(fishery_ids_paired, fishery_ids_paired+1),
                            str_sub(FisheryName, 1,8), FisheryName),
      FisheryID = if_else(FisheryID == 98, 97, as.double(FisheryID)),
      FisheryName = if_else(FisheryID == 97, "A7BCDNet", FisheryName)
    ) |> 
    filter(
      age == 3, f_type != "escp",
      between(run_year, min(er_fram$run_year), max(er_fram$run_year)),
      StockID %in% stock_ids,
      FisheryID %in% fishery_ids
    ) |> #count(sample_type)
    group_by(run_year, StockID, f_type, FisheryID, FisheryName) |> 
    summarise(rmis_est_num_yr_fsh = sum(estimated_number), .groups = "drop") |> 
    left_join(
      samp_catch_coef_vals, 
      by = c("FisheryID", "run_year")
    ) |>
    mutate(rmis_est_num_yr_fsh = if_else(!is.na(coef), rmis_est_num_yr_fsh * coef, rmis_est_num_yr_fsh)) |> 
    group_by(run_year, StockID) |> 
    mutate(rmis_est_num_yr_tot = sum(rmis_est_num_yr_fsh)) |> 
    ungroup()
  ,
  #analogous to FRAM escapement table
  rmis_rr |> 
    drop_na(estimated_number, StockID) |> 
    filter(
      age == 3, f_type == "escp",
      between(run_year, min(er_fram$run_year), max(er_fram$run_year)),
      StockID %in% stock_ids
    ) |> 
    group_by(run_year, StockID) |> 
    summarise(rmis_escp = sum(estimated_number), .groups = "drop")
  ,
  by = c("run_year", "StockID")
  ) |> 
  mutate(
    run_year = as.integer(run_year),
    rmis_abnd = rmis_est_num_yr_tot + rmis_escp,
    rmis_er_fsh = rmis_est_num_yr_fsh / rmis_abnd,
    rmis_er_tot = rmis_est_num_yr_tot / rmis_abnd
  )


er_fram_rmis <- full_join(
  er_fram |> select(-StockLongName, -FisheryName, -coef),
  er_rmis |> select(-FisheryName, -coef),
  by = c("run_year", "StockID", "FisheryID")
) |> 
  left_join(fram$mort |> distinct(StockID, StockLongName), by = "StockID") |> 
  left_join(fram$mort |> distinct(FisheryID, FisheryName), by = "FisheryID") |> 
  mutate(
    fidnm = paste(FisheryID, FisheryName, sep = ":") |> fct_reorder(.x = FisheryID, .fun = min),
    sidnm = paste(StockID, StockLongName, sep = ":") |> fct_reorder(.x = StockID, .fun = min),
    d_yr_fsh = fram_lnd_yr_fsh - rmis_est_num_yr_fsh,
    d_yr_tot = fram_lnd_yr_tot - rmis_est_num_yr_tot,
    d_escp_fram_rmis = fram_escp - rmis_escp,
    d_er_fsh = fram_er_fsh - rmis_er_fsh,
    d_er_tot = fram_er_tot - rmis_er_tot
    ) |> 
  filter(between(run_year, 2010, 2019))

```


# Results

## Annual and mean total marine pseudo-ERs by stock 

```{r gt_total_er_annual}
er_fram_rmis |> 
  drop_na(d_er_tot) |>
  group_by(sidnm) |> 
  distinct(sidnm, run_year, fram_er_tot, rmis_er_tot, d_er_tot) |> #arrange(sidnm) |> print(n=50)
  ungroup() |>
  gt(groupname_col = "sidnm", rowname_col = "run_year") |> 
  summary_rows(groups = T, fns = "mean", formatter = fmt_percent, decimals = 1) |> 
  fmt_percent(contains("_er"), decimals = 1) |> 
  tab_style(
    style = list(cell_fill(color = "purple", alpha = 0.5)),
    locations = cells_body(rows = d_er_tot < -0.05)) |> 
  tab_style(
    style = list(cell_fill(color = "orange", alpha = 0.5)),
    locations = cells_body(rows = d_er_tot > 0.05)) |> 
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_summary()
  )
```

Same values as a plot...

```{r gg_total_er_annual}
er_fram_rmis |> 
  drop_na(d_er_tot) |>
  group_by(sidnm) |> 
  distinct(sidnm, run_year, fram_er_tot, rmis_er_tot, d_er_tot) |> 
  ungroup() |>
  mutate(
    run_year = as.character(run_year),
    shp = case_when(
      d_er_tot > 0 ~ "FRAM > RMIS",
      d_er_tot < 0 ~ "FRAM < RMIS",
      d_er_tot == 0 ~ "FRAM = RMIS"
    ),
    sze = if_else(!is.na(d_er_tot), abs(d_er_tot), 0)
  ) |> 
  ggplot(aes(run_year, fct_rev(sidnm))) +
  geom_point(aes(shape = shp), size = 2) +
  geom_point(aes(shape = shp, size = sze, fill = d_er_tot)) +
  geom_text(aes(label = paste0(round(100*d_er_tot, digits = 0), "%")), nudge_y = 0.3) +
  scale_shape_manual(name = "", values = c("FRAM > RMIS" = 24, "FRAM < RMIS" = 25, "FRAM = RMIS" = 22, "FRAM-only" = 20, "RMIS-only" = 3)) +
  scale_size("ER diff. abs.", range = c(1, 10)) +
  scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2)) +
  guides(
    #size = guide_bins(range = c(2.5, 10)),
    fill = guide_colorbar(title="ER difference"),
    x = guide_axis("Run Year"),
    y = guide_axis("")) +
  labs(
    title = "Differences in annual total pre-terminal pseudo-ER", subtitle = "FRAM - RMIS"
  )

```

## Annual and mean fishery-specific marine pseudo-ERs per stock

```{r gg_dif}
min_fram_landed = 10

gg_dif <- map(
  set_names(levels(er_fram_rmis$sidnm)),
  function(s) {
    d <- er_fram_rmis |>
      filter(
        sidnm == s,
        fram_lnd_yr_fsh >= min_fram_landed
        #,run_year %in% c(2010:2014, 2017:2019)
      ) |> mutate(run_year = as.character(run_year))
    bind_rows(
      d,
      d |> group_by(sidnm, fidnm) |> 
        summarise(
          run_year = "mean error",
          d_er_fsh = mean(d_er_fsh, na.rm=T), .groups = "drop"),
      d |> group_by(sidnm, run_year) |> 
        summarise(
          fidnm = "0: annual mean error",
          d_er_fsh = mean(d_er_fsh, na.rm=T), .groups = "drop")
    ) |> 
      mutate(
        fidnm = factor(fidnm, levels = c(levels(er_fram_rmis$fidnm), "0: annual mean error")),
        shp = case_when(
          d_er_fsh > 0 ~ "FRAM > RMIS",
          d_er_fsh < 0 ~ "FRAM < RMIS",
          d_er_fsh == 0 ~ "FRAM = RMIS",
          is.na(rmis_er_fsh) ~ "FRAM-only",
          is.na(fram_er_fsh) ~ "RMIS-only"
        ),
        sze = if_else(!is.na(d_er_fsh), abs(d_er_fsh), 0)
      ) |> 
      ggplot(aes(run_year, fidnm)) +
      geom_point(aes(shape = shp), size = 2) +
      geom_point(aes(shape = shp, size = sze, fill = d_er_fsh)) +
      geom_text(aes(label = if_else(is.na(d_er_fsh), "", paste0(round(100*d_er_fsh, digits = 0), "%"))), nudge_y = 0.6) +
      scale_shape_manual(name = "", values = c("FRAM > RMIS" = 24, "FRAM < RMIS" = 25, "FRAM = RMIS" = 22, "FRAM-only" = 20, "RMIS-only" = 3)) +
      scale_size("ER diff. abs.", range = c(2.5, 10)) +
      scale_fill_fermenter(type = "div", palette = "PuOr", breaks = c(-0.1, -0.05, 0, 0.05, 0.1), limits = c(-.2, .2)) +
      guides(
        fill = guide_colorbar(title="ER difference"),
        x = guide_axis("Run Year"),
        y = guide_axis("")) +
      facet_wrap(~sidnm, ncol = 2, scales = "free_y") +
      labs(
        title = "Differences in annual per-fishery pseudo-ER, FRAM - RMIS",
        subtitle = paste("Minimum annual landed catch in FRAM >=", min_fram_landed, "coho")
      )
  }
)


# pwalk(
#   list(paste0("gg_dif_", str_remove_all(names(gg_dif), "\\:| "), ".png"), gg_dif),
#   ggsave, path = dir_proj
# ) 

```

## Annual fishery impacts relative rank disagreement

Per stock year, calculate the proportion of total, either landed catch (FRAM) or estimated number 

```{r er_fram_rmis_rnk}
er_fram_rmis_rnk <- er_fram_rmis |> 
  filter(fram_lnd_yr_fsh > 0) |> 
  group_by(sidnm, run_year) |> 
  mutate(
    fram_fsh_tot = fram_lnd_yr_fsh / fram_lnd_yr_tot,
    rmis_fsh_tot = rmis_est_num_yr_fsh / rmis_est_num_yr_tot,
    across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.))),
    d_rnk = abs(fram_fsh_tot_rnk - rmis_fsh_tot_rnk)
    ) |> 
  arrange(sidnm, run_year, fram_fsh_tot_rnk)

er_fram_rmis_rnk |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), d_rnk) |> 
  filter(fram_fsh_tot_rnk <= 5) 
```

Illustrating "top 5 alignment": per stock, of the FRAM fisheries with the 5 largest catches in a year, how many of those fisheries were also in the RMIS top 5 of summed recoveries?

Note however that this is quite "fuzzy" or loose, insofar as FRAM 1:5 could be RMIS 5:1 and still score "5".

```{r gt_fsh_rnk_rmis5_in_fram5}
#leaving for now, but this tab_style() approach is probably superseded by data_color() method below in the (better) weighted rank diffs table
er_fram_rmis_rnk |> 
  filter(fram_fsh_tot_rnk <= 5) |> 
  summarise(in5 = sum(rmis_fsh_tot_rnk %in% 1:5, na.rm = T), .groups = "drop") |> 
  pivot_wider(names_from = run_year, values_from = in5) |> 
  gt(caption = "Fishery relative rank correspondence: RMIS top 5 in FRAM top 5") |> 
  tab_style(
    style = cell_fill("grey30", 0.5),
    locations = list(cells_body(columns = c(`2015`, `2016`)))
  ) |> 
  tab_style(
    style = cell_fill("forestgreen", 0.5),
    locations = list(
      cells_body(columns = `2019`, rows = `2019`==5),
      cells_body(columns = `2018`, rows = `2018`==5),
      cells_body(columns = `2017`, rows = `2017`==5),
      
      cells_body(columns = `2014`, rows = `2014`==5),
      cells_body(columns = `2013`, rows = `2013`==5),
      cells_body(columns = `2012`, rows = `2012`==5),
      cells_body(columns = `2011`, rows = `2011`==5),
      cells_body(columns = `2010`, rows = `2010`==5)
    )
  ) |> 
  tab_style(
    style = cell_fill("forestgreen", 0.2),
    locations = list(
      cells_body(columns = `2019`, rows = `2019`==4),
      cells_body(columns = `2018`, rows = `2018`==4),
      cells_body(columns = `2017`, rows = `2017`==4),
      
      cells_body(columns = `2014`, rows = `2014`==4),
      cells_body(columns = `2013`, rows = `2013`==4),
      cells_body(columns = `2012`, rows = `2012`==4),
      cells_body(columns = `2011`, rows = `2011`==4),
      cells_body(columns = `2010`, rows = `2010`==4)
    )
  ) |> 
  tab_style(
    style = cell_fill("orange", 0.5),
    locations = list(
      cells_body(columns = `2019`, rows = `2019`<=2),
      cells_body(columns = `2018`, rows = `2018`<=2),
      cells_body(columns = `2017`, rows = `2017`<=2),
      
      cells_body(columns = `2014`, rows = `2014`<=2),
      cells_body(columns = `2013`, rows = `2013`<=2),
      cells_body(columns = `2012`, rows = `2012`<=2),
      cells_body(columns = `2011`, rows = `2011`<=2),
      cells_body(columns = `2010`, rows = `2010`<=2)
    )
  )

```

Moving to a conceptually related but tighter rank-specific comparison based on the (weighted) difference in ranks, with weights increasing the importance of divergence in larger fisheries. 

```{r gt_fsh_rnk_weighted_diff}
er_fram_rmis_rnk |>
  filter(fram_fsh_tot_rnk <= 10, fram_lnd_yr_fsh > 5) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), d_rnk) |> 
  filter(str_detect(sidnm, "20"), run_year==2016)

er_fram_rmis_rnk |> 
  filter(rmis_fsh_tot_rnk <= 3) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), d_rnk)

#illustrating a couple of options to compare stock-years in terms of rank (dis)agreement
#weighting the difference in ranks by the inverse of
# - the sum of FRAM and RMIS relative ranks of catch/recoveries
# - the RMIS rank
#the second alt better highlights cases such as 20:Skag in 115:8-2 Spt
#which seems to be consistently underestimated in FRAM

er_fram_rmis_rnk |> 
  mutate(
    d_rnk_sum_wt = d_rnk * (1/(fram_fsh_tot_rnk+rmis_fsh_tot_rnk)),
    d_rnk_rmis_wt = d_rnk * (1/(1+rmis_fsh_tot_rnk))
  ) |> 
  filter(rmis_fsh_tot_rnk <= 3) |> 
  group_by(sidnm, run_year) |> 
  mutate(
    d_rnk_sum_wt_tot = sum(d_rnk_sum_wt),
    d_rnk_rmis_wt_tot = sum(d_rnk_rmis_wt)
  ) |> 
  select(run_year, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("d_rnk"))

er_fram_rmis_rnk |> 
  mutate(d_rnk_rmis_wt = d_rnk * (1/(1+rmis_fsh_tot_rnk))) |> 
  filter(rmis_fsh_tot_rnk <= 5) |> 
  group_by(sidnm, run_year) |> 
  summarise(d_rnk_rmis_wt_tot = sum(d_rnk_rmis_wt), .groups = "drop") |> 
  pivot_wider(names_from = run_year, values_from = d_rnk_rmis_wt_tot) |> 
  gt(caption = "Fishery relative rank disagreement: weighted rank differences for RMIS fisheries with largest annual est_num") |> 
  fmt_number(columns = -sidnm) |> 
  data_color(
    columns = c(`2010`:`2014`, `2017`:`2019`), 
    colors = scales::col_bin(
      palette = c("forestgreen", "orange", "red"), domain = c(0, Inf), bins = c(0,0.1,2,3,4,5,Inf)
    )) |> 
  tab_style(
    style = cell_fill("grey30", 0.5),
    locations = list(cells_body(columns = c(`2015`, `2016`)))
  ) 

```


## Stock specific QAQC/exploration

```{r current_wa_escp}
escp <- readxl::read_excel("T:/DFW-Salmon Mgmt Modeling Team - General/Escapement files/Coho/fram_coho_escapement_2022.xlsx", sheet = "dataset") |> 
  select(StockID, StockLongName, year, escp_val, escp_val_data_source)
```


```{r willapa_164}
gg_dif$`164:Willapa Bay Hatchery Marked`

#Willapa in 2017; considerably more proportional escapement in FRAM
er_fram_rmis |> filter(StockID==164, FisheryID==47, run_year==2017)
er_fram |> filter(StockID==164, FisheryID==47)
er_rmis |> filter(StockID==164, FisheryID==47)
#escapement compilation values match BackwardsFRAM targets in 2019 & 2020, but 2017 and 2018 look quite off
#but allowing for diffs between BkFRAM targets and forward escapement values...
#...escapement in DB are still not close in recent years to current escapement compilation values
#does not appear to be related to UM nats in 161
#maybe TargetFlag==2 using preseason mark rate is screwing things up somehow?
#but the 2019 Escapement of 885 on target of 23995 seems like some sort of error?
#possibly somehow a function of the included stocks?
bind_rows(
  escp |> filter(StockID %in% c(164)) |> pivot_wider(values_from = escp_val, names_from = year),
  er_fram |> filter(StockID==164) |> distinct(StockID, run_year, fram_escp) |> pivot_wider(values_from = fram_escp, names_from = run_year)
  )
fram$mort |> filter(StockID==164, RunYear==2019) |> group_by(StockID, RunYear, FisheryID) |> summarise(lc = sum(LandedCatch) + sum(MSFLandedCatch)) |>  arrange(desc(lc))

#confirmed with AHB that TargetFlag 2 in 2019 seems to have assigned almost all 23995 to stock 163 Hat UM

```

```{r quill_134}
gg_dif$`134:Quillayute River Fall Hatchery Marked`

#focusing on 2018 as a recent year with larger diffs
#uniformly negative suggests potential RMIS escapement missing
#but a few instances where RMIS estnum actually greater than FRAM lc
er_fram_rmis |>
  filter(StockID==134, run_year == 2018, fram_lnd_yr_fsh > 0) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, fram_lnd_yr_fsh, rmis_est_num_yr_fsh, fram_er_fsh, rmis_er_fsh, d_er_fsh) |> 
  arrange(desc(rmis_est_num_yr_fsh)) |> #print(n=50)
#pretty good congruence in relative distribution of preterm
er_fram_rmis |>
  filter(StockID==134, run_year == 2018, fram_lnd_yr_fsh > 0) |> 
  mutate(
    fram_fsh_tot = fram_lnd_yr_fsh / fram_lnd_yr_tot,
    rmis_fsh_tot = rmis_est_num_yr_fsh / rmis_est_num_yr_tot,
    across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.)))
    ) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot")) |> 
  arrange(fram_fsh_tot_rnk)

#missing escapement in RMIS?
#FRAM escp 10x lc tot, RMIS estnum ~4x escp...
er_fram_rmis |>
  filter(StockID==134, run_year == 2018, fram_lnd_yr_fsh > 0) |> 
select(run_year, StockID, FisheryID, sidnm, fidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)

```

```{r queets_142}
gg_dif$`142:Queets River Fall Hatchery Marked`

#looks quite good outside of A1 & A2 in 2015
#big difference in 175:SW VI Trl with FRAM placing most impacts but RMIS no recs

er_fram_rmis_rnk |>
  filter(StockID==142, run_year == 2014) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk) 

#looks pretty decent, shared top 2 (A2 and A1)
#and FRAM generally overcompensating 
er_fram_rmis_rnk |>
  filter(StockID==142, run_year == 2018) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk) |> print(n=20)


```

```{r quin_148}

```


```{r skagit_20}
gg_dif$`20:Skagit River Hatchery Marked`

er_fram |> filter(StockID==20, FisheryID==107)
er_rmis |> filter(StockID==20, FisheryID==107)

#current escapement vals appear relatively close to those in validation DB
bind_rows(
  escp |> filter(StockID %in% c(20)) |> pivot_wider(values_from = escp_val, names_from = year),
  er_fram |> filter(StockID==20) |> distinct(StockID, run_year, fram_escp) |> pivot_wider(values_from = fram_escp, names_from = run_year)
  )

#interesting to note?
fram$mort |> filter(StockID==20, RunYear==2019) |> 
  group_by(StockID, RunYear, FisheryID, FisheryName) |> summarise(lc = sum(LandedCatch)+sum(MSFLandedCatch)) |>  arrange(desc(lc))
fram$mort |> filter(StockID==20, RunYear==2019, FisheryID %in% fishery_ids_ps_spt) |> 
  group_by(StockID, RunYear, FisheryID, FisheryName) |> summarise(lc = sum(LandedCatch)+sum(MSFLandedCatch)) |>  arrange(desc(lc))

#re: "Do countervailing fishery ER errors compensate to generate comparable total ERs?"
er_fram_rmis |>
  filter(StockID==20, FisheryID %in% fishery_ids_ps_spt, run_year == 2019) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, fram_lnd_yr_fsh, rmis_est_num_yr_fsh, fram_er_fsh, rmis_er_fsh, d_er_fsh) |> 
  arrange(desc(fram_lnd_yr_fsh)) |> 
#FRAM assigns appreciable mort in A7 & 8-1 despite no recs
#but the sum of the ERs from these "rmis missing" impacts 
#still less than the "underestimated" diffs in fishery ERs for the largest A10, A5, A9
#since all FRAM ERs for PS sport are lower than RMIS where both exist
  group_by(is.na(rmis_er_fsh)) |> summarise(across(contains("er_fsh"), ~sum(., na.rm = T)), .groups = "drop")

#see also later work with ranks showing FRAM seeming to consistently miss 8-2 impacts relative to RMIS
#and/but possibly an accounting issue with 8-1; looks like overassigment in 81 > missing/underassigned in 82
er_fram_rmis_rnk |> filter(StockID==20, FisheryID %in% c(106,115)) |> 
  select(run_year, sidnm, fidnm, fram_lnd_yr_fsh, rmis_est_num_yr_fsh) |> 
  group_by(sidnm, run_year) |> summarise(across(ends_with("_fsh"), ~sum(., na.rm = T)))

#but relative ranking of fisheries by impact is congruent, excepting perhaps A9
er_fram_rmis |>
  filter(StockID==20, FisheryID %in% fishery_ids_ps_spt, run_year == 2019) |> 
  mutate(
    fram_fsh_tot = fram_lnd_yr_fsh / fram_lnd_yr_tot,
    rmis_fsh_tot = rmis_est_num_yr_fsh / rmis_est_num_yr_tot,
    across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.)))
    ) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot")) |> 
  arrange(fram_fsh_tot_rnk)

#and again looks as though RMIS escp is plausibly low:
#in 2019 summed estnum of escp less than all fisheries
#vs FRAM escp more than double summed lc
#possibly also better sampling in A9 than many other fisheries
#affecting proportional representation of recoveries?
er_fram_rmis |>
  filter(StockID==20, FisheryID ==107, run_year == 2019) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, fram_lnd_yr_tot, fram_escp, rmis_est_num_yr_tot, rmis_escp)

```

```{r george_58}
gg_dif$`58:George Adams Hatchery Marked`

#looks like in-river and near-terminal net is still included and clearly driving diffs

#orders of magnitude diff in treaty net for 12/12B, 9/9A, 12CD
#with SkokRNet also highly skewed
er_fram_rmis |>
  filter(StockID==58, between(FisheryID, 152, 161), run_year == 2017) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, fram_lnd_yr_fsh, rmis_est_num_yr_fsh, fram_er_fsh, rmis_er_fsh, d_er_fsh)
#just not effectively sampled?

#for the 4 PS spt in both datasets
#same relative ranks for A10 > A12 > A9
#but (!) RMIS has most recs in A5 while FRAM assigns A5 least impact
#monitoring/sampling likely at play, as well as perhaps marking
#but perhaps warrants further discussion? 
er_fram_rmis |>
  filter(StockID==58, FisheryID %in% fishery_ids_ps_spt, run_year == 2017) |> 
  mutate(
    fram_fsh_tot = fram_lnd_yr_fsh / fram_lnd_yr_tot,
    rmis_fsh_tot = rmis_est_num_yr_fsh / rmis_est_num_yr_tot,
    across(ends_with("_fsh_tot"), list(rnk = ~min_rank(-.)))
    ) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot")) |> 
  arrange(fram_fsh_tot_rnk)

```

```{r green_96}
gg_dif$`96:Green River Hatchery Marked`

#big diffs in 2017 and 2011
er_fram_rmis_rnk |>
  filter(StockID==96, run_year == 2017) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk) # |> filter(FisheryID %in% fishery_ids_ps_spt)

#why so large est_num in BC JDF Spt in 2017? More than A10!
rmis_rr |> filter(StockID==96, FisheryID==189) |> 
  #count(run_year) #only 2 recs, actually fewest since 2008, must be expansion?
  filter(run_year == 2017) |> select(uid:recorded_mark, age:FisheryName) #nope...not the val in RMIS 
#looks due to the AHB unsampled catch expansion coef 10.6...
#which also accounts for the big diff in 2011
samp_catch_coef_vals |> filter(FisheryID==189)

#large coef not necessarily at play in local near-terminal net...
samp_catch_coef_vals |> filter(FisheryID==122)
samp_catch_coef_vals |> filter(FisheryID==120)
#...when no recs/0 est_num for coef to act on 
rmis_rr |> filter(StockID==96, FisheryID %in% c(120), run_year == 2012) |> select(uid:recorded_mark, age:FisheryName)

#in 2018 the overall agreement is decent
#both sources put most impacts in A10 spt
#with all RMIS top 5 in FRAM top 5
er_fram_rmis_rnk |>
  filter(StockID==96, run_year == 2018) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk) |> 
#FRAM lower ERs in A10 and A9 not fully compensated by higher in A5, A6, A7, A11 etc.
  filter(FisheryID %in% fishery_ids_ps_spt) |> 
  summarise(across(contains("er_fsh"), ~sum(., na.rm = T)), .groups = "drop")

#similar in 2019: both rank A10 spt highest
#but FRAM lower ERs in A10 and A9 not compensated
#and overall FRAM is short ~5.5% for PS sport
er_fram_rmis_rnk |>
  filter(StockID==96, run_year == 2019) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk) |> 
  filter(FisheryID %in% fishery_ids_ps_spt) |> 
  summarise(across(contains("er_fsh"), ~sum(., na.rm = T)), .groups = "drop")

```


```{r colearly_166}
gg_dif$`166:Columbia River Early Hatchery Marked`

#pretty decent alignment in relative ranks
#shared top 5 and both have A1/Ast and Buoy10 and Newport Spt as top 3, though not matching order
#but FRAM fairly lower in fishery ERs especially for Buoy10
er_fram_rmis_rnk |>
  filter(StockID==166, run_year == 2018) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk)

#unclear whether recent lower FRAM total ER are escapement related or other factor
er_fram_rmis_rnk |> ungroup() |> filter(StockID==166, !is.na(rmis_er_fsh)) |> distinct(run_year, fram_er_tot, rmis_er_tot)
#greater FRAM ERs for some fisheries (e.g. A3 and A4 spt) suggest not necessarily just escapement... 

```

```{r uprfrsr_230}
gg_dif$`230:Upper Fraser River Hatchery Marked`

#2011 and 2017 affected by the same AHB RMIS samp_catch_coef issue as Green
#otherwise fishery ER picture looks pretty okay
#maybe better than would be expected from mean diffs

#in 2018, both see most impact in A5, but FRAM considerably (proportionally) lower fishery ER at 2.9 vs 7.5% RMIS
#RMIS top 5 in FRAM top 10 but FRAM including several fisheries with no recs
#wonder how variation in sampling intensity is affecting
#given relatively rare and thereby fairly low est_num
er_fram_rmis_rnk |>
  filter(StockID==230, run_year == 2018) |> 
  select(run_year, StockID, FisheryID, sidnm, fidnm, ends_with("_fsh"), contains("_fsh_tot"), contains("_rnk")) |> 
  arrange(fram_fsh_tot_rnk) 

#note that the tags getting assigned to 230 do actually seem to show up in WA Ocn spt
rmis_rr |> filter(FisheryID == 37, StockID == 230) |> count(run_year)
rmis_rr |> filter(FisheryID == 33, StockID == 230) |> count(run_year)

```


